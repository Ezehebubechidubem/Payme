<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payme — Create Account</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f8; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; }
    .form-container { background:#fff; padding:24px; border-radius:12px; width:340px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
    h2 { text-align:center; margin-bottom:18px; color:#333; }
    label{ display:block; font-weight:700; margin-bottom:6px; color:#444; font-size:13px }
    input{ width:100%; padding:10px; margin-bottom:14px; border:1px solid #ddd; border-radius:8px; font-size:14px }
    button{ width:100%; background:#00c853; color:#fff; padding:12px; border:0; border-radius:8px; font-weight:700; cursor:pointer }
    .small{ font-size:13px; color:#666; text-align:center; margin-top:12px }
    .modal-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:999 }
    .modal-overlay.show{ display:flex }
    .modal{ background:#fff; padding:18px; border-radius:10px; width:90%; max-width:420px; text-align:center; box-shadow:0 18px 40px rgba(0,0,0,0.12) }
    .badge{ width:60px; height:60px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; color:#fff; font-size:28px; margin-bottom:10px }
    .badge.success{ background:linear-gradient(135deg,#00c853,#43a047) }
    .badge.error{ background:linear-gradient(135deg,#f44336,#e53935) }
    .actions{ margin-top:12px; display:flex; justify-content:center }
    .btn{ padding:10px 14px; border-radius:8px; font-weight:700; border:0; cursor:pointer }
    .btn-primary{ background:#00c853; color:#fff }
  </style>
</head>
<body>
  <div class="form-container" role="main">
    <h2>Create Account</h2>
    <form id="registerForm" autocomplete="on" novalidate>
      <label for="username">Username</label>
      <input id="username" name="username" type="text" placeholder="Enter username" required>

      <label for="phone">Phone Number</label>
      <input id="phone" name="phone" type="text" inputmode="numeric" pattern="\d{11}" 
        maxlength="11"
        placeholder="08012345678" required>

      <label for="password">Password</label>
      <input id="password" name="password" type="password" minlength="10" maxlength="15" placeholder="Choose a password" required>

      <button type="submit" id="submitBtn">Register</button>
      
    </form>
  </div>

  <!-- Success modal -->
  <div id="successModal" class="modal-overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <div class="badge success">✓</div>
      <h3 id="successTitle">Registration successful</h3>
      <p id="successMessage"></p>
      <div class="actions">
        <button id="successOk" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Error modal -->
  <div id="errorModal" class="modal-overlay" aria-hidden="true" role="alertdialog" aria-modal="true">
    <div class="modal" role="document">
      <div class="badge error">✕</div>
      <h3 id="errorTitle">Error</h3>
      <p id="errorMessage"></p>
      <div class="actions">
        <button id="errorOk" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const API_BASE = 'https://payme-update.onrender.com'; // adjust if needed
  const form = document.getElementById('registerForm');
  const usernameEl = document.getElementById('username');
  const phoneEl = document.getElementById('phone');
  const passwordEl = document.getElementById('password');

  const successModal = document.getElementById('successModal');
  const successMessage = document.getElementById('successMessage');
  const successOk = document.getElementById('successOk');

  const errorModal = document.getElementById('errorModal');
  const errorMessage = document.getElementById('errorMessage');
  const errorOk = document.getElementById('errorOk');

  function showSuccess(msg, onOk){
    successMessage.textContent = msg || '';
    successModal.classList.add('show');
    successModal.setAttribute('aria-hidden','false');
    successOk.focus();
    successOk.onclick = () => { successModal.classList.remove('show'); successOk.onclick=null; if (onOk) onOk(); };
  }
  function showError(msg){
    errorMessage.textContent = msg || '';
    errorModal.classList.add('show');
    errorModal.setAttribute('aria-hidden','false');
    errorOk.focus();
    errorOk.onclick = () => { errorModal.classList.remove('show'); errorOk.onclick=null; };
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const username = usernameEl.value.trim();
    const phone = phoneEl.value.trim();
    const password = passwordEl.value;

    if (!/^\d{11}$/.test(phone)) { showError('Phone must be exactly 11 digits'); return; }
    if (!username) { showError('Username is required'); return; }
    if (!password || password.length < 6) { showError('Password must be at least 6 characters'); return; }

    // send register request and include credentials so cookie is saved
    try {
      const res = await fetch(`${API_BASE}/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',              // <<< required: accept Set-Cookie from server
        body: JSON.stringify({ username, phone, password })
      });

      const data = await res.json().catch(()=>({ status:'error', message: 'Invalid server response' }));
      if (res.ok && data.status === 'success') {
        // store safe user info (DO NOT store password)
        const safe = { username, phone, accountNumber: data.account_number };
        localStorage.setItem('user', JSON.stringify(safe));

        showSuccess(`✅ Registered. Account number: ${data.account_number}`, () => {
          // go to PIN creation page (user already has session if cookie saved)
          window.location.href = 'create_pin.html';
        });
      } else {
        showError(data.message || `Registration failed (HTTP ${res.status})`);
      }

    } catch (err) {
      console.error('register error', err);
      showError('Network/server error. Try again later.');
    }
  });

  // allow escape to close modals
  document.addEventListener('keydown', (e)=> {
    if (e.key === 'Escape') { if (successModal.classList.contains('show')) successModal.classList.remove('show'); if (errorModal.classList.contains('show')) errorModal.classList.remove('show'); }
  });

})();
</script>
</body>
</html>