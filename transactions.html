<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recent Transactions</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root{
      --primary:#00c853;
      --success:#2e7d32;
      --pending:#f0ad4e;
      --failed:#d32f2f;
      --muted:#777;
      --bg:#ffffff;
      --card:#ffffff;
      --line:#e9ecef;
      --text:#111;
      --avatar-bg:#e8f5e9;
      --avatar-color:#2e7d32;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height:100vh;
      display:flex;flex-direction:column;
    }
    header{
      display:flex;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line);background:#fff;
      position:sticky;top:0;z-index:10;
    }
    header a.back{color:var(--text);text-decoration:none;margin-right:10px;font-size:18px}
    header h2{flex:1;text-align:center;font-size:16px;margin:0;font-weight:700}
    main{flex:1;overflow:auto;padding:12px}
    .month-group{margin-bottom:18px}
    .month-title{font-size:18px;font-weight:700;margin:6px 4px 12px;color:#222}
    .tx-card{
      background:var(--card);border-radius:12px;padding:12px 14px;margin-bottom:12px;border:1px solid var(--line);
      display:flex;align-items:center;gap:12px;
    }
    .avatar{
      width:52px;height:52px;border-radius:10px;background:var(--avatar-bg);display:grid;place-items:center;
      font-weight:700;color:var(--avatar-color);font-size:18px;flex:0 0 52px;
    }
    .tx-main{flex:1;min-width:0}
    .tx-top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .other-name{font-size:15px;font-weight:700;color:#111;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{font-size:13px;color:var(--muted);margin-top:6px}
    .meta small{display:block;color:var(--muted);font-size:12px;margin-top:6px}
    .tx-amount{font-weight:800;font-size:16px;white-space:nowrap}
    .status{
      font-weight:700;font-size:13px;padding:6px 10px;border-radius:999px;text-transform:lowercase;
      display:inline-block;margin-left:10px;
    }
    .status.success{color:var(--success)}
    .status.pending{color:var(--pending)}
    .status.failed{color:var(--failed)}
    .empty{padding:36px;text-align:center;color:var(--muted)}
    /* small screens tweak */
    @media (max-width:420px){
      .avatar{width:48px;height:48px;font-size:16px}
      .tx-amount{font-size:15px}
    }
  </style>
</head>
<body>
  <header>
    <a class="back" href="javascript:void(0)" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></a>
    <h2>Recent Transactions</h2>
    <div style="width:26px"></div>
  </header>

  <main id="main">
    <div id="loading" class="empty">Loading transactions…</div>
    <div id="content"></div>
  </main>

<script>
  // === CONFIG ===
  const API_BASE = "https://payme-update.onrender.com"; // keep as your backend base
  // === END CONFIG ===

  // get logged user (from your app's storage keys)
  function getStoredUser(){
    try{
      const j = localStorage.getItem("loggedInUser") || localStorage.getItem("user");
      return j ? JSON.parse(j) : null;
    }catch(e){ return null; }
  }

  function goBack(){
    if(document.referrer && document.referrer!=='') window.history.back();
    else window.location.href = "paymelogin.html";
  }

  // parse and format date to "DD/MM/YYYY , HH:MM:SS"
  function formatDateTime(iso){
    if(!iso) return '';
    const d = new Date(iso);
    if(isNaN(d.getTime())) return iso;
    const pad = v => String(v).padStart(2,'0');
    const dd = pad(d.getDate()), mm = pad(d.getMonth()+1), yy = d.getFullYear();
    const hh = pad(d.getHours()), min = pad(d.getMinutes()), ss = pad(d.getSeconds());
    return `${dd}/${mm}/${yy} , ${hh}:${min}:${ss}`;
  }

  // group transactions array by month-year key
  function groupByMonth(transactions){
    const map = new Map();
    for(const tx of transactions){
      let dt = new Date(tx.date);
      if(isNaN(dt.getTime())) dt = new Date(); // fallback
      const key = dt.toLocaleString('en-US', { month: 'long', year: 'numeric' }); // e.g. "December 2025"
      if(!map.has(key)) map.set(key, []);
      map.get(key).push(tx);
    }
    // maintain order by latest month first
    return Array.from(map.entries()).sort((a,b)=>{
      const pa = new Date(a[0]); const pb = new Date(b[0]);
      return pb - pa;
    });
  }

  // determine status (best-effort): prefer tx.status, else look for keywords in type
  function determineStatus(tx){
    if(tx.status) {
      return String(tx.status).toLowerCase();
    }
    const t = (tx.type||'').toLowerCase();
    if(t.includes('fail') || t.includes('failed') || t.includes('error')) return 'failed';
    if(t.includes('pend') || t.includes('pending')) return 'pending';
    // default
    return 'success';
  }

  // friendly currency format (no locale surprises)
  function formatCurrency(n){
    const num = Number(n) || 0;
    // show thousands separators
    return '₦' + num.toLocaleString('en-NG');
  }

  // Caching for lookups to avoid repeated network calls
  const nameCache = new Map(); // key -> {name, avatarUrl?}
  async function lookupNameForOther(other){
    if(!other) return { name: other || '', avatar: null };

    // If cached
    if(nameCache.has(other)) return nameCache.get(other);

    // heuristics: account numbers are 10-digit and start 7/8/9 (per your instruction)
    const digitsOnly = String(other).replace(/\D/g,'');
    try {
      // account number (10 digits starting with 7/8/9)
      if(/^[789]\d{9}$/.test(digitsOnly)){
        const acc = digitsOnly.slice(0,10);
        const url = `${API_BASE}/user_by_account/${encodeURIComponent(acc)}`;
        const res = await fetch(url, { cache:'no-store' });
        if(res.ok){
          const json = await res.json().catch(()=>null);
          if(json && json.status === 'success' && json.username){
            const out = { name: json.username, avatar: null, phone: json.phone || null };
            nameCache.set(other, out);
            return out;
          }
        }
      }

      // else maybe it's a phone (11 digits)
      if(/^\d{11}$/.test(digitsOnly)){
        const phone = digitsOnly;
        const url = `${API_BASE}/user/${encodeURIComponent(phone)}`;
        const res = await fetch(url, { cache:'no-store' });
        if(res.ok){
          const json = await res.json().catch(()=>null);
          // endpoints may return {status:"success", user: {...}}
          if(json && json.status === 'success' && json.user){
            const u = json.user;
            const out = { name: u.username || u.name || phone, avatar: u.avatar || u.picture || null, phone: u.phone || phone };
            nameCache.set(other, out);
            return out;
          }
          // or raw object
          if(json && (json.username || json.name)){
            const out = { name: json.username || json.name, avatar: json.avatar || json.picture || null, phone: json.phone || phone };
            nameCache.set(other, out);
            return out;
          }
        }
      }
    } catch(e){
      // ignore network issues, fallthrough to fallback name
    }

    // fallback: return original string as name
    const fallback = { name: String(other), avatar: null };
    nameCache.set(other, fallback);
    return fallback;
  }

  // Build a visual avatar content (initials or digit)
  function avatarContent(nameOrOther){
    if(!nameOrOther) return '';
    const s = String(nameOrOther).trim();
    // if starts with digit show that digit (like screenshot)
    const m = s.match(/[A-Za-z]/);
    if(!m){
      // show first digit char
      const d = s.match(/\d/);
      return d ? d[0] : s.slice(0,1).toUpperCase();
    }
    // create initials (two letters)
    const parts = s.split(/\s+/).filter(Boolean);
    if(parts.length === 1) return parts[0].slice(0,1).toUpperCase();
    return (parts[0].slice(0,1) + parts[1].slice(0,1)).toUpperCase();
  }

  // Render grouped transactions
  async function renderTransactions(){
    const main = document.getElementById('main');
    const loading = document.getElementById('loading');
    const content = document.getElementById('content');

    const user = getStoredUser();
    if(!user || !user.phone){
      loading.innerText = 'Please login first (no logged user found).';
      return;
    }

    loading.innerText = 'Loading transactions…';
    content.innerHTML = '';

    try {
      const res = await fetch(`${API_BASE}/transactions/${encodeURIComponent(user.phone)}`, { cache:'no-store' });
      if(!res.ok){
        loading.innerText = 'Failed to load transactions (server returned ' + res.status + ')';
        return;
      }
      const arr = await res.json();
      if(!Array.isArray(arr) || arr.length === 0){
        loading.innerText = 'No transactions yet';
        return;
      }

      // Convert raw items to normalized objects and sort descending by date
      const normalized = arr.map(tx => {
        return {
          type: tx.type || '',
          amount: tx.amount || 0,
          other_party: tx.other_party || '',
          date: tx.date || tx.createdAt || tx.created || new Date().toISOString(),
          status: tx.status || tx.state || tx.result || null,
          raw: tx
        };
      }).sort((a,b) => new Date(b.date) - new Date(a.date));

      const grouped = groupByMonth(normalized);

      // Clear loading
      loading.style.display = 'none';

      // For each month group render header and each tx
      for(const [month, txs] of grouped){
        const mg = document.createElement('section');
        mg.className = 'month-group';

        const mt = document.createElement('div');
        mt.className = 'month-title';
        mt.textContent = month;
        mg.appendChild(mt);

        // render each tx
        for(const tx of txs){
          const card = document.createElement('div');
          card.className = 'tx-card';

          const lookup = await lookupNameForOther(tx.other_party); // get name (cached)
          const displayName = lookup.name || tx.other_party || '—';
          const avatarUrl = lookup.avatar || null;
          const avatarText = avatarContent(displayName);

          const av = document.createElement('div');
          av.className = 'avatar';
          if(avatarUrl){
            const img = document.createElement('img');
            img.src = avatarUrl;
            img.alt = displayName;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '10px';
            av.appendChild(img);
          } else {
            av.textContent = avatarText;
          }

          const mainDiv = document.createElement('div');
          mainDiv.className = 'tx-main';

          const top = document.createElement('div');
          top.className = 'tx-top';

          const left = document.createElement('div');
          left.style.minWidth = '0';

          const nameEl = document.createElement('div');
          nameEl.className = 'other-name';
          nameEl.title = displayName;
          nameEl.textContent = displayName;

          const metaEl = document.createElement('div');
          metaEl.className = 'meta';
          // Show account/phone under name (as small text)
          const acctText = tx.other_party || '—';
          metaEl.innerHTML = `${acctText} · ${formatCurrency(tx.amount)}<br><small>${formatDateTime(tx.date)}</small>`;

          left.appendChild(nameEl);
          left.appendChild(metaEl);

          top.appendChild(left);

          const right = document.createElement('div');
          right.style.textAlign = 'right';
          const amountEl = document.createElement('div');
          amountEl.className = 'tx-amount';
          amountEl.textContent = formatCurrency(tx.amount);

          // status label (determine best-effort)
          const st = determineStatus(tx);
          const statusEl = document.createElement('div');
          statusEl.className = `status ${st}`;
          statusEl.textContent = st;

          right.appendChild(amountEl);
          right.appendChild(statusEl);

          top.appendChild(right);
          mainDiv.appendChild(top);

          card.appendChild(av);
          card.appendChild(mainDiv);

          mg.appendChild(card);
        }

        content.appendChild(mg);
      }

    } catch (err) {
      console.error(err);
      loading.innerText = '⚠️ Failed to load transactions (network or server error).';
    }
  }

  // kick off
  window.addEventListener('load', () => {
    renderTransactions();
  });
</script>
</body>
</html>