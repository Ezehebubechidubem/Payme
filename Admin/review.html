<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Payme — Monitoring</title>
<style>
:root{--bg:#fff;--text:#000;--green:#10b981;--muted:#6b7280;--card:#f8fafb}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Arial}
header{padding:18px;border-bottom:1px solid #f0f2f3}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:18px}
.card{background:var(--card);padding:14px;border-radius:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eee}
.muted{color:var(--muted)}
.btn{background:var(--green);color:#fff;padding:8px;border-radius:8px;border:0;cursor:pointer}
</style>
</head>
<body>

<header>
  <a href="index.html" style="color:#6b7280;text-decoration:none">← Dashboard</a>
  <h2 style="margin:6px 0">Monitoring</h2>
  <div class="muted">View daily volume, deposits, withdrawals, active users, fraud attempts, and failed transactions.</div>
</header>

<div class="grid">
  <div class="card">
    <h4>Total Volume (24h)</h4>
    <div id="vol" style="font-size:22px;font-weight:800;margin-top:8px">₦0</div>
  </div>
  <div class="card">
    <h4>Total Deposits</h4>
    <div id="dep" style="font-size:22px;font-weight:800;margin-top:8px">₦0</div>
  </div>
  <div class="card">
    <h4>Total Withdrawals</h4>
    <div id="wd" style="font-size:22px;font-weight:800;margin-top:8px">₦0</div>
  </div>
  <div class="card" style="grid-column:span 3">
    <h4>Transaction summary (last 7 days)</h4>
    <table>
      <thead><tr><th>Date</th><th>Volume</th><th>Deposits</th><th>Withdrawals</th></tr></thead>
      <tbody id="summary"></tbody>
    </table>
  </div>
  <div class="card">
    <h4>Fraud Attempts</h4>
    <div id="fraudCount" style="font-weight:800;font-size:18px;margin-top:8px">0</div>
    <button class="btn" style="margin-top:10px" onclick="location.href='fraud.html'">Investigate</button>
  </div>
  <div class="card">
    <h4>Failed Transactions</h4>
    <div id="failedCount" style="font-weight:800;font-size:18px;margin-top:8px">0</div>
    <button class="btn" style="margin-top:10px" onclick="alert('Open transactions page in real app')">View</button>
  </div>
  <div class="card">
    <h4>Active Users</h4>
    <div id="actUsers" style="font-weight:800;font-size:18px;margin-top:8px">0</div>
  </div>
</div>

<script>
(async function(){
  const LOGIN_PAGE = "index.html";
  const EXPECTED_ROLE = "monitor"; // the staff role required for this page

  // ----------- AUTH CHECK -----------
  try {
    const authRes = await fetch("https://payme-update.onrender.com/auth/check", {
      method:"GET", credentials:"include", headers:{"Accept":"application/json"}
    });
    if(!authRes.ok){ window.location.href = LOGIN_PAGE; return; }
    const authData = await authRes.json();
    const serverRole = (authData.role||"").toLowerCase();
    if(serverRole !== EXPECTED_ROLE.toLowerCase()){
      alert("Unauthorized access. Contact admin.");
      window.location.href = LOGIN_PAGE;
      return;
    }
    sessionStorage.setItem("staff_role", serverRole);
  } catch(e){
    console.error("Auth failed:", e);
    window.location.href = LOGIN_PAGE;
    return;
  }

  // ----------- FETCH METRICS -----------
  try {
    const metricsRes = await fetch("https://payme-update.onrender.com/admin/metrics", { credentials:"include" });
    const metrics = await metricsRes.json();
    if(metrics.status==="success"){
      document.getElementById('vol').innerText = `₦${Number(metrics.total_volume).toLocaleString()}`;
      document.getElementById('dep').innerText = `₦${Number(metrics.deposits).toLocaleString()}`;
      document.getElementById('wd').innerText = `₦${Number(metrics.withdrawals).toLocaleString()}`;
      document.getElementById('actUsers').innerText = Number(metrics.active_users).toLocaleString();
    }
  } catch(e){ console.error("Metrics fetch failed:", e); }

  // ----------- FETCH DAILY SUMMARY -----------
  try {
    const summaryRes = await fetch("https://payme-update.onrender.com/admin/daily_summary", { credentials:"include" });
    const data = await summaryRes.json();
    if(data.status==="success" && data.summary){
      const rows = data.summary.map(r=>`<tr>
        <td>${r.day}</td>
        <td>₦${Number(r.total).toLocaleString()}</td>
        <td>₦${Number(r.deposits).toLocaleString()}</td>
        <td>₦${Number(r.withdrawals).toLocaleString()}</td>
      </tr>`);
      document.getElementById('summary').innerHTML = rows.join('');
    }
  } catch(e){ console.error("Daily summary fetch failed:", e); }

  // ----------- PLACEHOLDERS -----------
  document.getElementById('fraudCount').innerText = '3';   // TODO: replace with real DB data
  document.getElementById('failedCount').innerText = '12'; // TODO: replace with real DB data

})();
</script>
</body>
</html>