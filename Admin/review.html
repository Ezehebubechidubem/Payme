<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PayMe — Monitoring</title>
<style>
:root{--bg:#fff;--text:#000;--green:#10b981;--muted:#6b7280;--card:#f8fafb}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Arial}
header{padding:18px;border-bottom:1px solid #f0f2f3}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:18px}
.card{background:var(--card);padding:14px;border-radius:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eee}
.muted{color:var(--muted)}
.btn{background:var(--green);color:#fff;padding:8px;border-radius:8px;border:0;cursor:pointer}
.role-banner{margin:0 18px 12px;padding:8px;background:#f0fdf4;color:#065f46;border-radius:8px;font-weight:600}
</style>
</head>
<body>

<header>
  <a href=" https://ezehebubechidubem.github.io/Payme/index.html" style="color:#6b7280;text-decoration:none">← Dashboard</a>
  <h2 style="margin:6px 0">Monitoring</h2>
  <div class="muted">View daily volume, deposits, withdrawals, active users, fraud attempts, and failed transactions.</div>
</header>

<div id="roleBanner" class="role-banner" style="display:none"></div>

<div class="grid">
  <div class="card">
    <h4>Total Volume (24h)</h4>
    <div id="vol" style="font-size:22px;font-weight:800;margin-top:8px">₦0</div>
  </div>
  <div class="card">
    <h4>Total Deposits</h4>
    <div id="dep" style="font-size:22px;font-weight:800;margin-top:8px">₦0</div>
  </div>
  <div class="card">
    <h4>Total Withdrawals</h4>
    <div id="wd" style="font-size:22px;font-weight:800;margin-top:8px">₦0</div>
  </div>

  <div class="card" style="grid-column:span 3">
    <h4>Transaction summary (last 7 days)</h4>
    <table>
      <thead><tr><th>Date</th><th>Volume</th><th>Deposits</th><th>Withdrawals</th></tr></thead>
      <tbody id="summary"></tbody>
    </table>
  </div>

  <div class="card" id="fraudCard">
    <h4>Fraud Attempts</h4>
    <div id="fraudCount" style="font-weight:800;font-size:18px;margin-top:8px">0</div>
    <button class="btn" onclick="location.href='fraud.html'">Investigate</button>
  </div>

  <div class="card" id="failedCard">
    <h4>Failed Transactions</h4>
    <div id="failedCount" style="font-weight:800;font-size:18px;margin-top:8px">0</div>
    <button class="btn" onclick="alert('Open transactions page in real app')">View</button>
  </div>

  <div class="card">
    <h4>Active Users</h4>
    <div id="actUsers" style="font-weight:800;font-size:18px;margin-top:8px">0</div>
  </div>
</div>

<script>
(async function(){
  // ----------- Transaction-Only Role Authentication -----------
  const TRANSACTION_ROLES = ["transaction review","transaction-review"];

  let staffRole = "";
  try {
    const res = await fetch("https://payme-update.onrender.com/auth/check", {
      method: "GET",
      credentials: "include",
      headers: {"Accept":"application/json"}
    });

    if(!res.ok) throw new Error("Auth check failed");

    const data = await res.json();
    staffRole = (data.role || data.user?.role || "").toLowerCase();

    if(!TRANSACTION_ROLES.includes(staffRole)){
      window.location.href = "https://ezehebubechidubem.github.io/Payme/index.html";
      return;
    }

    // show role-specific banner
    const banner = document.getElementById("roleBanner");
    banner.innerText = `Logged in as: ${staffRole.toUpperCase()}`;
    banner.style.display = "block";

    sessionStorage.setItem("staff_role", staffRole);

  } catch(err){
    window.location.href = "https://ezehebubechidubem.github.io/Payme/index.html";
  }

  // ----------- Role-specific UI Variants -----------
  if(staffRole.includes("support")){
    document.getElementById("fraudCard").style.display = "none"; // support doesn't see fraud
  }

  if(staffRole.includes("transaction")){
    document.getElementById("failedCard").style.display = "block";
  }

  // ----------- Fetch Metrics -----------
  try {
    const metricsRes = await fetch("https://payme-update.onrender.com/admin/metrics", { credentials:"include" });
    const metrics = await metricsRes.json();
    if(metrics.status==="success"){
      document.getElementById('vol').innerText = `₦${Number(metrics.total_volume).toLocaleString()}`;
      document.getElementById('dep').innerText = `₦${Number(metrics.deposits).toLocaleString()}`;
      document.getElementById('wd').innerText = `₦${Number(metrics.withdrawals).toLocaleString()}`;
      document.getElementById('actUsers').innerText = Number(metrics.active_users).toLocaleString();
    }
  } catch(err){ console.error("Metrics fetch failed:", err); }

  // ----------- Fetch Daily Summary -----------
  try {
    const summaryRes = await fetch("https://payme-update.onrender.com/admin/daily_summary", { credentials:"include" });
    const summaryData = await summaryRes.json();
    if(summaryData.status==="success" && summaryData.summary){
      const rows = summaryData.summary.map(r=>`<tr>
        <td>${r.day}</td>
        <td>₦${Number(r.total).toLocaleString()}</td>
        <td>₦${Number(r.deposits).toLocaleString()}</td>
        <td>₦${Number(r.withdrawals).toLocaleString()}</td>
      </tr>`);
      document.getElementById('summary').innerHTML = rows.join('');
    }
  } catch(err){ console.error("Daily summary fetch failed:", err); }

  // ----------- Placeholders -----------
  document.getElementById('fraudCount').innerText = '3';
  document.getElementById('failedCount').innerText = '12';
})();
</script>
</body>
</html>