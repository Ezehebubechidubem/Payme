<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Payme — Monitoring</title>
<style>
 :root{--bg:#fff;--text:#000;--green:#10b981;--muted:#6b7280;--card:#f8fafb}
 body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Arial}
 header{padding:18px;border-bottom:1px solid #f0f2f3}
 .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:18px}
 .card{background:var(--card);padding:14px;border-radius:12px}
 table{width:100%;border-collapse:collapse}
 th,td{padding:8px;border-bottom:1px solid #eee}
 .muted{color:var(--muted)}
 .btn{background:var(--green);color:#fff;padding:8px;border-radius:8px;border:0;cursor:pointer}
</style>
</head>
<body>

<!-- ---------------- AUTH CHECK ---------------- -->
<script>
(async function(){
  const EXPECTED_ROLE = "monitoring"; // staff role required for this page
  try {
    const res = await fetch("https://payme-update.onrender.com/auth/check", {
      method: "GET",
      credentials: "include",
      headers: { "Accept": "application/json" }
    });
    if (!res.ok) {
      window.location.href = "https://ezehebubechidubem.github.io/Payme/login.html";
      return;
    }
    const data = await res.json();
    const serverRole = (data.role || "").toString().toLowerCase();
    if (serverRole !== EXPECTED_ROLE.toLowerCase()) {
      window.location.href = "https://ezehebubechidubem.github.io/Payme/login.html";
      return;
    }
    try { sessionStorage.setItem("staff_role", serverRole); } catch(e){}
  } catch(err){
    window.location.href = "https://ezehebubechidubem.github.io/Payme/login.html";
  }
})();
</script>

<!-- ---------------- PAGE CONTENT ---------------- -->
<header>
  <a href="index.html" style="color:#6b7280;text-decoration:none">← Dashboard</a>
  <h2 style="margin:6px 0">5 — Monitoring</h2>
  <div class="muted">View daily volume, deposits, withdrawals, active users, and failed transactions.</div>
</header>

<div class="grid">
  <div class="card">
    <h4>Total Volume (24h)</h4>
    <div style="font-size:22px;font-weight:800;margin-top:8px" id="vol">₦0</div>
  </div>
  <div class="card">
    <h4>Total Deposits</h4>
    <div style="font-size:22px;font-weight:800;margin-top:8px" id="dep">₦0</div>
  </div>
  <div class="card">
    <h4>Total Withdrawals</h4>
    <div style="font-size:22px;font-weight:800;margin-top:8px" id="wd">₦0</div>
  </div>

  <div class="card" style="grid-column:span 3">
    <h4>Transaction summary (last 30 days)</h4>
    <table>
      <thead><tr><th>Date</th><th>Volume</th><th>Deposits</th><th>Withdrawals</th></tr></thead>
      <tbody id="summary"></tbody>
    </table>
  </div>

  <div class="card">
    <h4>Fraud Attempts</h4>
    <div id="fraudCount" style="font-weight:800;font-size:18px;margin-top:8px">0</div>
    <button class="btn" style="margin-top:10px" onclick="location.href='fraud.html'">Investigate</button>
  </div>

  <div class="card">
    <h4>Failed Transactions</h4>
    <div id="failedCount" style="font-weight:800;font-size:18px;margin-top:8px">0</div>
    <button class="btn" style="margin-top:10px" onclick="alert('Open transactions page in real app')">View</button>
  </div>

  <div class="card">
    <h4>Active Users</h4>
    <div id="actUsers" style="font-weight:800;font-size:18px;margin-top:8px">0</div>
  </div>
</div>

<script>
async function loadMonitoringData() {
  try {
    const res = await fetch("https://payme-update.onrender.com/admin/metrics", {
      method: "GET",
      credentials: "include",
      headers: { "Accept": "application/json" }
    });
    if (!res.ok) throw new Error("Failed to fetch metrics");
    const data = await res.json();
    if(data.status === "success"){
      document.getElementById('vol').innerText = `₦${Number(data.total_volume).toLocaleString()}`;
      document.getElementById('dep').innerText = `₦${Number(data.deposits).toLocaleString()}`;
      document.getElementById('wd').innerText = `₦${Number(data.withdrawals).toLocaleString()}`;
      document.getElementById('actUsers').innerText = Number(data.active_users).toLocaleString();
    }

    // Populate 7-day transaction summary (mock for now)
    const rows = [];
    for(let i=0;i<7;i++){
      const d = new Date(); d.setDate(d.getDate()-i);
      rows.push(`<tr><td>${d.toISOString().slice(0,10)}</td>
        <td>₦${(Math.floor(Math.random()*200000)+50000).toLocaleString()}</td>
        <td>₦${(Math.floor(Math.random()*120000)+20000).toLocaleString()}</td>
        <td>₦${(Math.floor(Math.random()*80000)+5000).toLocaleString()}</td></tr>`);
    }
    document.getElementById('summary').innerHTML = rows.join('');
  } catch(err){
    console.error(err);
  }
}

// Demo counts for failed/fraud
document.getElementById('fraudCount').innerText = '3';
document.getElementById('failedCount').innerText = '12';

loadMonitoringData();
</script>

</body>
</html>