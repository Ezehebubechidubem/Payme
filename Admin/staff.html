<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PayMe — Staff Roles</title>
<style>
:root{--bg:#fff;--text:#000;--green:#10b981;--muted:#6b7280;--card:#f8fafb}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Arial}
header{padding:18px;border-bottom:1px solid #f0f2f3}
.container{display:flex;gap:18px;padding:18px}
.card{background:var(--card);padding:14px;border-radius:12px}
input,select{padding:8px;border-radius:8px;border:1px solid #e6e6e6;margin-top:8px;width:100%}
.btn{background:var(--green);color:#fff;padding:8px;border-radius:8px;border:0;cursor:pointer}
.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
.small-muted{color:var(--muted);font-size:13px}
.result-box{margin-top:10px;padding:10px;border-radius:8px;background:#f1f8f5;border:1px solid #d1f0df;color:#065f46}
.copy-btn{background:#065f46;color:#fff;padding:6px 10px;border-radius:6px;border:0;cursor:pointer;margin-left:8px}
.password-field{font-weight:700;letter-spacing:1px}
.notice{margin-top:6px;font-size:13px;color:#374151}
.debug{margin-top:8px;font-size:12px;color:#6b7280}
</style>
</head>
<body>
<header>
  <a href="index.html" style="color:#6b7280;text-decoration:none">← Dashboard</a>
  <h2 style="margin:6px 0">8 — Staff Roles</h2>
  <div class="small-muted">Manage support, transaction-review, super-admin, API manager, developer roles.</div>
</header>

<div class="container">
  <div class="card" style="width:380px">
    <h4 style="margin-top:0">Create Staff</h4>
    <input id="staffName" placeholder="Full name" autocomplete="name"/>
    <input id="staffEmail" placeholder="Email" type="email" autocomplete="email"/>
    <select id="staffRole">
      <option>Customer-support</option>
      <option>Transaction-review</option>
      <option>Scaling</option>
      <option>API manager</option>
      <option>Developer</option>
      <option>KYC</option>
      <option>Fraud</option>
      <option>Log</option>
      <option>Notification</option>
      
    </select>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" onclick="createStaff()">Create</button>
      <button id="clearBtn" style="padding:8px;border-radius:8px;border:1px solid #ddd;background:#fff" onclick="clearForm()">Clear</button>
    </div>

    <div id="staffResult" style="margin-top:8px"></div>

    <div id="passwordArea" style="display:none" class="result-box">
      <div>Share this temporary password with the staff (show once):</div>
      <div style="margin-top:8px;display:flex;align-items:center">
        <div id="generatedPassword" class="password-field" style="background:#fff;padding:6px 10px;border-radius:6px"></div>
        <button class="copy-btn" onclick="copyPassword()">Copy</button>
      </div>
      <div class="notice">Passwords are shown only once. Instruct staff to change it after first login.</div>
    </div>

    <div id="debugBox" class="debug" style="display:none"></div>
  </div>

  <div class="card" style="flex:1">
    <h4 style="margin-top:0">Existing Staff</h4>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr></thead>
        <tbody id="staffList"></tbody>
      </table>
    </div>
    <div id="listMsg" class="small-muted" style="margin-top:10px"></div>
  </div>
</div>

<script>
// ------ CONFIG ------
const API_BASE = "https://payme-update.onrender.com/api"; // update if needed

// ------ HELPERS ------
function showResult(msg, isError=false){
  const el = document.getElementById('staffResult');
  el.innerText = msg;
  el.style.color = isError ? '#b91c1c' : '#065f46';
}

function clearForm(){
  // This function is used by the CLEAR button — it should clear inputs AND hide password.
  document.getElementById('staffName').value = '';
  document.getElementById('staffEmail').value = '';
  document.getElementById('staffResult').innerText = '';
  hidePassword();
}

function clearInputsOnly(){
  // Use this after successful create: clear only inputs but KEEP password visible.
  document.getElementById('staffName').value = '';
  document.getElementById('staffEmail').value = '';
  // keep staffResult and passwordArea intact
}

// copy generated password to clipboard
function copyPassword(){
  const pw = document.getElementById('generatedPassword').innerText;
  if(!pw) return;
  navigator.clipboard?.writeText(pw).then(() => {
    showResult('Password copied to clipboard');
  }, () => {
    showResult('Unable to copy — select and copy manually', true);
  });
}

function showPassword(pw){
  document.getElementById('generatedPassword').innerText = pw;
  document.getElementById('passwordArea').style.display = 'block';
  // auto-hide after 30s for safety
  setTimeout(() => {
    // do not auto-hide if user cleared via Clear button — check if still visible
    const area = document.getElementById('passwordArea');
    if(area && area.style.display !== 'none') hidePassword();
  }, 30000);
}

function hidePassword(){
  document.getElementById('passwordArea').style.display = 'none';
  document.getElementById('generatedPassword').innerText = '';
  // preserve last server debug only in debug box
}

// basic email check
function isValidEmail(email){
  return /\S+@\S+\.\S+/.test(email);
}

function showDebug(msg){
  const el = document.getElementById('debugBox');
  el.style.display = 'block';
  el.innerText = msg;
}

// ------ API CALLS ------
async function fetchStaff(){
  try {
    document.getElementById('listMsg').innerText = 'Loading...';
    const res = await fetch(`${API_BASE}/staff/list`);
    const data = await res.json().catch(()=>null);
    if(!res.ok){
      document.getElementById('listMsg').innerText = (data && data.message) ? data.message : 'Failed to load staff';
      return;
    }
    const staff = (data && data.staff) ? data.staff : [];
    renderStaff(staff);
    document.getElementById('listMsg').innerText = staff.length ? '' : 'No staff yet';
  } catch(err){
    console.error(err);
    document.getElementById('listMsg').innerText = 'Unable to fetch staff';
  }
}

function renderStaff(staffArray){
  const tbody = document.getElementById('staffList');
  if(!Array.isArray(staffArray)){ tbody.innerHTML = ''; return; }
  tbody.innerHTML = staffArray.map(s => {
    const id = s.id || s['id'] || s[0] || '';
    const name = s.name || s['name'] || s[1] || '';
    const email = s.email || s['email'] || s[2] || '';
    const role = s.role || s['role'] || s[3] || '';
    return `<tr>
      <td>${escapeHtml(name)}</td>
      <td>${escapeHtml(email)}</td>
      <td>${escapeHtml(role)}</td>
      <td><button onclick="removeStaff('${id}')" style="padding:6px 8px;border-radius:6px;border:0;background:#ff4d4f;color:#fff">Remove</button></td>
    </tr>`;
  }).join('');
}

// simple escape to avoid injection in table cells
function escapeHtml(unsafe){
  if(!unsafe) return '';
  return String(unsafe).replace(/[&<>"'`=\/]/g, function(s){ return ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
  })[s]; });
}

// create staff (backend generates password and returns generated_password)
async function createStaff(){
  hidePassword();
  document.getElementById('debugBox').style.display = 'none';
  const name = document.getElementById('staffName').value.trim();
  const email = document.getElementById('staffEmail').value.trim();
  const role = document.getElementById('staffRole').value;

  if(!name || !email){ alert('Name & email required'); return; }
  if(!isValidEmail(email)){ alert('Enter a valid email'); return; }

  try {
    showResult('Creating staff...');
    const res = await fetch(`${API_BASE}/staff/create`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name, email, role})
    });

    // read raw text first so we can debug malformed responses
    const raw = await res.text();
    let data = null;
    try { data = JSON.parse(raw); } catch(e) { data = null; }

    console.log('POST /staff/create => status:', res.status, 'raw:', raw, 'parsed:', data);

    if(!res.ok){
      // show server returned message if available
      const msg = data && data.message ? data.message : `Server error (${res.status})`;
      showResult(msg, true);
      // show raw server response in debug box for easier diagnosing
      showDebug(`RAW RESPONSE: ${raw}`);
      return;
    }

    // Accept many possible keys the backend might return
    const pw = data && (data.generated_password || data.password || data.generatedPassword || data.generatedPass);
    if(pw){
      // IMPORTANT: do not call clearForm here because that hides password.
      // clear only inputs and keep password visible
      clearInputsOnly();
      showPassword(pw);
      showResult('Staff created — password shown below. Copy and share securely.');
      fetchStaff();
      return;
    }

    // If the server returned success but no password, show debug info
    if(data && data.status === 'success'){
      showResult('Staff created but no password returned by backend (see debug).', true);
      showDebug(`RAW RESPONSE: ${raw}`);
      fetchStaff();
      return;
    }

    // fallback: show server message
    showResult(data && data.message ? data.message : 'Unexpected server response', true);
    showDebug(`RAW RESPONSE: ${raw}`);
  } catch(err){
    console.error(err);
    showResult('Error creating staff', true);
    showDebug(String(err));
  }
}

async function removeStaff(id){
  if(!confirm('Remove staff?')) return;
  try {
    const res = await fetch(`${API_BASE}/staff/${id}`, {method:'DELETE'});
    if(res.ok){
      showResult('Staff removed');
      fetchStaff();
    } else {
      const raw = await res.text();
      let data = null;
      try { data = JSON.parse(raw); } catch(e){ data = null; }
      showResult(data && data.message ? data.message : 'Failed to remove', true);
      showDebug(`RAW RESPONSE: ${raw}`);
    }
  } catch(err){
    console.error(err);
    showResult('Error removing staff', true);
    showDebug(String(err));
  }
}

// initial load
fetchStaff();
</script>
</body>
</html>