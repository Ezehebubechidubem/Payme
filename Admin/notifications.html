<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Payme — Notifications</title>
<style>
 :root{
  --bg:#fff;--text:#000;--green:#10b981;--muted:#6b7280;--card:#f8fafb;
  --danger:#ef4444;
 }
 body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Arial}
 header{padding:18px;border-bottom:1px solid #f0f2f3}
 .container{padding:18px}
 .card{background:var(--card);padding:14px;border-radius:12px}
 input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;margin-top:8px}
 .btn{background:var(--green);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
 .muted{color:var(--muted)}
 .role-banner{margin:0 18px 12px;padding:8px;background:#f0fdf4;color:#065f46;border-radius:8px;font-weight:600}
 .img-preview{margin-top:8px}
 .img-preview img{max-width:260px;max-height:140px;border-radius:8px;display:block}
 .limit-warning{color:var(--danger);margin-top:8px}
 .carousel { margin-top:12px; position:relative; overflow:hidden; border-radius:12px; background:#fff; border:1px solid #eee; }
 .carousel-track { display:flex; transition:transform .45s ease; }
 .slide { min-width:100%; box-sizing:border-box; padding:12px; display:flex; gap:12px; align-items:center; }
 .slide img{width:160px;height:90px;object-fit:cover;border-radius:8px;flex:0 0 160px}
 .slide .text { flex:1 }
 .carousel-controls { position:absolute; left:8px; right:8px; top:50%; transform:translateY(-50%); display:flex; justify-content:space-between; pointer-events:none; }
 .carousel-controls button{pointer-events:auto; background:rgba(255,255,255,0.95); border:1px solid #eee; padding:6px 8px; border-radius:8px; cursor:pointer}
 .small-muted{color:var(--muted);font-size:13px}
 .history-item{padding:8px;border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; gap:8px}
 .history-meta{color:#6b7280;font-size:13px}
 .actions-col button{margin-bottom:6px;width:120px}
 .spinner {display:inline-block;width:14px;height:14px;border:2px solid rgba(0,0,0,0.1);border-top-color:#000;border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-left:8px}
 @keyframes spin{ to { transform: rotate(360deg);} }

/* debug panel */
#annDebug { display:none; position:fixed; right:12px; bottom:12px; width:420px; max-height:60vh; overflow:auto; background:#111827;color:#fff;padding:12px;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.3); font-family:monospace; font-size:12px; z-index:9999;}
#annDebug h4 { margin:0 0 8px 0; font-size:13px; }
#annDebug pre { white-space:pre-wrap; word-break:break-word; background:rgba(255,255,255,0.03); padding:8px; border-radius:6px; margin:6px 0; max-height:28vh; overflow:auto;}
#annDebug .close-btn{ background:#ef4444;color:#fff;border:0;padding:6px 8px;border-radius:6px; cursor:pointer; float:right;}
.toggle-debug { position:absolute; right:12px; top:12px; background:#f3f4f6;color:#111;padding:6px 8px;border-radius:6px;border:0; cursor:pointer;}
</style>
</head>
<body>

<!-- AUTH CHECK (same as monitoring), now uses API_BASE below -->
<script>
(async function(){
  const API_BASE = "https://payme-update.onrender.com";
  const EXPECTED_ROLE = "notification";
  try {
    const res = await fetch(`${API_BASE}/auth/check`, {
      method: "GET",
      credentials: "include",
      headers: {"Accept":"application/json"}
    });
    if(!res.ok){ window.location.href = "https://ezehebubechidubem.github.io/Payme/index.html"; return; }
    const data = await res.json();
    const serverRole = (data.role || data.user?.role || "").toString().toLowerCase();
    if(serverRole !== EXPECTED_ROLE){ window.location.href = "https://ezehebubechidubem.github.io/Payme/index.html"; return; }

    // show role banner
    const banner = document.createElement('div');
    banner.className = 'role-banner';
    banner.innerText = `Logged in as: ${serverRole.toUpperCase()}`;
    document.body.insertBefore(banner, document.querySelector('header').nextSibling);

    try { sessionStorage.setItem("staff_role", serverRole); } catch(e){}
  } catch(err){
    window.location.href = "https://ezehebubechidubem.github.io/Payme/index.html";
  }
})();
</script>

<header>
  <a href="https://ezehebubechidubem.github.io/Payme/index.html" style="color:#6b7280;text-decoration:none">← Dashboard</a>
  <h2 style="margin:6px 0">7 — Notifications & Announcements</h2>
  <div class="muted"></div>
  <button class="toggle-debug" onclick="toggleDebug()">Debug</button>
</header>

<div class="container">
  <div class="card">
    <h3 style="margin-top:0">Create Announcement</h3>

    <label for="notifTitle">Title</label>
    <input id="notifTitle" placeholder="Short headline" maxlength="120"/>

    <label for="notifBody">Message body</label>
    <textarea id="notifBody" rows="4" placeholder="Write the announcement message" maxlength="1000"></textarea>

    <div style="display:flex;gap:8px;margin-top:8px">
      <div style="flex:1">
        <label for="notifTarget">Target</label>
        <select id="notifTarget">
          <option value="all">All users</option>
          <option value="active">Active users</option>
          <option value="suspended">Suspended users</option>
          <option value="custom">Custom segment</option>
        </select>
      </div>
      <div style="flex:1">
        <label for="notifExpiry">Expiry</label>
        <input id="notifExpiry" type="datetime-local" />
      </div>
    </div>

    <div style="margin-top:10px">
      <label style="display:block;font-weight:600;margin-bottom:6px">Attach image</label>
      <input id="notifyFile" type="file" accept="image/*"/>
      <div class="img-preview" id="imgPreview" style="display:none"><img id="imgPreviewImg" src="" alt="preview"/></div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="sendBtn" class="btn" onclick="sendNotification()">Send</button>
      <button style="padding:8px;border-radius:8px;border:1px solid #ddd;background:#fff" onclick="clearNotif()">Clear</button>
      <div id="sendStatus" style="margin-left:8px;color:var(--muted);align-self:center"></div>
    </div>

    <div id="limitWarning" class="limit-warning" style="display:none">Max 10 active announcements reached. Delete or republish in history to create more.</div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3 style="margin-top:0">Active Announcements (Preview)</h3>
    <div id="carouselWrap">
      <div id="carousel" class="carousel" style="display:none">
        <div id="carouselTrack" class="carousel-track"></div>
        <div class="carousel-controls">
          <button id="prevBtn" aria-label="Previous">◀</button>
          <button id='nextBtn' aria-label="Next">▶</button>
        </div>
      </div>
      <div id="noActive" class="small-muted">No active announcements</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3 style="margin-top:0">Previous Announcements (History)</h3>
    <div id="history"></div>
  </div>
</div>

<!-- debug panel -->
<div id="annDebug" role="dialog" aria-label="Announcements debug panel">
  <button class="close-btn" onclick="toggleDebug(true)">Close</button>
  <h4>Debug — Last Request & Response</h4>
  <div><strong>Last Request</strong></div>
  <pre id="lastReq"></pre>
  <div><strong>Last Response</strong></div>
  <pre id="lastRes"></pre>
</div>

<script>
// Make this match the staff pattern: API_BASE includes the /api prefix
const API_BASE = "https://payme-update.onrender.com/api";
const CREATE_URL = `${API_BASE}/announcements`;
const ACTIVE_URL = `${API_BASE}/announcements/active`;
const HISTORY_URL = `${API_BASE}/announcements`;
const DELETE_URL_BASE = `${API_BASE}/announcements`; // DELETE /<id>
const REPUBLISH_URL_BASE = `${API_BASE}/announcements`; // POST /<id>/republish
const MAX_ACTIVE = 10;

// Debug helpers
function showDebugPanel(reqText, resText){
  document.getElementById('lastReq').innerText = reqText || '';
  document.getElementById('lastRes').innerText = resText || '';
  document.getElementById('annDebug').style.display = 'block';
}
function toggleDebug(forceHide){
  const panel = document.getElementById('annDebug');
  if(forceHide) panel.style.display='none';
  else panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
}

// utility
function el(id){ return document.getElementById(id); }
function nowISO(){ return new Date().toISOString(); }
function showMsg(msg, isError=false, targetId='sendStatus'){ 
  const elmt = document.getElementById(targetId);
  elmt.textContent = msg || '';
  elmt.style.color = isError ? 'var(--danger)' : '';
}

// preview image
const fileInput = el('notifyFile');
const imgPreview = el('imgPreview');
const imgPreviewImg = el('imgPreviewImg');
fileInput?.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f){ imgPreview.style.display='none'; imgPreviewImg.src=''; return; }
  const r = new FileReader();
  r.onload = ()=>{ imgPreviewImg.src = r.result; imgPreview.style.display='block'; };
  r.readAsDataURL(f);
});

/* ---------- Image URL helper ----------
   Ensures UI can show an image when backend returns:
   - image_url (absolute)
   - image_path (filename or path)
   - image (filename)
   This builds a proper absolute URL when necessary.
---------------------------------------- */
function buildImageUrl(obj){
  if(!obj) return null;
  // accept various keys
  let candidate = obj.image_url || obj.imageUrl || obj.image_path || obj.imagePath || obj.image || null;
  if(!candidate) return null;
  candidate = String(candidate);

  // if candidate already absolute URL -> return it
  if(/^https?:\/\//i.test(candidate)) return candidate;

  // remove trailing /api from API_BASE to get site root
  const siteBase = API_BASE.replace(/\/api\/?$/i, '');

  // if backend returned a leading path like /admin/uploads/announcements/xxx
  if(candidate.startsWith('/')){
    return siteBase + candidate;
  }

  // if backend returned "admin/uploads/announcements/xxx"
  if(candidate.toLowerCase().startsWith('admin/')){
    return siteBase + '/' + candidate;
  }

  // otherwise assume it's a filename stored in announcements folder
  return `${siteBase}/admin/uploads/announcements/${candidate}`;
}

/* ---------- Load images using fetch + credentials (fallback) ----------
   Some backends require cookies for image access. If a plain <img src=...>
   is blocked (redirects to login or needs credentials) the browser will
   show broken image. To handle that we try fetching the image with
   credentials and convert it to an object URL and set img.src.
--------------------------------------------------------------------- */
function loadImagesWithCredentials(root){
  if(!root) return;
  const imgs = root.querySelectorAll('img[data-src]');
  imgs.forEach(img => {
    const src = img.getAttribute('data-src');
    if(!src) return;
    // attempt fetch with credentials
    fetch(src, { credentials: 'include' })
      .then(res => {
        if(!res.ok) throw new Error('fetch-failed');
        return res.blob();
      })
      .then(blob => {
        // create object URL and set img.src
        const objectUrl = URL.createObjectURL(blob);
        img.src = objectUrl;
        img.removeAttribute('data-src');
      })
      .catch(() => {
        // fallback: set src directly (may work if public)
        img.src = src;
        img.removeAttribute('data-src');
      });
  });
}

// Fetch active announcements (for preview)
async function fetchActive(){
  try {
    const res = await fetch(ACTIVE_URL, { credentials: 'include', cache: 'no-store' });
    if(!res.ok) throw new Error('no active endpoint');
    const list = await res.json();
    // server may return array directly
    return Array.isArray(list) ? list : (list.announcements || list.data || list);
  } catch(e){
    // try alternate endpoint (non-admin) for dashboard compatibility
    try {
      const res2 = await fetch(`${API_BASE.replace(/\/api$/,'')}/announcements/active`, { credentials: 'include', cache: 'no-store' });
      if(!res2.ok) throw new Error('no alt endpoint');
      const list2 = await res2.json();
      return Array.isArray(list2) ? list2 : (list2.announcements || list2.data || list2);
    } catch(err){ console.warn('fetchActive failed', err); return []; }
  }
}

// Fetch history (staff)
async function fetchHistory(){
  try {
    const res = await fetch(HISTORY_URL, { credentials:'include', cache:'no-store' });
    if(!res.ok) throw new Error('history unauthorized');
    const json = await res.json();
    // our admin route returns {status: "success", announcements: [...]}
    return json.announcements || json.data || [];
  } catch(e){
    console.warn('fetchHistory failed', e);
    return [];
  }
}

// render active preview carousel
let carouselIndex = 0;
let carouselTimer = null;
function renderActive(list){
  const carousel = el('carousel');
  const track = el('carouselTrack');
  const noActive = el('noActive');
  const limitWarning = el('limitWarning');

  if(!list || list.length === 0){
    carousel.style.display = 'none';
    noActive.style.display = 'block';
    limitWarning.style.display = 'none';
    return;
  }

  // enforce client-side limit note
  if(list.length >= MAX_ACTIVE) limitWarning.style.display = 'block';
  else limitWarning.style.display = 'none';

  track.innerHTML = list.map(a => {
    const imageUrl = buildImageUrl(a);
    // NOTE: use data-src instead of src so we can attempt credentialed fetch first
    const img = imageUrl ? `<img data-src="${escapeHtml(imageUrl)}" alt="">` : `<div style="width:160px;height:90px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;color:#9ca3af">No image</div>`;
    const created = a.createdAt ? (new Date(a.createdAt)).toLocaleString() : '';
    return `<div class="slide" data-id="${escapeHtml(a.id || '')}">
      ${img}
      <div class="text">
        <div style="font-weight:800">${escapeHtml(a.title || '')}</div>
        <div class="small-muted" style="margin-top:6px">${escapeHtml(a.target || '')} • ${created}</div>
        <div style="margin-top:8px">${escapeHtml(a.body || '')}</div>
      </div>
    </div>`;
  }).join('');

  // attempt to load images with credentials (if required by backend)
  // do this after DOM update
  loadImagesWithCredentials(track);

  carousel.style.display = 'block';
  noActive.style.display = 'none';
  carouselIndex = 0;
  updateCarouselTransform();

  if(carouselTimer) clearInterval(carouselTimer);
  if(list.length > 1){
    carouselTimer = setInterval(()=> {
      carouselIndex = (carouselIndex + 1) % list.length;
      updateCarouselTransform();
    }, 4000);
  }
}
function updateCarouselTransform(){
  const track = el('carouselTrack');
  track.style.transform = `translateX(-${carouselIndex * 100}%)`;
}
el('prevBtn')?.addEventListener('click', ()=>{ carouselIndex = Math.max(0, carouselIndex-1); updateCarouselTransform(); clearInterval(carouselTimer); });
el('nextBtn')?.addEventListener('click', ()=>{ carouselIndex = carouselIndex+1; updateCarouselTransform(); clearInterval(carouselTimer); });

// render history (staff)
function renderHistory(list){
  const container = el('history');
  if(!list || list.length === 0){ container.innerHTML = '<div class="small-muted">No announcements yet</div>'; return; }
  container.innerHTML = list.map(a => {
    const imageUrl = buildImageUrl(a);
    const img = imageUrl ? `<img data-src="${escapeHtml(imageUrl)}" style="width:120px;height:70px;object-fit:cover;border-radius:6px;margin-right:8px">` : '';
    const created = a.createdAt ? new Date(a.createdAt).toLocaleString() : '';
    const expires = a.expiresAt ? new Date(a.expiresAt).toLocaleString() : '—';
    return `<div class="history-item" data-id="${escapeHtml(a.id)}">
      <div style="display:flex;align-items:center;gap:12px;flex:1">
        ${img}
        <div>
          <strong>${escapeHtml(a.title || '(no title)')}</strong>
          <div class="history-meta">${escapeHtml(a.target || 'All')} • ${created} • Expires: ${expires}</div>
          <div style="margin-top:6px">${escapeHtml(a.body || '')}</div>
        </div>
      </div>
      <div class="actions-col" style="display:flex;flex-direction:column;align-items:flex-end">
        <button onclick="republishAnnouncement('${encodeURIComponent(a.id)}')" style="padding:6px;border-radius:6px;border:1px solid #ddd;background:#fff">Republish</button>
        <button onclick="deleteAnnouncement('${encodeURIComponent(a.id)}')" style="padding:6px;border-radius:6px;background:var(--danger);color:#fff;border:0">Permanent Delete</button>
      </div>
    </div>`;
  }).join('');

  // load history images with credentials as well
  loadImagesWithCredentials(container);
}

// helpers to escape
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }
function escapeJs(s){ return String(s||'').replace(/'/g, "\\'"); }
// check how many active announcements exist (server-side authoritative)
async function countActiveServer(){
  try {
    const res = await fetch(`${HISTORY_URL}?active=1`, { credentials:'include', cache:'no-store' });
    if(!res.ok) return 0;
    const json = await res.json();
    const arr = json.announcements || [];
    return Array.isArray(arr) ? arr.length : 0;
  } catch(e){ return 0; }
}

// send announcement to backend (with debug)
async function sendNotification(){
  const title = el('notifTitle').value.trim();
  const body = el('notifBody').value.trim();
  const target = el('notifTarget').value;
  const expiryRaw = el('notifExpiry').value; // datetime-local string or empty
  const file = el('notifyFile').files[0];
  const sendBtn = el('sendBtn');

  if(!title || !body){ alert('Title and body are required'); return; }

  // check active count
  const activeCount = await countActiveServer();
  if(activeCount >= MAX_ACTIVE){
    el('limitWarning').style.display = 'block';
    showMsg('Cannot create: 10 active announcements already.', true);
    return;
  } else {
    el('limitWarning').style.display = 'none';
  }

  // prepare data
  const form = new FormData();
  form.append('title', title);
  form.append('body', body);
  form.append('target', target);

  // if user provided expiry, send that ISO; otherwise set default to 24h ahead
  let expiresAt = null;
  if(expiryRaw){
    // convert local datetime to ISO (server will interpret)
    const dt = new Date(expiryRaw);
    if(!isNaN(dt.getTime())) expiresAt = dt.toISOString();
  }
  if(!expiresAt) expiresAt = new Date(Date.now() + 24*60*60*1000).toISOString();

  form.append('expiresAt', expiresAt);
  form.append('createdAt', new Date().toISOString());

  if(file) form.append('image', file);

  // UI
  sendBtn.disabled = true;
  sendBtn.innerText = 'Sending';
  const spinner = document.createElement('span'); spinner.className = 'spinner';
  sendBtn.appendChild(spinner);
  showMsg('');

  
  // Debug: show request keys
  const reqSummary = `POST ${CREATE_URL}\nFormData keys: ${Array.from(form.keys()).join(', ')}`;
  showDebugPanel(reqSummary, '');

  try {
    const res = await fetch(CREATE_URL, {
      method: 'POST',
      credentials: 'include',
      body: form
    });

    const rawText = await res.text().catch(()=>null);
    showDebugPanel(reqSummary, `HTTP ${res.status}\n${rawText || ''}`);

    // try parse json
    let json = null;
    try { json = rawText ? JSON.parse(rawText) : null; } catch(e){ json = null; }

    if(res.status === 404){
      showMsg(`Endpoint not found (404). Check backend URL: ${CREATE_URL}`, true);
      return;
    }
    if(res.status === 405){
      showMsg(`Method not allowed (405). Backend expects POST at ${CREATE_URL}`, true);
      return;
    }

    if(res.ok && json && (json.status === 'success' || res.status === 200 || res.status === 201)){
      showMsg('Announcement created and stored on server.');
      // refresh active and history views
      await refreshAllViews();
      // clear form
      clearNotif();
    } else {
      const message = (json && (json.message || json.error)) || `Server error (${res.status})`;
      showMsg(message, true);
    }
  } catch(err){
    console.error('sendNotification error', err);
    showMsg('Network or server error. Announcement not saved.', true);
    showDebugPanel(reqSummary, `NETWORK ERROR: ${String(err)}`);
  } finally {
    sendBtn.disabled = false;
    sendBtn.innerText = 'Send';
  }
}

// delete announcement (soft delete to 'deleted' status, per backend)
async function deleteAnnouncement(idEncoded){
  const id = decodeURIComponent(idEncoded);
  if(!confirm('Permanent delete this announcement? This will mark it as deleted.')) return;
  showMsg('Deleting...');
  try {
    const url = `${DELETE_URL_BASE}/${encodeURIComponent(id)}`;
    const res = await fetch(url, {
      method: 'DELETE',
      credentials: 'include'
    });

    const raw = await res.text().catch(()=>null);
    showDebugPanel(`DELETE ${url}`, `HTTP ${res.status}\n${raw || ''}`);

    if(res.ok){
      showMsg('Deleted.');
      await refreshAllViews();
    } else {
      let json = null;
      try{ json = raw ? JSON.parse(raw) : null } catch(e){ json = null }
      showMsg((json && json.message) || 'Delete failed', true);
    }
  } catch(err){
    console.error('deleteAnnouncement error', err);
    showMsg('Network error while deleting', true);
    showDebugPanel(`DELETE ${DELETE_URL_BASE}/${encodeURIComponent(id)}`, `NETWORK ERROR: ${String(err)}`);
  }
}


// republish: set new expiry = now + 24h unless user chooses custom
async function republishAnnouncement(idEncoded){
  const id = decodeURIComponent(idEncoded);
  const custom = prompt('Enter new expiry datetime (YYYY-MM-DD HH:MM or ISO) or leave blank for +24 hours from now:','');
  let newExpiry = null;
  if(custom){
    const parsed = new Date(custom);
    if(isNaN(parsed.getTime())){
      alert('Invalid date format. Use e.g. 2025-12-01 14:30 or ISO string.');
      return;
    }
    newExpiry = parsed.toISOString();
  } else {
    newExpiry = new Date(Date.now() + 24*60*60*1000).toISOString();
  }

  showMsg('Republishing...');
  try {
    const url = `${REPUBLISH_URL_BASE}/${encodeURIComponent(id)}/republish`;
    const res = await fetch(url, {
      method: 'POST',
      credentials: 'include',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ expiresAt: newExpiry, createdAt: new Date().toISOString() })
    });

    const raw = await res.text().catch(()=>null);
    showDebugPanel(`POST ${url}`, `HTTP ${res.status}\n${raw || ''}`);

    if(res.ok){
      showMsg('Republished.');
      await refreshAllViews();
    } else {
      let json = null;
      try{ json = raw ? JSON.parse(raw) : null } catch(e){ json = null }
      showMsg((json && json.message) || 'Republish failed', true);
    }
  } catch(err){
    console.error('republishAnnouncement', err);
    showMsg('Network error while republishing', true);
    showDebugPanel(`POST ${REPUBLISH_URL_BASE}/${encodeURIComponent(id)}/republish`, `NETWORK ERROR: ${String(err)}`);
  }
}

// clear form
function clearNotif(){
  el('notifTitle').value = '';
  el('notifBody').value = '';
  el('notifTarget').value = 'all';
  el('notifExpiry').value = '';
  el('notifyFile').value = '';
  imgPreview.style.display = 'none';
  showMsg('');
}

// refresh active + history
async function refreshAllViews(){
  // active
  const active = await fetchActiveForUI();
  renderActive(active);
  // history
  const hist = await fetchHistory();
  renderHistory(hist);
}

// helper to fetch active announcements for UI (tries admin then global)
async function fetchActiveForUI(){
  try {
    const res = await fetch(ACTIVE_URL, { credentials:'include', cache:'no-store' });
    if(res.ok){ const arr = await res.json(); return Array.isArray(arr) ? arr : (arr.announcements || arr.data || arr); }
  } catch(e){}
  try {
    const res2 = await fetch(`${API_BASE}/announcements/active`, { credentials:'include', cache:'no-store' });
    if(res2.ok){ const arr2 = await res2.json(); return Array.isArray(arr2) ? arr2 : (arr2.announcements || arr2.data || arr2); }
  } catch(e){}
  return [];
}

// initial load
(async function init(){
  await refreshAllViews();
  // refresh active list every 30s to reflect changes
  setInterval(async ()=>{ const active = await fetchActiveForUI(); renderActive(active); }, 30000);
})();
</script>

</body>
</html>
