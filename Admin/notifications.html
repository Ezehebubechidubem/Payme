<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Payme — Notifications</title>
<style>
 :root{--bg:#fff;--text:#000;--green:#10b981;--muted:#6b7280;--card:#f8fafb;--danger:#ef4444}
 body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Arial}
 header{padding:18px;border-bottom:1px solid #f0f2f3}
 .container{padding:18px}
 .card{background:var(--card);padding:14px;border-radius:12px}
 input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;margin-top:8px}
 .btn{background:var(--green);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
 .muted{color:var(--muted)}
 .role-banner{margin:0 18px 12px;padding:8px;background:#f0fdf4;color:#065f46;border-radius:8px;font-weight:600}
 .img-preview{margin-top:8px}
 .img-preview img{max-width:260px;max-height:140px;border-radius:8px;display:block}
 .limit-warning{color:var(--danger);margin-top:8px}
 .carousel { margin-top:12px; position:relative; overflow:hidden; border-radius:12px; background:#fff; border:1px solid #eee; }
 .carousel-track { display:flex; transition:transform .45s ease; }
 .slide { min-width:100%; box-sizing:border-box; padding:12px; display:flex; gap:12px; align-items:center; }
 .slide img{width:160px;height:90px;object-fit:cover;border-radius:8px;flex:0 0 160px}
 .slide .text { flex:1 }
 .carousel-controls { position:absolute; left:8px; right:8px; top:50%; transform:translateY(-50%); display:flex; justify-content:space-between; pointer-events:none; }
 .carousel-controls button{pointer-events:auto; background:rgba(255,255,255,0.95); border:1px solid #eee; padding:6px 8px; border-radius:8px; cursor:pointer}
 .small-muted{color:var(--muted);font-size:13px}
 .history-item{padding:8px;border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; gap:8px}
 .history-meta{color:#6b7280;font-size:13px}
 .actions-col button{margin-bottom:6px;width:140px}
 .spinner {display:inline-block;width:14px;height:14px;border:2px solid rgba(0,0,0,0.1);border-top-color:#000;border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-left:8px}
 @keyframes spin{ to { transform: rotate(360deg);} }
</style>
</head>
<body>

<!-- ---------------- AUTH CHECK ---------------- -->
<script>
(async function(){
  const EXPECTED_ROLE = "notification";
  try {
    const res = await fetch("https://payme-update.onrender.com/auth/check", {
      method: "GET",
      credentials: "include",
      headers: { "Accept": "application/json" }
    });
    if (!res.ok) {
      window.location.href = "https://ezehebubechidubem.github.io/Payme/login.html";
      return;
    }
    const data = await res.json();
    const serverRole = (data.role || data.user?.role || "").toString().toLowerCase();
    if (serverRole !== EXPECTED_ROLE.toLowerCase()) {
      window.location.href = "https://ezehebubechidubem.github.io/Payme/login.html";
      return;
    }

    // show role-specific banner
    const banner = document.createElement('div');
    banner.className = 'role-banner';
    banner.innerText = `Logged in as: ${serverRole.toUpperCase()}`;
    document.body.insertBefore(banner, document.querySelector('header').nextSibling);

    try { sessionStorage.setItem("staff_role", serverRole); } catch(e){}
  } catch(err){
    window.location.href = "https://ezehebubechidubem.github.io/Payme/login.html";
  }
})();
</script>

<!-- ---------------- PAGE CONTENT ---------------- -->
<header>
  <a href="https://ezehebubechidubem.github.io/Payme/index.html" style="color:#6b7280;text-decoration:none">← Dashboard</a>
  <h2 style="margin:6px 0">7 — Notifications & Announcements</h2>
  <div class="muted">Send maintenance messages, promotions, warnings, or account bans.</div>
</header>

<div class="container">
  <div class="card">
    <h3 style="margin-top:0">Create Announcement</h3>
    <label for="notifTitle">Title</label>
    <input id="notifTitle" placeholder="Title"/>

    <label for="notifBody">Message body</label>
    <textarea id="notifBody" rows="4" placeholder="Message body"></textarea>

    <div style="display:flex;gap:8px;margin-top:8px">
      <select id="notifTarget" style="flex:1">
        <option value="all">All users</option>
        <option value="active">Active users</option>
        <option value="suspended">Suspended users</option>
        <option value="custom">Custom segment</option>
      </select>
      <input id="notifSchedule" type="datetime-local" style="flex:1"/>
    </div>

    <div style="margin-top:10px">
      <label style="display:block;font-weight:600;margin-bottom:6px">Attach image (optional)</label>
      <input id="notifFile" type="file" accept="image/*"/>
      <div class="img-preview" id="imgPreview" style="display:none"><img id="imgPreviewImg" src="" alt="preview"/></div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="sendBtn" class="btn" onclick="sendNotification()">Send</button>
      <button style="padding:8px;border-radius:8px;border:1px solid #ddd;background:#fff" onclick="clearNotif()">Clear</button>
      <div id="notifResult" style="margin-left:8px;color:var(--muted);align-self:center"></div>
    </div>

    <div id="limitWarning" class="limit-warning" style="display:none">Max 10 active announcements reached. Delete or republish in history to create more.</div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3 style="margin-top:0">Previous Announcements (History)</h3>
    <div id="history"></div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3 style="margin-top:0">Active Announcements (Preview)</h3>
    <div id="previewArea">
      <div id="carousel" class="carousel" style="display:none">
        <div id="carouselTrack" class="carousel-track"></div>
        <div class="carousel-controls">
          <button id="prevBtn" aria-label="Previous">◀</button>
          <button id="nextBtn" aria-label="Next">▶</button>
        </div>
      </div>
      <div id="noActive" class="small-muted">No active announcements</div>
    </div>
  </div>
</div>

<script>
/*
  Frontend -> matches backend:
  POST https://payme-update.onrender.com/admin/announcements  (multipart/form-data)
  GET  https://payme-update.onrender.com/admin/announcements/active
  GET  https://payme-update.onrender.com/admin/announcements    (history)
  DELETE https://payme-update.onrender.com/admin/announcements/<id>
  POST   https://payme-update.onrender.com/admin/announcements/<id>/republish  (JSON)
*/

const API_BASE = "https://payme-update.onrender.com";
const MAX_ACTIVE = 10;

// elements
const notifFile = document.getElementById('notifFile');
const imgPreview = document.getElementById('imgPreview');
const imgPreviewImg = document.getElementById('imgPreviewImg');
const sendBtn = document.getElementById('sendBtn');
const notifResult = document.getElementById('notifResult');
const limitWarning = document.getElementById('limitWarning');
const carouselTrack = document.getElementById('carouselTrack');
const carousel = document.getElementById('carousel');
const noActive = document.getElementById('noActive');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');

let activeList = [];
let carouselIndex = 0;
let carouselTimer = null;

// image preview
notifFile.addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0];
  if(!f){ imgPreview.style.display='none'; imgPreviewImg.src=''; return; }
  const reader = new FileReader();
  reader.onload = ()=>{ imgPreviewImg.src = reader.result; imgPreview.style.display = 'block'; };
  reader.readAsDataURL(f);
});

// helper escape
function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// fetch active announcements (returns array)
async function fetchActive(){
  try {
    const res = await fetch(`${API_BASE}/admin/announcements/active`, { credentials: 'include', cache: 'no-store' });
    if(!res.ok) return [];
    const data = await res.json();
    // backend returns array
    if(Array.isArray(data)) return data;
    // sometimes backend may return { announcements: [] }
    if(data && data.announcements) return data.announcements;
    return [];
  } catch(err){ console.warn('fetchActive error', err); return []; }
}

// fetch history (requires staff/admin)
async function fetchHistory(){
  try {
    const res = await fetch(`${API_BASE}/admin/announcements`, { credentials: 'include', cache: 'no-store' });
    if(!res.ok) return [];
    const json = await res.json();
    if(json && Array.isArray(json.announcements)) return json.announcements;
    if(Array.isArray(json)) return json;
    return [];
  } catch(err){ console.warn('fetchHistory error', err); return []; }
}

// render history list
function renderHistory(list){
  const container = document.getElementById('history');
  if(!list || list.length === 0){ container.innerHTML = '<div class="small-muted">No announcements yet</div>'; return; }
  container.innerHTML = list.map(a=>{
    const imgHtml = a.image_url ? `<img src="${esc(a.image_url)}" style="width:120px;height:70px;object-fit:cover;border-radius:6px;margin-right:8px">` : '';
    const created = a.createdAt ? new Date(a.createdAt).toLocaleString() : '';
    const expires = a.expiresAt ? new Date(a.expiresAt).toLocaleString() : '—';
    return `<div class="history-item" data-id="${esc(a.id)}">
      <div style="display:flex;align-items:center;gap:12px;flex:1">
        ${imgHtml}
        <div>
          <strong>${esc(a.title || '(no title)')}</strong>
          <div class="history-meta">${esc(a.target || 'All')} • ${created} • Expires: ${expires}</div>
          <div style="margin-top:6px">${esc(a.body || '')}</div>
        </div>
      </div>
      <div class="actions-col" style="display:flex;flex-direction:column;align-items:flex-end">
        <button onclick="republishAnnouncement('${encodeURIComponent(a.id)}')" style="padding:6px;border-radius:6px;border:1px solid #ddd;background:#fff">Republish</button>
        <button onclick="deleteAnnouncement('${encodeURIComponent(a.id)}')" style="padding:6px;border-radius:6px;background:var(--danger);color:#fff;border:0">Permanent Delete</button>
      </div>
    </div>`;
  }).join('');
}

// render active preview carousel
function renderActive(list){
  activeList = Array.isArray(list) ? list.slice(0, MAX_ACTIVE) : [];
  if(activeList.length === 0){
    carousel.style.display = 'none';
    noActive.style.display = 'block';
    limitWarning.style.display = 'none';
    stopCarousel();
    return;
  }
  // limit warning if at capacity
  if(activeList.length >= MAX_ACTIVE) limitWarning.style.display = 'block';
  else limitWarning.style.display = 'none';

  carouselTrack.innerHTML = activeList.map(a=>{
    const imgHtml = a.image_url ? `<img src="${esc(a.image_url)}" alt="">` : `<div style="width:160px;height:90px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;color:#9ca3af">No image</div>`;
    const created = a.createdAt ? new Date(a.createdAt).toLocaleString() : '';
    return `<div class="slide" data-id="${esc(a.id)}">
      ${imgHtml}
      <div class="text">
        <div style="font-weight:800">${esc(a.title || '')}</div>
        <div class="small-muted" style="margin-top:6px">${esc(a.target || '')} • ${created}</div>
        <div style="margin-top:8px">${esc(a.body || '')}</div>
      </div>
    </div>`;
  }).join('');

  carousel.style.display = 'block';
  noActive.style.display = 'none';
  carouselIndex = 0;
  updateCarousel();
  if(activeList.length > 1) startCarousel();
  else stopCarousel();
}

function updateCarousel(){
  carouselTrack.style.transform = `translateX(-${carouselIndex * 100}%)`;
}

function startCarousel(){
  stopCarousel();
  carouselTimer = setInterval(()=>{
    carouselIndex = (carouselIndex + 1) % activeList.length;
    updateCarousel();
  }, 4000);
}
function stopCarousel(){ if(carouselTimer){ clearInterval(carouselTimer); carouselTimer = null; } }

prevBtn?.addEventListener('click', ()=>{ if(!activeList.length) return; carouselIndex = (carouselIndex-1 + activeList.length) % activeList.length; updateCarousel(); stopCarousel(); });
nextBtn?.addEventListener('click', ()=>{ if(!activeList.length) return; carouselIndex = (carouselIndex+1) % activeList.length; updateCarousel(); stopCarousel(); });

// Count active from server (authoritative)
async function countActiveServer(){
  try {
    const res = await fetch(`${API_BASE}/admin/announcements?active=1`, { credentials: 'include', cache: 'no-store' });
    if(!res.ok) return 0;
    const json = await res.json();
    const arr = (json && json.announcements) ? json.announcements : (Array.isArray(json) ? json : []);
    return Array.isArray(arr) ? arr.length : 0;
  } catch(e){ console.warn('countActiveServer', e); return 0; }
}

// send announcement (multipart/form-data)
async function sendNotification(){
  const title = document.getElementById('notifTitle').value.trim();
  const body = document.getElementById('notifBody').value.trim();
  const target = document.getElementById('notifTarget').value;
  const schedule = document.getElementById('notifSchedule').value; // datetime-local
  const file = notifFile.files[0];

  if(!title || !body){
    alert('Title & body required');
    return;
  }

  // check server active count
  const activeCount = await countActiveServer();
  if(activeCount >= MAX_ACTIVE){
    limitWarning.style.display = 'block';
    notifResult.textContent = 'Max active announcements reached (10).';
    return;
  } else {
    limitWarning.style.display = 'none';
  }

  // prepare form data
  const form = new FormData();
  form.append('title', title);
  form.append('body', body);
  form.append('target', target);
  // convert datetime-local to ISO if provided
  if(schedule){
    const dt = new Date(schedule);
    if(!isNaN(dt.getTime())) form.append('expiresAt', dt.toISOString());
  } else {
    // default expiry: 24 hours
    form.append('expiresAt', new Date(Date.now() + 24*60*60*1000).toISOString());
  }
  form.append('createdAt', new Date().toISOString());
  if(file) form.append('image', file);

  // UI: disable
  sendBtn.disabled = true;
  const spinner = document.createElement('span'); spinner.className='spinner'; sendBtn.appendChild(spinner);
  notifResult.textContent = '';

  try {
    const res = await fetch(`${API_BASE}/admin/announcements`, {
      method: 'POST',
      credentials: 'include',
      body: form
    });

    const j = await res.json().catch(()=>null);
    if(res.ok && j && (j.status === 'success' || j.id)){
      notifResult.style.color = 'green';
      notifResult.textContent = 'Announcement created.';
      // refresh views
      await refreshAll();
      clearNotif();
    } else {
      // server error or validation
      notifResult.style.color = 'var(--danger)';
      const msg = (j && (j.message || j.error)) ? j.message || j.error : `Server returned ${res.status}`;
      notifResult.textContent = msg;
    }
  } catch(err){
    console.error('sendNotification error', err);
    notifResult.style.color = 'var(--danger)';
    notifResult.textContent = 'Network error. Could not send.';
  } finally {
    sendBtn.disabled = false;
    if(spinner && spinner.parentNode) spinner.parentNode.removeChild(spinner);
  }
}

// delete announcement (soft-delete marked status='deleted' on backend)
async function deleteAnnouncement(encodedId){
  if(!confirm('Permanent delete this announcement? This marks it deleted for everyone.')) return;
  const id = decodeURIComponent(encodedId);
  try {
    notifResult.textContent = 'Deleting...';
    const res = await fetch(`${API_BASE}/admin/announcements/${encodeURIComponent(id)}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    const j = await res.json().catch(()=>null);
    if(res.ok && j && j.status === 'success'){
      notifResult.style.color = 'green'; notifResult.textContent = 'Deleted.';
      await refreshAll();
    } else {
      notifResult.style.color = 'var(--danger)';
      notifResult.textContent = (j && j.message) ? j.message : `Delete failed (${res.status})`;
    }
  } catch(err){
    console.error('deleteAnnouncement', err);
    notifResult.style.color = 'var(--danger)'; notifResult.textContent = 'Network error while deleting';
  }
}

// republish announcement (set status active and new expire/created)
async function republishAnnouncement(encodedId){
  const id = decodeURIComponent(encodedId);
  let newExpires = null;
  const custom = prompt('Enter expiry datetime (YYYY-MM-DD HH:MM) or leave blank for +24 hours:','');
  if(custom){
    // try simple parse (local)
    const parsed = new Date(custom);
    if(isNaN(parsed.getTime())){
      alert('Invalid date. Use a format your browser recognizes, or leave blank.');
      return;
    }
    newExpires = parsed.toISOString();
  } else {
    newExpires = new Date(Date.now() + 24*60*60*1000).toISOString();
  }

  try {
    notifResult.textContent = 'Republishing...';
    const res = await fetch(`${API_BASE}/admin/announcements/${encodeURIComponent(id)}/republish`, {
      method: 'POST',
      credentials: 'include',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ expiresAt: newExpires, createdAt: new Date().toISOString() })
    });
    const j = await res.json().catch(()=>null);
    if(res.ok && j && j.status === 'success'){
      notifResult.style.color = 'green'; notifResult.textContent = 'Republished.';
      await refreshAll();
    } else {
      notifResult.style.color = 'var(--danger)'; notifResult.textContent = (j && j.message) ? j.message : `Republish failed (${res.status})`;
    }
  } catch(err){
    console.error('republishAnnouncement', err);
    notifResult.style.color = 'var(--danger)'; notifResult.textContent = 'Network error while republishing';
  }
}

// clear inputs
function clearNotif(){
  document.getElementById('notifTitle').value='';
  document.getElementById('notifBody').value='';
  document.getElementById('notifTarget').value='all';
  document.getElementById('notifSchedule').value='';
  notifFile.value='';
  imgPreview.style.display='none';
  notifResult.textContent='';
}

// refresh active & history
async function refreshAll(){
  const [active, history] = await Promise.all([fetchActive(), fetchHistory()]);
  renderActive(active);
  renderHistory(history);
  // also update limitWarning visibility based on server count
  const activeCount = Array.isArray(active) ? active.length : 0;
  if(activeCount >= MAX_ACTIVE) limitWarning.style.display='block'; else limitWarning.style.display='none';
}

// init
(async function init(){
  await refreshAll();
  setInterval(async ()=> { await refreshAll(); }, 30000); // refresh every 30s
})();

</script>

</body>
</html>