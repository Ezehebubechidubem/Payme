<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Payme — Notifications</title>
<style>
 :root{
  --bg:#fff;--text:#000;--green:#10b981;--muted:#6b7280;--card:#f8fafb;
  --danger:#ef4444;
 }
 body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Arial}
 header{padding:18px;border-bottom:1px solid #f0f2f3}
 .container{padding:18px}
 .card{background:var(--card);padding:14px;border-radius:12px}
 input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;margin-top:8px}
 .btn{background:var(--green);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
 .muted{color:var(--muted)}
 .role-banner{margin:0 18px 12px;padding:8px;background:#f0fdf4;color:#065f46;border-radius:8px;font-weight:600}
 .img-preview{margin-top:8px}
 .img-preview img{max-width:260px;max-height:140px;border-radius:8px;display:block}
 .limit-warning{color:var(--danger);margin-top:8px}
 .carousel { margin-top:12px; position:relative; overflow:hidden; border-radius:12px; background:#fff; border:1px solid #eee; }
 .carousel-track { display:flex; transition:transform .45s ease; }
 .slide { min-width:100%; box-sizing:border-box; padding:12px; display:flex; gap:12px; align-items:center; }
 .slide img{width:160px;height:90px;object-fit:cover;border-radius:8px;flex:0 0 160px}
 .slide .text { flex:1 }
 .carousel-controls { position:absolute; left:8px; right:8px; top:50%; transform:translateY(-50%); display:flex; justify-content:space-between; pointer-events:none; }
 .carousel-controls button{pointer-events:auto; background:rgba(255,255,255,0.95); border:1px solid #eee; padding:6px 8px; border-radius:8px; cursor:pointer}
 .small-muted{color:var(--muted);font-size:13px}
 .history-item{padding:8px;border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; gap:8px}
 .history-meta{color:#6b7280;font-size:13px}
 .actions-col button{margin-bottom:6px;width:120px}
 .spinner {display:inline-block;width:14px;height:14px;border:2px solid rgba(0,0,0,0.1);border-top-color:#000;border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-left:8px}
 @keyframes spin{ to { transform: rotate(360deg);} }
</style>
</head>
<body>

<!-- AUTH CHECK (same as monitoring) -->
<script>
(async function(){
  const EXPECTED_ROLE = "notification";
  try {
    const res = await fetch("https://payme-update.onrender.com/auth/check", {
      method: "GET",
      credentials: "include",
      headers: {"Accept":"application/json"}
    });
    if(!res.ok){ window.location.href = "https://ezehebubechidubem.github.io/Payme/index.html"; return; }
    const data = await res.json();
    const serverRole = (data.role || data.user?.role || "").toString().toLowerCase();
    if(serverRole !== EXPECTED_ROLE){ window.location.href = "https://ezehebubechidubem.github.io/Payme/index.html"; return; }

    // show role banner
    const banner = document.createElement('div');
    banner.className = 'role-banner';
    banner.innerText = `Logged in as: ${serverRole.toUpperCase()}`;
    document.body.insertBefore(banner, document.querySelector('header').nextSibling);

    try { sessionStorage.setItem("staff_role", serverRole); } catch(e){}
  } catch(err){
    window.location.href = "https://ezehebubechidubem.github.io/Payme/index.html";
  }
})();
</script>

<header>
  <a href="https://ezehebubechidubem.github.io/Payme/index.html" style="color:#6b7280;text-decoration:none">← Dashboard</a>
  <h2 style="margin:6px 0">7 — Notifications & Announcements</h2>
  <div class="muted">Create announcements with images — they will appear on the main PayMe dashboard promo area.</div>
</header>

<div class="container">
  <div class="card">
    <h3 style="margin-top:0">Create Announcement</h3>

    <label for="notifTitle">Title</label>
    <input id="notifTitle" placeholder="Short headline" maxlength="120"/>

    <label for="notifBody">Message body</label>
    <textarea id="notifBody" rows="4" placeholder="Write the announcement message" maxlength="1000"></textarea>

    <div style="display:flex;gap:8px;margin-top:8px">
      <div style="flex:1">
        <label for="notifTarget">Target</label>
        <select id="notifTarget">
          <option value="all">All users</option>
          <option value="active">Active users</option>
          <option value="suspended">Suspended users</option>
          <option value="custom">Custom segment</option>
        </select>
      </div>
      <div style="flex:1">
        <label for="notifExpiry">Expiry (when announcement should stop showing)</label>
        <input id="notifExpiry" type="datetime-local" />
      </div>
    </div>

    <div style="margin-top:10px">
      <label style="display:block;font-weight:600;margin-bottom:6px">Attach image (optional)</label>
      <input id="notifyFile" type="file" accept="image/*"/>
      <div class="img-preview" id="imgPreview" style="display:none"><img id="imgPreviewImg" src="" alt="preview"/></div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="sendBtn" class="btn" onclick="sendNotification()">Send</button>
      <button style="padding:8px;border-radius:8px;border:1px solid #ddd;background:#fff" onclick="clearNotif()">Clear</button>
      <div id="sendStatus" style="margin-left:8px;color:var(--muted);align-self:center"></div>
    </div>

    <div id="limitWarning" class="limit-warning" style="display:none">Max 10 active announcements reached. Delete or republish in history to create more.</div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3 style="margin-top:0">Active Announcements (Preview)</h3>
    <div id="carouselWrap">
      <div id="carousel" class="carousel" style="display:none">
        <div id="carouselTrack" class="carousel-track"></div>
        <div class="carousel-controls">
          <button id="prevBtn" aria-label="Previous">◀</button>
          <button id="nextBtn" aria-label="Next">▶</button>
        </div>
      </div>
      <div id="noActive" class="small-muted">No active announcements</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3 style="margin-top:0">Previous Announcements (History)</h3>
    <div id="history"></div>
  </div>
</div>

<script>
const API_BASE = "https://payme-update.onrender.com";
const MAX_ACTIVE = 10;

// utility
function el(id){ return document.getElementById(id); }
function nowISO(){ return new Date().toISOString(); }
function uid(){ return 'N' + Math.floor(Math.random()*900000 + 1000); }
function showMsg(msg, targetId='sendStatus'){ el(targetId).textContent = msg; }

// preview image
const fileInput = el('notifyFile');
const imgPreview = el('imgPreview');
const imgPreviewImg = el('imgPreviewImg');
fileInput?.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f){ imgPreview.style.display='none'; imgPreviewImg.src=''; return; }
  const r = new FileReader();
  r.onload = ()=>{ imgPreviewImg.src = r.result; imgPreview.style.display='block'; };
  r.readAsDataURL(f);
});

// Fetch active announcements (for preview)
async function fetchActive(){
  try {
    const res = await fetch(`${API_BASE}/admin/announcements/active`, { credentials: 'include', cache: 'no-store' });
    if(!res.ok) throw new Error('no active endpoint');
    const list = await res.json();
    // server may return array directly
    return Array.isArray(list) ? list : (list.announcements || list.data || []);
  } catch(e){
    // try alternate endpoint (non-admin) for dashboard compatibility
    try {
      const res2 = await fetch(`${API_BASE}/announcements/active`, { credentials: 'include', cache: 'no-store' });
      if(!res2.ok) throw new Error('no alt endpoint');
      const list2 = await res2.json();
      return Array.isArray(list2) ? list2 : (list2.announcements || list2.data || []);
    } catch(err){ console.warn('fetchActive failed', err); return []; }
  }
}

// Fetch history (staff)
async function fetchHistory(){
  try {
    const res = await fetch(`${API_BASE}/admin/announcements`, { credentials:'include', cache:'no-store' });
    if(!res.ok) throw new Error('history unauthorized');
    const json = await res.json();
    // our admin route returns {status: "success", announcements: [...]}
    return json.announcements || json.data || [];
  } catch(e){
    console.warn('fetchHistory failed', e);
    return [];
  }
}

// render active preview carousel
let carouselIndex = 0;
let carouselTimer = null;
function renderActive(list){
  const carousel = el('carousel');
  const track = el('carouselTrack');
  const noActive = el('noActive');
  const limitWarning = el('limitWarning');

  if(!list || list.length === 0){
    carousel.style.display = 'none';
    noActive.style.display = 'block';
    limitWarning.style.display = 'none';
    return;
  }

  // enforce client-side limit note
  if(list.length >= MAX_ACTIVE) limitWarning.style.display = 'block';
  else limitWarning.style.display = 'none';

  track.innerHTML = list.map(a => {
    const img = a.image_url ? `<img src="${escapeHtml(a.image_url)}" alt="">` : `<div style="width:160px;height:90px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;color:#9ca3af">No image</div>`;
    const created = a.createdAt ? (new Date(a.createdAt)).toLocaleString() : '';
    return `<div class="slide" data-id="${escapeHtml(a.id || '')}">
      ${img}
      <div class="text">
        <div style="font-weight:800">${escapeHtml(a.title || '')}</div>
        <div class="small-muted" style="margin-top:6px">${escapeHtml(a.target || '')} • ${created}</div>
        <div style="margin-top:8px">${escapeHtml(a.body || '')}</div>
      </div>
    </div>`;
  }).join('');

  carousel.style.display = 'block';
  noActive.style.display = 'none';
  carouselIndex = 0;
  updateCarouselTransform();

  if(carouselTimer) clearInterval(carouselTimer);
  if(list.length > 1){
    carouselTimer = setInterval(()=> {
      carouselIndex = (carouselIndex + 1) % list.length;
      updateCarouselTransform();
    }, 4000);
  }
}
function updateCarouselTransform(){
  const track = el('carouselTrack');
  track.style.transform = `translateX(-${carouselIndex * 100}%)`;
}
el('prevBtn')?.addEventListener('click', ()=>{ carouselIndex = Math.max(0, carouselIndex-1); updateCarouselTransform(); clearInterval(carouselTimer); });
el('nextBtn')?.addEventListener('click', ()=>{ carouselIndex = carouselIndex+1; updateCarouselTransform(); clearInterval(carouselTimer); });

// render history (staff)
function renderHistory(list){
  const container = el('history');
  if(!list || list.length === 0){ container.innerHTML = '<div class="small-muted">No announcements yet</div>'; return; }
  container.innerHTML = list.map(a => {
    const img = a.image_url ? `<img src="${escapeHtml(a.image_url)}" style="width:120px;height:70px;object-fit:cover;border-radius:6px;margin-right:8px">` : '';
    const created = a.createdAt ? new Date(a.createdAt).toLocaleString() : '';
    const expires = a.expiresAt ? new Date(a.expiresAt).toLocaleString() : '—';
    return `<div class="history-item" data-id="${escapeHtml(a.id)}">
      <div style="display:flex;align-items:center;gap:12px;flex:1">
        ${img}
        <div>
          <strong>${escapeHtml(a.title || '(no title)')}</strong>
          <div class="history-meta">${escapeHtml(a.target || 'All')} • ${created} • Expires: ${expires}</div>
          <div style="margin-top:6px">${escapeHtml(a.body || '')}</div>
        </div>
      </div>
      <div class="actions-col" style="display:flex;flex-direction:column;align-items:flex-end">
        <button onclick="republishAnnouncement('${escapeJs(a.id)}')" style="padding:6px;border-radius:6px;border:1px solid #ddd;background:#fff">Republish</button>
        <button onclick="deleteAnnouncement('${escapeJs(a.id)}')" style="padding:6px;border-radius:6px;background:var(--danger);color:#fff;border:0">Permanent Delete</button>
      </div>
    </div>`;
  }).join('');
}

// helpers to escape
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }
function escapeJs(s){ return String(s||'').replace(/'/g, "\\'"); }

// check how many active announcements exist (server-side authoritative)
async function countActiveServer(){
  try {
    const res = await fetch(`${API_BASE}/admin/announcements?active=1`, { credentials:'include', cache:'no-store' });
    if(!res.ok) return 0;
    const json = await res.json();
    const arr = json.announcements || [];
    return Array.isArray(arr) ? arr.length : 0;
  } catch(e){ return 0; }
}

// send announcement to backend
async function sendNotification(){
  const title = el('notifTitle').value.trim();
  const body = el('notifBody').value.trim();
  const target = el('notifTarget').value;
  const expiryRaw = el('notifExpiry').value; // datetime-local string or empty
  const file = el('notifyFile').files[0];
  const sendBtn = el('sendBtn');

  if(!title || !body){ alert('Title and body are required'); return; }

  // check active count
  const activeCount = await countActiveServer();
  if(activeCount >= MAX_ACTIVE){
    el('limitWarning').style.display = 'block';
    showMsg('Cannot create: 10 active announcements already.');
    return;
  } else {
    el('limitWarning').style.display = 'none';
  }

  // prepare data
  const form = new FormData();
  form.append('title', title);
  form.append('body', body);
  form.append('target', target);

  // if user provided expiry, send that ISO; otherwise set default to 24h ahead
  let expiresAt = null;
  if(expiryRaw){
    // convert local datetime to ISO (server will interpret)
    const dt = new Date(expiryRaw);
    expiresAt = dt.toISOString();
  } else {
    expiresAt = new Date(Date.now() + 24*60*60*1000).toISOString();
  }
  form.append('expiresAt', expiresAt);
  form.append('createdAt', new Date().toISOString());

  if(file) form.append('image', file);

  // UI
  sendBtn.disabled = true;
  sendBtn.textContent = 'Sending';
  const spinner = document.createElement('span'); spinner.className = 'spinner';
  sendBtn.appendChild(spinner);
  showMsg('');

  try {
    const res = await fetch(`${API_BASE}/admin/announcements`, {
      method: 'POST',
      credentials: 'include',
      body: form
    });
    const json = await res.json().catch(()=>null);
    if(res.ok && json && json.status === 'success'){
      showMsg('Announcement created and stored on server.');
      // refresh active and history views
      await refreshAllViews();
      // clear form
      clearNotif();
    } else {
      const message = (json && (json.message || json.error)) || `Server error (${res.status})`;
      showMsg(message);
    }
  } catch(err){
    console.error('sendNotification error', err);
    showMsg('Network or server error. Announcement not saved.');
  } finally {
    sendBtn.disabled = false;
    sendBtn.textContent = 'Send';
  }
}

// delete announcement (permanent)
async function deleteAnnouncement(id){
  if(!confirm('Permanent delete this announcement? This cannot be undone.')) return;
  showMsg('Deleting...');
  try {
    const res = await fetch(`${API_BASE}/admin/announcements/${encodeURIComponent(id)}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    if(res.ok){
      showMsg('Deleted.');
      await refreshAllViews();
    } else {
      const json = await res.json().catch(()=>null);
      showMsg((json && json.message) || 'Delete failed');
    }
  } catch(err){
    console.error('deleteAnnouncement error', err);
    showMsg('Network error while deleting');
  }
}

// republish: set new expiry = now + 24h unless user chooses custom
async function republishAnnouncement(id){
  const custom = prompt('Enter new expiry datetime (YYYY-MM-DD HH:MM) or leave blank for +24 hours from now:','');
  let newExpiry = null;
  if(custom){
    // try parse
    const parsed = new Date(custom);
    if(isNaN(parsed.getTime())){
      alert('Invalid date format. Use e.g. 2025-12-01 14:30 or leave blank.');
      return;
    }
    newExpiry = parsed.toISOString();
  } else {
    newExpiry = new Date(Date.now() + 24*60*60*1000).toISOString();
  }

  showMsg('Republishing...');
  try {
    const res = await fetch(`${API_BASE}/admin/announcements/${encodeURIComponent(id)}/republish`, {
      method: 'POST',
      credentials: 'include',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ expiresAt: newExpiry, createdAt: new Date().toISOString() })
    });
    if(res.ok){
      showMsg('Republished.');
      await refreshAllViews();
    } else {
      const json = await res.json().catch(()=>null);
      showMsg((json && json.message) || 'Republish failed');
    }
  } catch(err){
    console.error('republishAnnouncement', err);
    showMsg('Network error while republishing');
  }
}

// clear form
function clearNotif(){
  el('notifTitle').value = '';
  el('notifBody').value = '';
  el('notifTarget').value = 'all';
  el('notifExpiry').value = '';
  el('notifyFile').value = '';
  imgPreview.style.display = 'none';
  showMsg('');
}

// refresh active + history
async function refreshAllViews(){
  // active
  const active = await fetchActiveForUI();
  renderActive(active);
  // history
  const hist = await fetchHistory();
  renderHistory(hist);
}

// helper to fetch active announcements for UI (tries both /admin and /announcements)
async function fetchActiveForUI(){
  try {
    const res = await fetch(`${API_BASE}/admin/announcements/active`, { credentials:'include', cache:'no-store' });
    if(res.ok){ const arr = await res.json(); return Array.isArray(arr) ? arr : (arr.announcements || arr.data || []); }
  } catch(e){}
  try {
    const res2 = await fetch(`${API_BASE}/announcements/active`, { credentials:'include', cache:'no-store' });
    if(res2.ok){ const arr2 = await res2.json(); return Array.isArray(arr2) ? arr2 : (arr2.announcements || arr2.data || []); }
  } catch(e){}
  return [];
}

// initial load
(async function init(){
  await refreshAllViews();
  // refresh active list every 30s to reflect changes
  setInterval(async ()=>{ const active = await fetchActiveForUI(); renderActive(active); }, 30000);
})();

</script>

</body>
</html>