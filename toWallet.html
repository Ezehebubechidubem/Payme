<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ToWallet</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f4f6f8;margin:0;padding:20px}
    .container{max-width:480px;margin:auto;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);padding:18px}
    h2{text-align:center;margin-bottom:14px;color:#00c853}
    label{font-size:13px;font-weight:700;margin-bottom:6px;display:block}
    input,select,button{padding:10px;margin-bottom:12px;border:1px solid #ccc;border-radius:8px;font-size:14px}
    input[type="text"], input[type="number"]{width:100%}
    button{background:#00c853;color:#fff;border:none;cursor:pointer;font-weight:700}
    button:hover{background:#009624}
    .hidden{display:none}
    .info{background:#e8f5e9;padding:10px;border-radius:8px;margin-bottom:12px}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:8px}
    /* search input + delete button inline */
    .search-inline{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .search-inline input{flex:1;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:14px}
    .del-btn{width:46px;height:42px;border-radius:8px;background:#e0e0e0;border:none;cursor:pointer;font-weight:700}
    .del-btn:active{transform:translateY(1px)}
    /* Dropdown modal (mobile-style) */
    .bank-modal {
      position: fixed;
      left: 6%;
      right: 6%;
      top: 8%;
      bottom: 8%;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.3);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .bank-modal-header {
      padding: 12px 14px;
      border-bottom: 1px solid #eee;
      display:flex;
      gap:8px;
      align-items:center;
      background: #fff7f5;
    }
    .bank-modal-title { font-weight:700; font-size:16px; color:#333; flex:1; }
    .bank-modal-close { background:none;border:none;font-size:18px; cursor:pointer; padding:6px 10px; border-radius:8px; }
    .bank-list { overflow:auto; padding:6px 0; flex:1; background: #fff7f5; }
    .bank-item {
      padding:16px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(0,0,0,0.05);
      cursor:pointer;
    }
    .bank-item .name { font-size:16px; color:#111; }
    .bank-item .code { color:#666; font-size:14px; margin-left:8px; }
    .radio {
      width:22px;height:22px;border-radius:50%;border:2px solid #ccc;display:inline-block;flex-shrink:0;
      background:white;
    }
    .radio.selected { border-color:#00c853; background:#00c853; box-shadow:0 0 0 4px rgba(0,200,83,0.08); }

    /* Popup for transfer result */
    .transfer-popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 12000;
      padding: 18px;
    }
    .transfer-popup-overlay.show { display:flex; }
    .transfer-popup {
      width: 100%;
      max-width: 760px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .transfer-popup .head { padding: 26px 18px 6px; text-align:center; }
    .transfer-badge { width:80px;height:80px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;color:#fff;font-size:36px;margin-bottom:12px }
    .transfer-badge.success { background: linear-gradient(135deg,#00c853,#43a047); }
    .transfer-badge.fail { background: linear-gradient(135deg,#e53935,#d32f2f); }
    .transfer-popup .big-amount { font-weight:700;font-size:28px;margin-bottom:6px }
    .transfer-status { display:inline-block;padding:8px 12px;border-radius:8px;background:#e8f5e9;color:#007a3a;margin-bottom:10px }
    .transfer-status.fail { background:#fdecea;color:#d32f2f }
    .transfer-body { padding: 10px 18px 18px; }
    .tx-row { display:flex;justify-content:space-between;padding:10px 12px;border-radius:8px;background:#fafafa;margin-bottom:8px }
    .tx-row .label { color:#666 }
    .tx-actions { padding: 12px 18px; display:flex; gap:12px; justify-content:flex-end; background:#fff; border-top:1px solid #f0f0f0 }
    .btn-outline { padding:10px 14px;border-radius:8px;border:1px solid #ddd;background:#fff; cursor:pointer }
    .btn-primary { padding:10px 14px;border-radius:8px;border:0;background:#00c853;color:#fff; cursor:pointer }
    .btn-cancel { padding:10px 14px;border-radius:8px;border:0;background:#e53935;color:#fff; cursor:pointer }

    @media(min-width:700px){
      .bank-modal { left:25%; right:25%; top:10%; bottom:10%; }
      .transfer-popup { max-width:700px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Transfer Money</h2>

    <label for="accountNumber">Receiver Account Number</label>
    <input id="accountNumber" type="text" maxlength="10" placeholder="Enter 10-digit account" />

    <div id="bankSection" class="hidden">
      <label for="bankSelect">Select Bank</label>

      <!-- Visible horizontal search input with delete button -->
      <div class="search-inline">
        <input id="bankSearchMain" type="text" placeholder="Type bank name or code (e.g. 'P' or '044')" aria-label="Search banks"/>
        <button id="bankDeleteBtn" class="del-btn" title="Delete last character">⌫</button>
      </div>

      <!-- Visible custom dropdown toggle -->
      <button id="bankToggle" type="button">--Choose Bank--</button>
      <!-- hidden input used as the "bankSelect" value so existing change handler still works -->
      <input id="bankSelect" type="hidden" value="" />

      <div id="bankNote" class="muted">Loading banks…</div>
    </div>

    <div id="receiverSection" class="hidden">
      <!-- Changed label to "Receive Name:" and show only the name -->
      <div class="info">
        <div><strong>Receive Name:</strong></div>
        <div style="margin-top:8px;">
          <input id="receiverName" type="text" readonly style="width:100%;border:none;background:transparent;font-weight:600;font-size:15px" />
        </div>
      </div>
    </div>

    <div id="amountSection" class="hidden">
      <label for="amount">Amount (₦)</label>
      <input id="amount" type="number" placeholder="Enter amount" />
    </div>

    <div id="sendSection" class="hidden">
      <button id="sendBtn">Send Money</button>
    </div>
  </div>

  <!-- Bank modal -->
  <div id="bankModal" class="hidden" aria-hidden="true">
    <div class="bank-modal">
      <div class="bank-modal-header">
        <div class="bank-modal-title">--Choose Bank--</div>
        <button id="bankModalClose" class="bank-modal-close" aria-label="Close">✕</button>
      </div>

      <!-- Modal has a compact search input (no buttons) to mirror main input -->
      <div style="padding:10px;background:#fff7f5;border-bottom:1px solid #f0e7e6;">
        <div class="search-inline" style="margin:0">
          <input id="bankSearch" class="" type="text" placeholder="Search banks by name or code" />
          <button id="bankDeleteModalBtn" class="del-btn" title="Delete last character">⌫</button>
        </div>
      </div>

      <div id="bankList" class="bank-list" role="listbox" tabindex="0"></div>
    </div>
  </div>

  <!-- Transfer result popup (success or fail) -->
  <div id="transferPopup" class="transfer-popup-overlay" aria-hidden="true">
    <div class="transfer-popup" role="dialog" aria-modal="true">
      <div class="head">
        <div id="popupBadge" class="transfer-badge success">₦</div>
        <div id="popupLabel" style="color:#777;margin-bottom:8px">Money received</div>
        <div id="popupAmount" class="big-amount">₦0.00</div>
        <div id="popupStatus" class="transfer-status">Successful</div>
      </div>
      <div class="transfer-body">
        <div class="tx-row"><div class="label">Order amount</div><div id="tx_order">₦0.00</div></div>
        <div class="tx-row"><div class="label">Date/Time</div><div id="tx_datetime">-</div></div>
        <div class="tx-row"><div class="label">Sender</div><div id="tx_sender">-</div></div>
        <div class="tx-row"><div class="label">Sender Account</div><div id="tx_sender_acc">-</div></div>
        <div class="tx-row"><div class="label">Bank Name</div><div id="tx_bank_name">-</div></div>
        <div class="tx-row"><div class="label">Recipient</div><div id="tx_recipient">-</div></div>
        <div class="tx-row"><div class="label">Recipient Account</div><div id="tx_recipient_acc">-</div></div>
        <div class="tx-row"><div class="label">Transaction NO.</div><div id="tx_no">-</div></div>
      </div>
      <div class="tx-actions">
        <button id="viewTransactionsBtn" class="btn-outline">View Transactions</button>
        <button id="cancelPopupBtn" class="btn-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Backend base url (kept same as before)
    const BACKEND_URL = "https://payme-update.onrender.com";

    // DOM
    const accountInput = document.getElementById("accountNumber");
    const bankSection = document.getElementById("bankSection");
    const bankToggle = document.getElementById("bankToggle");
    const bankSelect = document.getElementById("bankSelect"); // hidden input
    const bankNote = document.getElementById("bankNote");
    const receiverSection = document.getElementById("receiverSection");
    const receiverName = document.getElementById("receiverName");
    const amountSection = document.getElementById("amountSection");
    const sendSection = document.getElementById("sendSection");
    const sendBtn = document.getElementById("sendBtn");

    // modal & search elements
    const bankModal = document.getElementById("bankModal");
    const bankModalClose = document.getElementById("bankModalClose");
    const bankList = document.getElementById("bankList");
    const bankSearch = document.getElementById("bankSearch");
    const bankSearchMain = document.getElementById("bankSearchMain");
    const bankDeleteBtn = document.getElementById("bankDeleteBtn");
    const bankDeleteModalBtn = document.getElementById("bankDeleteModalBtn");

    // transfer popup elements
    const transferPopup = document.getElementById("transferPopup");
    const popupBadge = document.getElementById("popupBadge");
    const popupLabel = document.getElementById("popupLabel");
    const popupAmount = document.getElementById("popupAmount");
    const popupStatus = document.getElementById("popupStatus");
    const tx_order = document.getElementById("tx_order");
    const tx_datetime = document.getElementById("tx_datetime");
    const tx_sender = document.getElementById("tx_sender");
    const tx_sender_acc = document.getElementById("tx_sender_acc");
    const tx_bank_name = document.getElementById("tx_bank_name");
    const tx_recipient = document.getElementById("tx_recipient");
    const tx_recipient_acc = document.getElementById("tx_recipient_acc");
    const tx_no = document.getElementById("tx_no");
    const viewTransactionsBtn = document.getElementById("viewTransactionsBtn");
    const cancelPopupBtn = document.getElementById("cancelPopupBtn");

    let currentAccount = "";
    let fullBankList = []; // canonical [{code,name}]
    let receiverUsername = ""; // name from resolve
    // current user read from localStorage (unchanged)
    const currentUser = JSON.parse(localStorage.getItem("loggedInUser")) || JSON.parse(localStorage.getItem("user"));

    // lightweight no-op dbg
    function dbg(){}

    // render bank list items
    function renderBankItems(list){
      bankList.innerHTML = "";
      if (!list || list.length === 0) {
        const el = document.createElement("div");
        el.className = "bank-item";
        el.style.justifyContent = "center";
        el.textContent = "No banks found";
        bankList.appendChild(el);
        return;
      }

      list.forEach(b => {
        const code = String(b.code || "").trim();
        const name = (b.name || b.bank || b.bank_name || "").trim();
        if (!code) return;
        const row = document.createElement("div");
        row.className = "bank-item";
        row.setAttribute("role","option");
        row.dataset.code = code;
        row.dataset.name = name;

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        const title = document.createElement("div");
        title.className = "name";
        title.textContent = name;
        const sub = document.createElement("div");
        sub.className = "code";
        sub.textContent = `(${code})`;
        left.appendChild(title);
        left.appendChild(sub);

        const radio = document.createElement("div");
        radio.className = "radio";
        if (bankSelect.value && bankSelect.value === code) radio.classList.add("selected");

        row.appendChild(left);
        row.appendChild(radio);

        row.addEventListener("click", () => {
          bankToggle.textContent = `${name} (${code})`;
          bankSelect.value = code;
          const prev = bankList.querySelector(".radio.selected");
          if (prev) prev.classList.remove("selected");
          radio.classList.add("selected");
          closeBankModal();
          bankSelect.dispatchEvent(new Event('change', { bubbles: true }));
        });

        bankList.appendChild(row);
      });
    }

    // filter banks
    function filterBanks(query){
      if (!query) {
        renderBankItems(fullBankList);
        return;
      }
      const q = String(query).trim().toLowerCase();
      const filtered = fullBankList.filter(b => {
        const name = (b.name || "").toLowerCase();
        const code = (b.code || "").toLowerCase();
        return name.indexOf(q) !== -1 || code.indexOf(q) !== -1;
      });
      renderBankItems(filtered);
    }

    function openBankModal(){
      bankModal.classList.remove("hidden");
      bankModal.setAttribute("aria-hidden","false");
      setTimeout(()=>bankSearch.focus(), 120);
    }
    function closeBankModal(){
      bankModal.classList.add("hidden");
      bankModal.setAttribute("aria-hidden","true");
    }

    bankToggle.addEventListener("click", () => openBankModal());
    bankModalClose.addEventListener("click", () => closeBankModal());
    bankModal.addEventListener("click", (e) => { if (e.target === bankModal) closeBankModal(); });

    // keep main and modal search in sync
    bankSearch.addEventListener("input", () => {
      bankSearchMain.value = bankSearch.value;
      filterBanks(bankSearch.value);
    });
    bankSearchMain.addEventListener("input", () => {
      if (bankModal.classList.contains("hidden")) openBankModal();
      bankSearch.value = bankSearchMain.value;
      filterBanks(bankSearchMain.value);
    });
    bankSearchMain.addEventListener("focus", () => {
      if (bankModal.classList.contains("hidden")) openBankModal();
      bankSearch.value = bankSearchMain.value;
      filterBanks(bankSearchMain.value);
    });

        // delete last char behaviour for modal input
    bankDeleteModalBtn.addEventListener("click", () => {
      bankSearch.value = bankSearch.value.slice(0, -1);
      bankSearchMain.value = bankSearch.value;
      filterBanks(bankSearch.value);
      bankSearch.focus();
    });

    // load banks
    async function loadBanks(){
      bankNote.textContent = "Loading banks…";
      try {
        const res = await fetch(`${BACKEND_URL}/banks`, { method: "GET" , cache: "no-store" });
        if (!res.ok) throw new Error("Banks endpoint returned " + res.status);
        const data = await res.json();

        const normalized = [];

        if (data && Array.isArray(data.banks)) {
          data.banks.forEach(b => {
            const code = String(b.code || "").trim();
            const name = b.name || b.bank || b.bank_name || "";
            if (!code) return;
            normalized.push({ code, name });
          });
        } else if (data && data.banks && typeof data.banks === "object" && !Array.isArray(data.banks)) {
          const mapping = data.banks;
          Object.keys(mapping).forEach(code => {
            const name = mapping[code] || "";
            normalized.push({ code: String(code).trim(), name: String(name).trim() });
          });
        } else if (data && typeof data === "object" && !Array.isArray(data) && !data.banks) {
          const keys = Object.keys(data);
          const isMapping = keys.length > 0 && keys.every(k => typeof data[k] === "string");
          if (isMapping) {
            keys.forEach(code => {
              normalized.push({ code: String(code).trim(), name: String(data[code]).trim() });
            });
          }
        } else if (data && data.data && Array.isArray(data.data)) {
          data.data.forEach(b => {
            const code = String(b.code || "").trim();
            const name = b.name || "";
            if (!code) return;
            normalized.push({ code, name });
          });
        }

        if (normalized.length === 0) throw new Error("Invalid banks payload");

        fullBankList = normalized;
        renderBankItems(fullBankList);
        bankNote.textContent = "Banks loaded from backend.";
      } catch (err) {
        const fallback = {
          "000004":"UNITED BANK FOR AFRICA",
          "000013":"GUARANTY TRUST BANK",
          "000014":"ZENITH BANK",
          "000015":"UNION BANK",
          "000012":"FIRST BANK OF NIGERIA"
        };
        fullBankList = Object.keys(fallback).map(code => ({ code: String(code).trim(), name: fallback[code] }));
        renderBankItems(fullBankList);
        bankNote.textContent = "Using fallback bank list (backend unreachable).";
      }
    }

    loadBanks();

    // sanitize account input to digits only and show banks when length==10
    accountInput.addEventListener("input", function(){
      const digits = this.value.replace(/\D/g,'');
      if (this.value !== digits) this.value = digits;
      if (this.value.length === 10) {
        currentAccount = this.value;
        bankSection.classList.remove("hidden");
      } else {
        bankSection.classList.add("hidden");
        receiverSection.classList.add("hidden");
        amountSection.classList.add("hidden");
        sendSection.classList.add("hidden");
      }
    });

    // Resolve account using POST /resolve-account (unchanged)
    async function resolveAccountPOST(account, bankCode) {
      try {
        const res = await fetch(`${BACKEND_URL}/resolve-account`, {
          method: "POST",
          headers: {"Content-Type":"application/json","Accept":"application/json"},
          body: JSON.stringify({account_number: account, bank_code: bankCode})
        });
        const body = await res.json().catch(()=>null);
        return { httpStatus: res.status, body };
      } catch (err) {
        return { httpStatus: 0, body: null, error: String(err) };
      }
    }

    // Helper to extract account name from various backend shapes (unchanged)
    function extractAccountName(payload) {
      if (!payload) return null;
      if (payload.account_name) return payload.account_name;
      if (payload.accountName) return payload.accountName;
      if (payload.accountname) return payload.accountname;

      if (payload.data && typeof payload.data === "object") {
        const d = payload.data;
        if (d.account_name) return d.account_name;
        if (d.accountName) return d.accountName;
        if (d.accountname) return d.accountname;
        if (d.data && typeof d.data === "object") {
          if (d.data.account_name) return d.data.account_name;
          if (d.data.accountName) return d.data.accountName;
        }
      }

      if (payload.raw && typeof payload.raw === "object") {
        const r = payload.raw;
        if (r.data && typeof r.data === "object") {
          if (r.data.account_name) return r.data.account_name;
          if (r.data.accountName) return r.data.accountName;
        }
        if (r.account_name) return r.account_name;
        if (r.message && typeof r.message === "string") return null;
      }
      return null;
    }

    // On bank selection attempt resolve
    bankSelect.addEventListener("change", async function(){
      const bankCode = this.value;
      receiverSection.classList.remove("hidden");
      receiverName.value = "";
      amountSection.classList.add("hidden");
      sendSection.classList.add("hidden");

      if (!bankCode) {
        receiverSection.classList.add("hidden");
        return;
      }
      if (!currentAccount || currentAccount.length !== 10) {
        receiverName.value = "Enter a valid 10-digit account first";
        return;
      }

      receiverName.value = "Verifying…";

      const result = await resolveAccountPOST(currentAccount, bankCode);

      // network error
      if (result.httpStatus === 0) {
        receiverName.value = "Network error when contacting backend";
        return;
      }

      const payload = result.body || {};

      // Successful generic response -> show only name (Receive Name:)
      if (result.httpStatus === 200 && payload.status === "success") {
        const acctName = extractAccountName(payload) || extractAccountName(payload.data) || extractAccountName(payload.raw) || "";
        receiverUsername = acctName || "";
        receiverName.value = acctName || "Name not provided";
        amountSection.classList.remove("hidden");
        sendSection.classList.remove("hidden");
        return;
      }

      // Some backends return 200 with nested success shape (older versions)
      if (result.httpStatus === 200 && payload && payload.data && (payload.data.account_name || (payload.data.data && payload.data.data.account_name))) {
        const acctName = extractAccountName(payload.data);
        receiverUsername = acctName || "";
        receiverName.value = acctName || "Name not provided";
        amountSection.classList.remove("hidden");
        sendSection.classList.remove("hidden");
        return;
      }

      // handle common failure patterns (friendly message)
      let msg = "Account not found or verification failed";
      if (payload && payload.message) msg = payload.message;
      else if (payload && payload.error) msg = payload.error;
      else if (payload && payload.details) msg = payload.details;

      receiverName.value = "❌ " + msg;
    });

    // NEW: fetch balance from backend (same pattern as PAYME page)
    async function fetchBalance() {
      if (!currentUser || !currentUser.phone) return 0;
      try {
        const res = await fetch(`${BACKEND_URL}/balance/${currentUser.phone}`);
        const data = await res.json().catch(()=>null);
        if (res.ok && data && (data.balance !== undefined)) {
          localStorage.setItem("balance", data.balance);
          return parseFloat(data.balance);
        }
      } catch (e) {
        dbg("fetchBalance error", e);
      }
      return parseFloat(localStorage.getItem("balance")) || 0;
    }

    // Transfer result popup controls
    function showTransferPopup(opts = {}) {
      const { success=true, amount=0, statusText='', senderName='', senderAcc='', bankName='', recipient='', recipientAcc='', txno='' } = opts;
      transferPopup.classList.add('show');
      transferPopup.setAttribute('aria-hidden','false');
      popupBadge.className = 'transfer-badge ' + (success ? 'success' : 'fail');
      popupLabel.textContent = success ? 'Money received' : 'Transfer';
      popupAmount.textContent = (amount ? '₦' + Number(amount).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) : '₦0.00');
      popupStatus.className = 'transfer-status' + (success ? '' : ' fail');
      popupStatus.textContent = success ? (statusText || 'Successful') : (statusText || 'Failed');

      tx_order.textContent = (amount ? '₦' + Number(amount).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) : '₦0.00');
      tx_datetime.textContent = new Date().toLocaleString();
      tx_sender.textContent = senderName || (currentUser && (currentUser.name || currentUser.username)) || '-';
      tx_sender_acc.textContent = senderAcc || (currentUser && (currentUser.phone || currentUser.account_number)) || '-';
      tx_bank_name.textContent = bankName || '-';
      tx_recipient.textContent = recipient || '-';
      tx_recipient_acc.textContent = recipientAcc || '-';
      tx_no.textContent = txno || '-';
    }
    function hideTransferPopup() {
      transferPopup.classList.remove('show');
      transferPopup.setAttribute('aria-hidden','true');
    }
    viewTransactionsBtn.addEventListener('click', () => {
      hideTransferPopup();
      window.location.href = 'transactions.html';
    });
    cancelPopupBtn.addEventListener('click', () => hideTransferPopup());

    // Send money (real: POST to backend, update localStorage transactions & balance)
    sendBtn.addEventListener("click", async function(){
      const amountEl = document.getElementById("amount");
      const amount = Number(amountEl.value);
      const bankCode = bankSelect.value;
      const acct = currentAccount;

      if (!acct || acct.length !== 10) {
        await showSimplePopup("Enter a valid 10-digit receiver account first", "error");
        return;
      }
      if (!bankCode) {
        await showSimplePopup("Please select a bank.", "error");
        return;
      }
      if (!amount || Number.isNaN(amount) || amount <= 0) {
        await showSimplePopup("Enter a valid amount", "error");
        return;
      }

      // remove "you cannot send to myself" check (per your request)

      // Determine internal (PayMe) bank by exact code '00023'
      const isInternal = String(bankCode).trim() === "00023";

      const balance = await fetchBalance();
      if (amount > balance) {
        await showSimplePopup("Insufficient funds.", "error");
        return;
      }

      try {
        const res = await fetch(`${BACKEND_URL}/send_money`, {
          method: "POST",
          headers: {"Content-Type":"application/json","Accept":"application/json"},
          body: JSON.stringify({
            sender_phone: (currentUser && currentUser.phone) || null,
            receiver_acc: acct,
            amount: amount,
            receiver_bank: bankCode,
            is_internal: isInternal // hint to backend if needed
          })
        });
        const body = await res.json().catch(()=>null);

        if (res.ok && body && (body.status === "success" || body.success === true)) {
          // update local user balance (deduct amount)
          let user = JSON.parse(localStorage.getItem("loggedInUser"));
          if (!user) user = JSON.parse(localStorage.getItem("user")) || {};
          try {
            user.balance = parseFloat(balance) - parseFloat(amount);
          } catch(e) {
            user.balance = user.balance ? (user.balance - amount) : null;
          }
          localStorage.setItem("loggedInUser", JSON.stringify(user));
          localStorage.setItem("user", JSON.stringify(user));

          // save transaction locally
          let transactions = JSON.parse(localStorage.getItem("transactions")) || [];
          transactions.push({
            type: "Transfer Out",
            amount: amount,
            description: "Transfer to " + (receiverUsername || acct) + " (" + bankCode + ")",
            date: new Date().toLocaleString(),
            backend_id: body && (body.transaction_id || body.tx_id || body.id) ? (body.transaction_id || body.tx_id || body.id) : null,
            internal: isInternal
          });
          localStorage.setItem("transactions", JSON.stringify(transactions));

          // Show transfer result popup (fits screen). bankName should be full name if available.
          const bankName = (fullBankList.find(b=>String(b.code)===String(bankCode))||{}).name || bankCode;
          showTransferPopup({
            success: true,
            amount: amount,
            statusText: body && (body.message || body.msg) ? (body.message || body.msg) : "Successful",
            senderName: (currentUser && (currentUser.name || currentUser.username)) || '',
            senderAcc: (currentUser && (currentUser.phone || currentUser.account_number)) || '',
            bankName: bankName,
            recipient: receiverUsername || '',
            recipientAcc: acct,
            txno: (body && (body.transaction_id || body.tx_id || body.id)) || '-'
          });

          // clear amount (leave other fields as requested)
          amountEl.value = "";

        } else {
          const msg = (body && (body.message || body.error || body.msg)) ? (body.message || body.error || body.msg) : "Transfer failed.";
          showTransferPopup({
            success: false,
            amount: amount,
            statusText: msg,
            senderName: (currentUser && (currentUser.name || currentUser.username)) || '',
            senderAcc: (currentUser && (currentUser.phone || currentUser.account_number)) || '',
            bankName: (fullBankList.find(b=>String(b.code)===String(bankCode))||{}).name || bankCode,
            recipient: receiverUsername || '',
            recipientAcc: acct,
            txno: '-'
          });
        }
      } catch (err) {
        dbg("send error", err);
        showTransferPopup({
          success: false,
          amount: amount,
          statusText: "Network error connecting to server.",
          senderName: (currentUser && (currentUser.name || currentUser.username)) || '',
          senderAcc: (currentUser && (currentUser.phone || currentUser.account_number)) || '',
          bankName: (fullBankList.find(b=>String(b.code)===String(bankCode))||{}).name || bankCode,
          recipient: receiverUsername || '',
          recipientAcc: acct,
          txno: '-'
        });
      }
    });

    // helper: small inline popup for quick errors (keeps old showPopup semantics minimal)
    async function showSimplePopup(message, type='info') {
      // reuse transfer popup briefly for error text (simple)
      showTransferPopup({ success: type === 'error' ? false : true, amount:0, statusText: message, senderName:'', senderAcc:'', bankName:'', recipient:'', recipientAcc:'', txno:'-'});
      // auto hide after 2400ms for non-errors
      if (type !== 'error') {
        setTimeout(()=>hideTransferPopup(), 2400);
      }
    }

    // keep ESC to close modal
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (!bankModal.classList.contains("hidden")) closeBankModal();
        if (transferPopup.classList.contains('show')) hideTransferPopup();
      }
    });
  </script>
</body>
</html>
