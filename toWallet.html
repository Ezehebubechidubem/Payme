<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ToWallet</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f4f6f8;margin:0;padding:20px}
    .container{max-width:480px;margin:auto;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);padding:18px}
    h2{text-align:center;margin-bottom:14px;color:#00c853}
    label{font-size:13px;font-weight:700;margin-bottom:6px;display:block}
    input,select,button{padding:10px;margin-bottom:12px;border:1px solid #ccc;border-radius:8px;font-size:14px}
    input[type="text"], input[type="number"]{width:100%}
    button{background:#00c853;color:#fff;border:none;cursor:pointer;font-weight:700}
    button:hover{background:#009624}
    .hidden{display:none}
    .info{background:#e8f5e9;padding:10px;border-radius:8px;margin-bottom:12px}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:8px}
    /* search input + delete button inline */
    .search-inline{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .search-inline input{flex:1;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:14px}
    .del-btn{width:46px;height:42px;border-radius:8px;background:#e0e0e0;border:none;cursor:pointer;font-weight:700}
    .del-btn:active{transform:translateY(1px)}
    /* Dropdown modal (mobile-style) */
    .bank-modal {
      position: fixed;
      left: 6%;
      right: 6%;
      top: 8%;
      bottom: 8%;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.3);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .bank-modal-header {
      padding: 12px 14px;
      border-bottom: 1px solid #eee;
      display:flex;
      gap:8px;
      align-items:center;
      background: #fff7f5;
    }
    .bank-modal-title { font-weight:700; font-size:16px; color:#333; flex:1; text-align:center; }
    .bank-modal-close { background:none;border:none;font-size:18px; cursor:pointer; padding:6px 10px; border-radius:8px; }
    .bank-list { overflow:auto; padding:6px 0; flex:1; background: #fff7f5; }
    .bank-item {
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(0,0,0,0.05);
      cursor:pointer;
    }
    .bank-item .name { font-size:15px; color:#111; }
    .bank-item .code { color:#666; font-size:13px; margin-left:8px; }
    .radio {
      width:18px;height:18px;border-radius:50%;border:2px solid #ccc;display:inline-block;flex-shrink:0;
      background:white;
    }
    .radio.selected { border-color:#00c853; background:#00c853; box-shadow:0 0 0 4px rgba(0,200,83,0.08); }

    /* popup result */
    .result-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 11000;
      background: rgba(0,0,0,0.45);
    }
    .result-overlay.show { display:flex; }
    .result-box {
      width: min(92%, 520px);
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 18px 40px rgba(0,0,0,0.25);
      max-height: 88vh;
      display:flex;
      flex-direction:column;
    }
    .result-body {
      padding: 20px;
      display:flex;
      gap:14px;
      align-items:flex-start;
    }
    .result-icon {
      flex: 0 0 56px;
      height:56px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:700;
      font-size:22px;
    }
    .result-success .result-icon { background: linear-gradient(135deg,#00c853,#43a047); }
    .result-fail .result-icon { background: linear-gradient(135deg,#e53935,#d32f2f); }
    .result-content { flex:1; overflow:auto; }
    .result-title { font-weight:800;margin-bottom:8px; font-size:18px; }
    .result-text { color:#444; font-size:14px; line-height:1.4; white-space:pre-wrap; }
    .result-actions { padding:12px; display:flex; gap:10px; justify-content:flex-end; border-top:1px solid #f0f0f0; }
    .btn-primary { padding:8px 14px; border-radius:8px; border:0; background:#00c853; color:#fff; font-weight:700; cursor:pointer; }
    .btn-cancel { padding:8px 14px; border-radius:8px; border:0; background:#e53935; color:#fff; font-weight:700; cursor:pointer; }
    @media(min-width:700px){
      .bank-modal { left:25%; right:25%; top:10%; bottom:10%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Transfer Money</h2>

    <label for="accountNumber">Receiver Account Number</label>
    <input id="accountNumber" type="text" maxlength="10" placeholder="Enter 10-digit account" />

    <div id="bankSection" class="hidden">
      <label for="bankSelect">Select Bank</label>

      <!-- visible horizontal search + backspace -->
      <div class="search-inline">
        <input id="bankSearchMain" type="text" placeholder="Type bank name or code (e.g. 'P' or '044')" aria-label="Search banks"/>
        <button id="bankDeleteBtn" class="del-btn" title="Delete last character">⌫</button>
      </div>

      <!-- dropdown toggle (displays Name) -->
      <button id="bankToggle" type="button">--Choose Bank--</button>
      <!-- hidden input stores selected bank code -->
      <input id="bankSelect" type="hidden" value="" />

      <div id="bankNote" class="muted">Loading banks…</div>
    </div>

    <div id="receiverSection" class="hidden">
      <div class="info">
        <div><strong>Receiver Name:</strong> <span id="receiverName"></span></div>
        <!-- receiverMeta intentionally removed per your request (show only name) -->
      </div>
    </div>

    <div id="amountSection" class="hidden">
      <label for="amount">Amount (₦)</label>
      <input id="amount" type="number" placeholder="Enter amount" />
    </div>

    <div id="sendSection" class="hidden">
      <button id="sendBtn">Send Money</button>
    </div>
  </div>

  <!-- Bank modal -->
  <div id="bankModal" class="hidden" aria-hidden="true">
    <div class="bank-modal">
      <div class="bank-modal-header">
        <div class="bank-modal-title">--Choose Bank--</div>
        <button id="bankModalClose" class="bank-modal-close" aria-label="Close">✕</button>
      </div>

      <div style="padding:10px;background:#fff7f5;border-bottom:1px solid #f0e7e6;">
        <div class="search-inline" style="margin:0">
          <input id="bankSearch" type="text" placeholder="Search banks by name or code" />
          <button id="bankDeleteModalBtn" class="del-btn" title="Delete last character">⌫</button>
        </div>
      </div>

      <div id="bankList" class="bank-list" role="listbox" tabindex="0"></div>
    </div>
  </div>

  <!-- result popup -->
  <div id="resultOverlay" class="result-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div id="resultBox" class="result-box">
      <div id="resultBody" class="result-body">
        <div id="resultIcon" class="result-icon">✓</div>
        <div class="result-content">
          <div id="resultTitle" class="result-title">Success</div>
          <div id="resultText" class="result-text">Message</div>
        </div>
      </div>
      <div class="result-actions">
        <button id="viewTxBtn" class="btn-primary">View Transactions</button>
        <button id="cancelResultBtn" class="btn-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // point to your backend base url (no trailing slash)
    const BACKEND_URL = "https://payme-update.onrender.com";

    // DOM
    const accountInput = document.getElementById("accountNumber");
    const bankSection = document.getElementById("bankSection");
    const bankToggle = document.getElementById("bankToggle");
    const bankSelect = document.getElementById("bankSelect"); // hidden value (bank code)
    const bankNote = document.getElementById("bankNote");
    const receiverSection = document.getElementById("receiverSection");
    const receiverNameEl = document.getElementById("receiverName");
    const amountSection = document.getElementById("amountSection");
    const sendSection = document.getElementById("sendSection");
    const sendBtn = document.getElementById("sendBtn");

    const bankModal = document.getElementById("bankModal");
    const bankModalClose = document.getElementById("bankModalClose");
    const bankList = document.getElementById("bankList");
    const bankSearch = document.getElementById("bankSearch");
    const bankSearchMain = document.getElementById("bankSearchMain");
    const bankDeleteBtn = document.getElementById("bankDeleteBtn");
    const bankDeleteModalBtn = document.getElementById("bankDeleteModalBtn");

    const resultOverlay = document.getElementById("resultOverlay");
    const resultBox = document.getElementById("resultBox");
    const resultIcon = document.getElementById("resultIcon");
    const resultTitle = document.getElementById("resultTitle");
    const resultText = document.getElementById("resultText");
    const viewTxBtn = document.getElementById("viewTxBtn");
    const cancelResultBtn = document.getElementById("cancelResultBtn");

    let currentAccount = "";
    let fullBankList = []; // [{code,name}]
    let receiverName = "";
    const currentUser = JSON.parse(localStorage.getItem("loggedInUser")) || JSON.parse(localStorage.getItem("user"));

    // render bank items (name shown)
    function renderBankItems(list){
      bankList.innerHTML = "";
      if (!list || list.length === 0) {
        const el = document.createElement("div");
        el.className = "bank-item";
        el.style.justifyContent = "center";
        el.textContent = "No banks found";
        bankList.appendChild(el);
        return;
      }
      list.forEach(b => {
        const code = String(b.code || "").trim();
        const name = String(b.name || b.bank || b.bank_name || "").trim();
        if (!code) return;
        const row = document.createElement("div");
        row.className = "bank-item";
        row.dataset.code = code;
        row.dataset.name = name;

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        const title = document.createElement("div");
        title.className = "name";
        title.textContent = name;
        const sub = document.createElement("div");
        sub.className = "code";
        sub.textContent = `(${code})`;
        left.appendChild(title);
        left.appendChild(sub);

        const radio = document.createElement("div");
        radio.className = "radio";
        if (bankSelect.value && bankSelect.value === code) radio.classList.add("selected");

        row.appendChild(left);
        row.appendChild(radio);

        row.addEventListener("click", () => {
          bankToggle.textContent = `${name}`;      // display name only per your request
          bankSelect.value = code;
          const prev = bankList.querySelector(".radio.selected");
          if (prev) prev.classList.remove("selected");
          radio.classList.add("selected");
          closeBankModal();
          // trigger resolve
          resolveAccount(currentAccount, code);
        });

        bankList.appendChild(row);
      });
    }

    function filterBanks(q){
      if (!q) {
        renderBankItems(fullBankList);
        return;
      }
      const ql = String(q).trim().toLowerCase();
      const filtered = fullBankList.filter(b => {
        const name = (b.name || "").toLowerCase();
        const code = (b.code || "").toLowerCase();
        return name.indexOf(ql) !== -1 || code.indexOf(ql) !== -1;
      });
      renderBankItems(filtered);
    }

    function openBankModal(){
      bankModal.classList.remove("hidden");
      bankModal.setAttribute("aria-hidden","false");
      setTimeout(()=>bankSearch.focus(), 120);
    }
    function closeBankModal(){
      bankModal.classList.add("hidden");
      bankModal.setAttribute("aria-hidden","true");
    }

    bankToggle.addEventListener("click", openBankModal);
    bankModalClose.addEventListener("click", closeBankModal);
    bankModal.addEventListener("click", (e) => { if (e.target === bankModal) closeBankModal(); });

    // sync searches
    bankSearch.addEventListener("input", () => {
      bankSearchMain.value = bankSearch.value;
      filterBanks(bankSearch.value);
    });
    bankSearchMain.addEventListener("input", () => {
      if (bankModal.classList.contains("hidden")) openBankModal();
      bankSearch.value = bankSearchMain.value;
      filterBanks(bankSearchMain.value);
    });
    bankSearchMain.addEventListener("focus", () => {
      if (bankModal.classList.contains("hidden")) openBankModal();
      bankSearch.value = bankSearchMain.value;
      filterBanks(bankSearchMain.value);
    });

    // backspace / delete last char behavior
    bankDeleteBtn.addEventListener("click", () => {
      bankSearchMain.value = bankSearchMain.value.slice(0, -1);
      bankSearch.value = bankSearchMain.value;
      filterBanks(bankSearchMain.value);
      bankSearchMain.focus();
    });
    bankDeleteModalBtn.addEventListener("click", () => {
      bankSearch.value = bankSearch.value.slice(0, -1);
      bankSearchMain.value = bankSearch.value;
      filterBanks(bankSearch.value);
      bankSearch.focus();
    });

    // load banks (same endpoints you already use)
    async function loadBanks(){
      bankNote.textContent = "Loading banks…";
      try {
        const res = await fetch(`${BACKEND_URL}/banks`, { method: "GET", cache: "no-store" });
        if (!res.ok) throw new Error("Banks endpoint returned " + res.status);
        const data = await res.json();

        const normalized = [];
        if (data && Array.isArray(data.banks)) {
          data.banks.forEach(b => {
            const code = String(b.code || "").trim();
            const name = b.name || b.bank || b.bank_name || "";
            if (!code) return;
            normalized.push({ code, name });
          });
        } else if (data && data.banks && typeof data.banks === "object" && !Array.isArray(data.banks)) {
          const mapping = data.banks;
          Object.keys(mapping).forEach(code => {
            normalized.push({ code: String(code).trim(), name: String(mapping[code]).trim() });
          });
        } else if (data && typeof data === "object" && !Array.isArray(data) && !data.banks) {
          const keys = Object.keys(data);
          const isMapping = keys.length > 0 && keys.every(k => typeof data[k] === "string");
          if (isMapping) {
            keys.forEach(code => normalized.push({ code: String(code).trim(), name: String(data[code]).trim() }));
          }
        } else if (data && data.data && Array.isArray(data.data)) {
          data.data.forEach(b => {
            const code = String(b.code || "").trim();
            const name = b.name || "";
            if (!code) return;
            normalized.push({ code, name });
          });
        }

        if (normalized.length === 0) throw new Error("Invalid banks payload");

        fullBankList = normalized;
        renderBankItems(fullBankList);
        bankNote.textContent = "Banks loaded.";
      } catch (err) {
        console.warn("loadBanks failed", err);
        const fallback = {
          "000004":"UNITED BANK FOR AFRICA",
          "000013":"GUARANTY TRUST BANK",
          "000014":"ZENITH BANK",
          "000015":"UNION BANK",
          "000012":"FIRST BANK OF NIGERIA"
        };
        fullBankList = Object.keys(fallback).map(c => ({ code: String(c).trim(), name: fallback[c] }));
        renderBankItems(fullBankList);
        bankNote.textContent = "Using fallback bank list.";
      }
    }

    loadBanks();

    // account input behavior
    accountInput.addEventListener("input", function(){
      const digits = this.value.replace(/\D/g,'');
      if (this.value !== digits) this.value = digits;
      if (this.value.length === 10) {
        currentAccount = this.value;
        bankSection.classList.remove("hidden");
      } else {
        bankSection.classList.add("hidden");
        receiverSection.classList.add("hidden");
        amountSection.classList.add("hidden");
        sendSection.classList.add("hidden");
      }
    });

    // resolve account via towallet backend
    async function resolveAccount(account, bankCode){
      // show verifying state
      receiverSection.classList.remove("hidden");
      receiverNameEl.textContent = "⏳ Verifying…";
      amountSection.classList.add("hidden");
      sendSection.classList.add("hidden");

      try {
        const res = await fetch(`${BACKEND_URL}/towallet/resolve-account`, {
          method: "POST",
          headers: {"Content-Type":"application/json","Accept":"application/json"},
          body: JSON.stringify({ account_number: account, bank_code: bankCode })
        });
        const body = await res.json().catch(()=>null);

        if (res.ok && body && body.status === "success") {
          // show only the name (per your request)
          const name = (body.account_name || body.data && body.data.account_name) || "";
          receiverName = name || "Name not provided";
          receiverNameEl.textContent = receiverName;
          amountSection.classList.remove("hidden");
          sendSection.classList.remove("hidden");
          return;
        }

        // error: display backend message only
        let msg = "Account not found or verification failed";
        if (body && (body.message || body.error || body.details)) {
          msg = (body.message || body.error || body.details);
        } else if (!body) {
          msg = `Provider returned HTTP ${res.status}`;
        }
        receiverName = "";
        receiverNameEl.textContent = "❌ " + msg;
        amountSection.classList.add("hidden");
        sendSection.classList.add("hidden");
      } catch (err) {
        console.warn("resolveAccount error", err);
        receiverName = "";
        receiverNameEl.textContent = "⚠️ Network error when contacting server";
        amountSection.classList.add("hidden");
        sendSection.classList.add("hidden");
      }
    }

    // fetch balance (existing route)
    async function fetchBalance() {
      if (!currentUser || !currentUser.phone) return 0;
      try {
        const res = await fetch(`${BACKEND_URL}/balance/${currentUser.phone}`);
        if (!res.ok) return parseFloat(localStorage.getItem("balance")) || 0;
        const data = await res.json().catch(()=>null);
        if (data && (data.balance !== undefined)) {
          localStorage.setItem("balance", data.balance);
          return parseFloat(data.balance);
        }
      } catch (e) {
        console.warn("fetchBalance error", e);
      }
      return parseFloat(localStorage.getItem("balance")) || 0;
    }

    // send money -> call towallet send_money route
    sendBtn.addEventListener("click", async function(){
      const amountEl = document.getElementById("amount");
      const amount = Number(amountEl.value);
      const bankCode = bankSelect.value;
      const acct = currentAccount;

      if (!acct || acct.length !== 10) {
        await showResultPopup("Invalid receiver account. Make sure you entered a 10-digit account.", "Failed", "error");
        return;
      }
      if (!bankCode) {
        await showResultPopup("Please select a bank.", "Failed", "error");
        return;
      }
      if (!amount || Number.isNaN(amount) || amount <= 0) {
        await showResultPopup("Enter a valid amount.", "Failed", "error");
        return;
      }

      // IMPORTANT: we removed "cannot send to myself" check per your instructions
      // check balance
      const balance = await fetchBalance();
      if (amount > balance) {
        await showResultPopup("Insufficient funds.", "Failed", "error");
        return;
      }

   // prepare payload
      const payload = {
        sender_phone: (currentUser && currentUser.phone) || null,
        receiver_acc: acct,
        amount: amount,
        receiver_bank: bankCode
      };

      try {
        const res = await fetch(`${BACKEND_URL}/towallet/send_money`, {
          method: "POST",
          headers: {"Content-Type":"application/json","Accept":"application/json"},
          body: JSON.stringify(payload)
        });
        const body = await res.json().catch(()=>null);

        if (res.ok && body && (body.status === "success" || body.success === true)) {
          // update local user balance
          let user = JSON.parse(localStorage.getItem("loggedInUser"));
          if (!user) user = JSON.parse(localStorage.getItem("user")) || {};
          try { user.balance = parseFloat((body.balance !== undefined ? body.balance : (balance - amount))); }
          catch(e){ user.balance = user.balance ? (user.balance - amount) : null; }
          localStorage.setItem("loggedInUser", JSON.stringify(user));
          localStorage.setItem("user", JSON.stringify(user));

          // save transaction locally
          let transactions = JSON.parse(localStorage.getItem("transactions")) || [];
          transactions.push({
            type: "Transfer Out",
            amount: amount,
            description: "Transfer to " + (receiverName || acct) + " (" + bankCode + ")",
            date: new Date().toLocaleString(),
            backend_id: body.transaction_id || null,
            status: "success"
          });
          localStorage.setItem("transactions", JSON.stringify(transactions));

          // show success popup (View Transactions + Cancel[red])
          await showResultPopup((body.message || "Transfer completed successfully."), "Success", "success");
          amountEl.value = "";
        } else {
          const msg = (body && (body.message || body.error || body.msg)) ? (body.message || body.error || body.msg) : `Transfer failed (HTTP ${res.status})`;
          // log failed transaction locally
          let transactions = JSON.parse(localStorage.getItem("transactions")) || [];
          transactions.push({
            type: "Transfer Out",
            amount: amount,
            description: "Transfer to " + (receiverName || acct) + " (" + bankCode + ")",
            date: new Date().toLocaleString(),
            backend_id: body && (body.transaction_id || body.tx_id) ? (body.transaction_id || body.tx_id) : null,
            status: "failed",
            error: msg
          });
          localStorage.setItem("transactions", JSON.stringify(transactions));

          await showResultPopup(msg, "Failed", "error");
        }
      } catch (err) {
        console.warn("send error", err);
        await showResultPopup("Network error connecting to server.", "Failed", "error");
      }
    });

    // result popup helper
    function showResultOverlay(type, title, text) {
      resultOverlay.classList.add("show");
      resultOverlay.setAttribute("aria-hidden","false");
      if (type === "success") {
        resultBox.className = "result-box result-success";
        resultIcon.className = "result-icon";
        resultIcon.textContent = "✓";
        resultTitle.textContent = title || "Success";
      } else {
        resultBox.className = "result-box result-fail";
        resultIcon.className = "result-icon";
        resultIcon.textContent = "✕";
        resultTitle.textContent = title || "Failed";
      }
      resultText.textContent = text || "";
    }

    function hideResultOverlay() {
      resultOverlay.classList.remove("show");
      resultOverlay.setAttribute("aria-hidden","true");
    }

    async function showResultPopup(message, title = "Result", kind = "info") {
      showResultOverlay(kind === "success" ? "success" : "error", title, message);
      // focus viewTx button for a11y
      viewTxBtn.focus();
      // returns a promise that resolves when either button is clicked (but does not redirect automatically)
      return new Promise(resolve => {
        function onView() {
          hideResultOverlay();
          window.location.href = "transactions.html";
          cleanup();
        }
        function onCancel() {
          hideResultOverlay();
          cleanup();
        }
        function cleanup() {
          viewTxBtn.removeEventListener("click", onView);
          cancelResultBtn.removeEventListener("click", onCancel);
          resolve();
        }
        viewTxBtn.addEventListener("click", onView);
        cancelResultBtn.addEventListener("click", onCancel);
      });
    }

    // wire popup cancel to hide
    cancelResultBtn.addEventListener("click", () => hideResultOverlay());

    // ESC close behaviour
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (!bankModal.classList.contains("hidden")) closeBankModal();
        if (resultOverlay.classList.contains("show")) hideResultOverlay();
      }
    });

    // On page load focus
    (function(){
      if (!currentUser || !currentUser.phone) {
        // user not logged in: leave behavior to page (you can redirect if needed)
        console.warn("No logged-in user found in localStorage (loggedInUser or user).");
      }
    })();
  </script>
</body>
</html>
