<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ToWallet</title>
  <style>
    /* page */
    body{font-family:Arial,sans-serif;background:#f4f6f8;margin:0;padding:20px}
    .container{max-width:520px;margin:auto;background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.08);padding:22px}
    h2{text-align:center;margin-bottom:16px;color:#00c853}
    label{font-size:13px;font-weight:700;margin-bottom:6px;display:block}
    input,button{padding:10px;margin-bottom:12px;border:1px solid #ccc;border-radius:8px;font-size:14px}
    input[type="text"], input[type="number"]{width:100%;box-sizing:border-box}
    button{background:#00c853;color:#fff;border:none;cursor:pointer;font-weight:700}
    button:hover{background:#009624}
    .hidden{display:none}
    .info{background:#e8f5e9;padding:10px;border-radius:8px;margin-bottom:12px}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:8px;align-items:center}

    /* inline search + delete */
    .search-inline{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .search-inline input{flex:1;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:14px}
    .del-btn{width:46px;height:42px;border-radius:8px;background:#e9e9e9;border:none;cursor:pointer;font-weight:700}
    .del-btn:active{transform:translateY(1px)}

    /* bank modal (mobile style) */
    .bank-modal {
      position: fixed;
      left: 6%;
      right: 6%;
      top: 8%;
      bottom: 8%;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.3);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .bank-modal-header {
      padding: 12px 14px;
      border-bottom: 1px solid #eee;
      display:flex;
      gap:8px;
      align-items:center;
      background: #fff7f5;
    }
    .bank-modal-title { font-weight:700; font-size:16px; color:#333; flex:1; }
    .bank-modal-close { background:none;border:none;font-size:18px; cursor:pointer; padding:6px 10px; border-radius:8px; }
    .bank-list { overflow:auto; padding:6px 0; flex:1; background: #fff7f5; }
    .bank-item {
      padding:12px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(0,0,0,0.04);
      cursor:pointer;
    }
    .bank-item .name { font-size:15px; color:#111; }
    .bank-item .code { color:#666; font-size:13px; margin-left:8px; }
    .radio {
      width:18px;height:18px;border-radius:50%;border:2px solid #ccc;display:inline-block;flex-shrink:0;
      background:white;
    }
    .radio.selected { border-color:#00c853; background:#00c853; box-shadow:0 0 0 4px rgba(0,200,83,0.08); }

    /* bank toggle */
    #bankToggle {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid #cfcfcf;
      background:#fff;
      text-align:left;
      font-size:14px;
      color:#333;
      cursor:pointer;
    }
    #bankToggle::after{ content: "▾"; font-size:14px; color:#666; }

    /* large result popup (success/fail) */
    .result-overlay{ position: fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.35); z-index:12000; padding:20px; }
    .result-card{ width:min(96%,720px); max-width:700px; background:#fff; border-radius:12px; padding:18px; box-shadow:0 18px 40px rgba(0,0,0,0.18); max-height:90vh; overflow:auto; }
    .result-header{ display:flex; align-items:center; gap:14px; justify-content:center; flex-direction:column; text-align:center }
    .badge { width:74px; height:74px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:36px; font-weight:800; }
    .badge.success{ background: linear-gradient(135deg,#00c853,#43a047) }
    .badge.fail{ background: linear-gradient(135deg,#f44336,#e53935) }
    .result-amount{ font-size:36px; font-weight:800; margin:6px 0; }
    .result-status{ display:inline-block; padding:6px 12px; border-radius:8px; font-weight:700; color:#fff; }
    .status-success{ background:#dff7e7; color:#007a33; padding:6px 10px; border-radius:8px; }
    .status-fail{ background:#fdeaea; color:#b00020; padding:6px 10px; border-radius:8px; }

    .result-details{ margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; color:#333; }
    .detail-row{ padding:12px; background:#fafafa; border-radius:8px; display:flex; justify-content:space-between; align-items:center; font-size:14px }
    .detail-label{ color:#888; font-size:13px; margin-right:8px }
    .detail-value{ font-weight:700; text-align:right }

    .result-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:18px }
    .btn-outline{ background:#fff; border:1px solid #ddd; color:#333; padding:10px 14px; border-radius:8px; cursor:pointer }
    .btn-primary{ background:#00c853; color:#fff; padding:10px 14px; border-radius:8px; border:0; cursor:pointer }
    .btn-cancel{ background:#e53935; color:#fff; padding:10px 14px; border-radius:8px; border:0; cursor:pointer }

    @media(min-width:900px){ .result-details{ grid-template-columns:repeat(2,1fr) } }
    @media(max-width:520px){ .result-details{ grid-template-columns:1fr } }
  </style>
</head>
<body>
  <div class="container">
    <h2>Transfer Money</h2>

    <label for="accountNumber">Receiver Account Number</label>
    <input id="accountNumber" type="text" maxlength="10" placeholder="Enter 10-digit account" />

    <div id="bankSection" class="hidden">
      <label id="bankLabel" for="bankSelect">Select Bank</label>

      <div class="search-inline">
        <input id="bankSearchMain" type="text" placeholder="Type bank name or code (e.g. 'P' or '044')" aria-label="Search banks"/>
        <button id="bankDeleteBtn" class="del-btn" title="Delete last character">⌫</button>
      </div>

      <button id="bankToggle" type="button">--Choose Bank--</button>
      <input id="bankSelect" type="hidden" value="" />

      <div id="bankNote" class="muted">Loading banks…</div>
    </div>

    <div id="receiverSection" class="hidden">
      <div class="info">
        <div><strong>Receiver:</strong> <span id="receiverName"></span></div>
        <div id="receiverMeta" class="muted" style="margin-top:6px"></div>
      </div>
    </div>

    <div id="amountSection" class="hidden">
      <label for="amount">Amount (₦)</label>
      <input id="amount" type="number" placeholder="Enter amount" />
    </div>

    <div id="sendSection" class="hidden">
      <button id="sendBtn">Send Money</button>
    </div>
  </div>

  <!-- bank modal -->
  <div id="bankModal" class="hidden" aria-hidden="true">
    <div class="bank-modal" role="dialog" aria-modal="true">
      <div class="bank-modal-header">
        <div class="bank-modal-title">--Choose Bank--</div>
        <button id="bankModalClose" class="bank-modal-close" aria-label="Close">✕</button>
      </div>

      <div style="padding:10px;background:#fff7f5;border-bottom:1px solid #f0e7e6;">
        <div class="search-inline" style="margin:0">
          <input id="bankSearch" type="text" placeholder="Search banks by name or code" />
          <button id="bankDeleteModalBtn" class="del-btn" title="Delete last character">⌫</button>
        </div>
      </div>

      <div id="bankList" class="bank-list" role="listbox" tabindex="0"></div>
    </div>
  </div>

  <!-- result popup root -->
  <div id="resultRoot"></div>

  <script>
    const BACKEND_URL = "https://payme-update.onrender.com";

    // DOM refs
    const accountInput = document.getElementById("accountNumber");
    const bankSection = document.getElementById("bankSection");
    const bankToggle = document.getElementById("bankToggle");
    const bankSelect = document.getElementById("bankSelect");
    const bankNote = document.getElementById("bankNote");
    const bankLabel = document.getElementById("bankLabel");
    const receiverSection = document.getElementById("receiverSection");
    const receiverName = document.getElementById("receiverName");
    const receiverMeta = document.getElementById("receiverMeta");
    const amountSection = document.getElementById("amountSection");
    const sendSection = document.getElementById("sendSection");
    const sendBtn = document.getElementById("sendBtn");

    const bankModal = document.getElementById("bankModal");
    const bankModalClose = document.getElementById("bankModalClose");
    const bankList = document.getElementById("bankList");
    const bankSearch = document.getElementById("bankSearch");
    const bankSearchMain = document.getElementById("bankSearchMain");
    const bankDeleteBtn = document.getElementById("bankDeleteBtn");
    const bankDeleteModalBtn = document.getElementById("bankDeleteModalBtn");
    const resultRoot = document.getElementById("resultRoot");

    let currentAccount = "";
    let fullBankList = [];
    let receiverUsername = "";
    let loadedFromBackend = false;
    const currentUser = JSON.parse(localStorage.getItem("loggedInUser")) || JSON.parse(localStorage.getItem("user"));

    function dbg(){}

    // helper: get bank name for a code
    function getBankName(code){
      if (!code) return '';
      const found = fullBankList.find(b => String(b.code || '') === String(code));
      if (found && found.name) return found.name;
      return '';
    }

    // Render bank items
    function renderBankItems(list){
      bankList.innerHTML = "";
      if (!list || list.length === 0) {
        const el = document.createElement("div");
        el.className = "bank-item";
        el.style.justifyContent = "center";
        el.textContent = "No banks found";
        bankList.appendChild(el);
        return;
      }

      list.forEach(b => {
        const code = String(b.code || "").trim();
        const name = (b.name || b.bank || b.bank_name || "").trim();
        if (!code) return;
        const row = document.createElement("div");
        row.className = "bank-item";
        row.setAttribute("role","option");
        row.dataset.code = code;
        row.dataset.name = name;

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        const title = document.createElement("div");
        title.className = "name";
        title.textContent = name;
        const sub = document.createElement("div");
        sub.className = "code";
        sub.textContent = loadedFromBackend ? "" : `(${code})`;

        left.appendChild(title);
        if (!loadedFromBackend) left.appendChild(sub);

        const radio = document.createElement("div");
        radio.className = "radio";
        if (bankSelect.value && bankSelect.value === code) radio.classList.add("selected");

        row.appendChild(left);
        row.appendChild(radio);

        row.addEventListener("click", () => {
          bankToggle.textContent = loadedFromBackend ? name : `${name} (${code})`;
          bankSelect.value = code;
          const prev = bankList.querySelector(".radio.selected");
          if (prev) prev.classList.remove("selected");
          radio.classList.add("selected");
          closeBankModal();
          bankSelect.dispatchEvent(new Event('change', { bubbles: true }));
        });

        bankList.appendChild(row);
      });
    }

    function filterBanks(query){
      if (!query) { renderBankItems(fullBankList); return; }
      const q = String(query).trim().toLowerCase();
      const filtered = fullBankList.filter(b => {
        const name = (b.name || "").toLowerCase();
        const code = (b.code || "").toLowerCase();
        return name.indexOf(q) !== -1 || code.indexOf(q) !== -1;
      });
      renderBankItems(filtered);
    }

    function openBankModal(){
      bankModal.classList.remove("hidden");
      bankModal.setAttribute("aria-hidden","false");
      setTimeout(()=>bankSearch.focus(),120);
    }
    function closeBankModal(){
      bankModal.classList.add("hidden");
      bankModal.setAttribute("aria-hidden","true");
    }

    bankToggle.addEventListener("click", openBankModal);
    bankModalClose.addEventListener("click", closeBankModal);
    bankModal.addEventListener("click", (e) => { if (e.target === bankModal) closeBankModal(); });

    bankSearch.addEventListener("input", () => {
      bankSearchMain.value = bankSearch.value;
      filterBanks(bankSearch.value);
    });
    bankSearchMain.addEventListener("input", () => {
      if (bankModal.classList.contains("hidden")) openBankModal();
      bankSearch.value = bankSearchMain.value;
      filterBanks(bankSearchMain.value);
    });
    bankSearchMain.addEventListener("focus", () => {
      if (bankModal.classList.contains("hidden")) openBankModal();
      bankSearch.value = bankSearchMain.value;
      filterBanks(bankSearchMain.value);
    });

    bankDeleteBtn.addEventListener("click", () => {
      bankSearchMain.value = bankSearchMain.value.slice(0, -1);
      bankSearch.value = bankSearchMain.value;
      filterBanks(bankSearchMain.value);
      bankSearchMain.focus();
    });
    bankDeleteModalBtn.addEventListener("click", () => {
      bankSearch.value = bankSearch.value.slice(0, -1);
      bankSearchMain.value = bankSearch.value;
      filterBanks(bankSearch.value);
      bankSearch.focus();
    });

    // load banks from backend (robust)
    async function loadBanks(){
      bankNote.textContent = "Loading banks…";
      try {
        const res = await fetch(`${BACKEND_URL}/banks`, { method: "GET", cache: "no-store" });
        if (!res.ok) throw new Error("Banks endpoint returned " + res.status);
        const data = await res.json();

        const normalized = [];
        let isFromBackend = false;

        if (data && Array.isArray(data.banks)) {
          data.banks.forEach(b => {
            const code = String(b.code || "").trim();
            const name = b.name || b.bank || b.bank_name || "";
            if (!code) return;
            normalized.push({ code, name });
          });
          isFromBackend = true;
        } else if (data && data.banks && typeof data.banks === "object" && !Array.isArray(data.banks)) {
          Object.keys(data.banks).forEach(code => {
            const name = data.banks[code] || "";
            normalized.push({ code: String(code).trim(), name: String(name).trim() });
          });
          isFromBackend = true;
        } else if (data && typeof data === "object" && !Array.isArray(data) && !data.banks) {
          const keys = Object.keys(data);
          const isMapping = keys.length > 0 && keys.every(k => typeof data[k] === "string");
          if (isMapping) {
            keys.forEach(code => normalized.push({ code: String(code).trim(), name: String(data[code]).trim() }));
            isFromBackend = true;
          }
        } else if (data && data.data && Array.isArray(data.data)) {
          data.data.forEach(b => {
            const code = String(b.code || "").trim();
            const name = b.name || "";
            if (!code) return;
            normalized.push({ code, name });
          });
          isFromBackend = true;
        }

        if (normalized.length === 0) throw new Error("Invalid banks payload");

        normalized.sort((a,b) => (a.name||'').localeCompare(b.name||''));
        fullBankList = normalized;
        loadedFromBackend = isFromBackend;
        if (loadedFromBackend) bankLabel.textContent = "Receive Name:";
        else bankLabel.textContent = "Select Bank";
        renderBankItems(fullBankList);
        bankNote.textContent = "Banks loaded from backend.";
      } catch (err) {
        const fallback = {
          "000004":"UNITED BANK FOR AFRICA",
          "000013":"GUARANTY TRUST BANK",
          "000014":"ZENITH BANK",
          "000015":"UNION BANK",
          "000012":"FIRST BANK OF NIGERIA"
        };
        fullBankList = Object.keys(fallback).map(code => ({ code: String(code).trim(), name: fallback[code] }));
        loadedFromBackend = false;
        bankLabel.textContent = "Select Bank";
        renderBankItems(fullBankList);
        bankNote.textContent = "Using fallback bank list (backend unreachable).";
      }
    }

    loadBanks();

    // account input sanitize and show banks when 10 digits
    accountInput.addEventListener("input", function(){
      const digits = this.value.replace(/\D/g,'');
      if (this.value !== digits) this.value = digits;
      if (this.value.length === 10) {
        currentAccount = this.value;
        bankSection.classList.remove("hidden");
      } else {
        bankSection.classList.add("hidden");
        receiverSection.classList.add("hidden");
        amountSection.classList.add("hidden");
        sendSection.classList.add("hidden");
      }
    });

    // resolveAccount POST wrapper
    async function resolveAccountPOST(account, bankCode) {
      try {
        const res = await fetch(`${BACKEND_URL}/resolve-account`, {
          method: "POST",
          headers: {"Content-Type":"application/json","Accept":"application/json"},
          body: JSON.stringify({ account_number: account, bank_code: bankCode })
        });
        const body = await res.json().catch(()=>null);
        return { httpStatus: res.status, body };
      } catch (err) {
        return { httpStatus: 0, body: null, error: String(err) };
      }
    }

    // extract account name helper (robust)
    function extractAccountName(payload) {
      if (!payload) return null;
      if (payload.account_name) return payload.account_name;
      if (payload.accountName) return payload.accountName;
      if (payload.accountname) return payload.accountname;
      if (payload.data && typeof payload.data === "object") {
        const d = payload.data;
        if (d.account_name) return d.account_name;
        if (d.accountName) return d.accountName;
        if (d.accountname) return d.accountname;
        if (d.data && typeof d.data === "object") {
          if (d.data.account_name) return d.data.account_name;
          if (d.data.accountName) return d.data.accountName;
        }
      }
      if (payload.raw && typeof payload.raw === "object") {
        const r = payload.raw;
        if (r.data && typeof r.data === "object") {
          if (r.data.account_name) return r.data.account_name;
          if (r.data.accountName) return r.data.accountName;
        }
        if (r.account_name) return r.account_name;
      }
      return null;
    }

    // bankSelect change => resolve account
    bankSelect.addEventListener("change", async function(){
      const bankCode = this.value;
      receiverSection.classList.remove("hidden");
      receiverName.textContent = "";
      receiverMeta.textContent = "";
      amountSection.classList.add("hidden");
      sendSection.classList.add("hidden");

      if (!bankCode) {
        receiverSection.classList.add("hidden");
        return;
      }
      if (!currentAccount || currentAccount.length !== 10) {
        receiverName.textContent = "❌ Enter a valid 10-digit account first";
        return;
      }

      receiverName.textContent = "⏳ Verifying…";

      const result = await resolveAccountPOST(currentAccount, bankCode);

      if (result.httpStatus === 0) {
        receiverName.textContent = "⚠️ Network error when contacting backend";
        receiverMeta.textContent = String(result.error || "");
        return;
      }

      const payload = result.body || {};

      if (result.httpStatus === 200 && payload.status === "success") {
        const acctName = extractAccountName(payload) || extractAccountName(payload.data) || extractAccountName(payload.raw);
        receiverUsername = acctName || "";
        // show only the name when backend-sourced banks loaded
        receiverName.textContent = acctName || "Name not provided";
        // hide receiverMeta if banks loaded from backend (per your request)
        if (loadedFromBackend) receiverMeta.style.display = 'none';
        else {
          receiverMeta.style.display = 'block';
          receiverMeta.textContent = `Account: ${currentAccount} • Bank: ${bankCode}`;
        }
        amountSection.classList.remove("hidden");
        sendSection.classList.remove("hidden");
        return;
      }

      if (result.httpStatus === 200 && payload && payload.data && (payload.data.account_name || (payload.data.data && payload.data.data.account_name))) {
        const acctName = extractAccountName(payload.data);
        receiverUsername = acctName || "";
        receiverName.textContent = acctName || "Name not provided";
        if (loadedFromBackend) receiverMeta.style.display = 'none';
        else {
          receiverMeta.style.display = 'block';
          receiverMeta.textContent = `Account: ${currentAccount} • Bank: ${bankCode}`;
        }
        amountSection.classList.remove("hidden");
        sendSection.classList.remove("hidden");
        return;
      }

      let msg = "Account not found or verification failed";
      if (payload && payload.message) msg = payload.message;
      else if (payload && payload.error) msg = payload.error;
      else if (payload && payload.details) msg = payload.details;

      receiverName.textContent = "❌ " + msg;
      receiverMeta.style.display = 'block';
      receiverMeta.textContent = `HTTP ${result.httpStatus}`;
    });

    // fetch balance helper
    async function fetchBalance() {
      if (!currentUser || !currentUser.phone) return 0;
      try {
        const res = await fetch(`${BACKEND_URL}/balance/${currentUser.phone}`);
        const data = await res.json().catch(()=>null);
        if (res.ok && data && (data.balance !== undefined)) {
          localStorage.setItem("balance", data.balance);
          return parseFloat(data.balance);
        }
      } catch (e) { dbg("fetchBalance error", e); }
      return parseFloat(localStorage.getItem("balance")) || 0;
    }

    // show result modal (success or fail). details object may contain fields returned by backend.
    function showResultModal(opts){
      // opts: { success: true|false, amount, message, details: {date,sender, sender_account, bank_name, recipient, recipient_account, transaction_no, bank_code} }
      resultRoot.innerHTML = "";
      const overlay = document.createElement('div');
      overlay.className = 'result-overlay';

      const card = document.createElement('div');
      card.className = 'result-card';

      // header
      const header = document.createElement('div');
      header.className = 'result-header';

      const badge = document.createElement('div');
      badge.className = 'badge ' + (opts.success ? 'success' : 'fail');
      badge.textContent = opts.success ? '₦' : '✕';

      const titleText = document.createElement('div');
      titleText.style.fontSize = '14px';
      titleText.style.color = '#666';
      titleText.textContent = opts.success ? 'Money received' : 'Transaction';

      const amountEl = document.createElement('div');
      amountEl.className = 'result-amount';
      amountEl.textContent = (opts.amount !== undefined) ? formatCurrency(opts.amount) : '';

      const statusEl = document.createElement('div');
      statusEl.className = opts.success ? 'status-success' : 'status-fail';
      statusEl.textContent = opts.success ? 'Successful' : 'Failed';

      header.appendChild(badge);
      header.appendChild(titleText);
      header.appendChild(amountEl);
      header.appendChild(statusEl);

      card.appendChild(header);

      // details grid
      const details = opts.details || {};
      const grid = document.createElement('div');
      grid.className = 'result-details';

      // helper to add a detail row
      function addDetail(label, value){
        const row = document.createElement('div');
        row.className = 'detail-row';
        const l = document.createElement('div'); l.className = 'detail-label'; l.textContent = label;
        const v = document.createElement('div'); v.className = 'detail-value'; v.textContent = value || '-';
        row.appendChild(l); row.appendChild(v);
        grid.appendChild(row);
      }

      // compose rows
      addDetail('Order amount', (opts.amount !== undefined) ? formatCurrency(opts.amount) : '-');
      addDetail('Date/Time', details.date || new Date().toLocaleString());
      addDetail('Sender', (details.sender || (currentUser && (currentUser.name || currentUser.username || currentUser.fullname))) || '-');
      addDetail('Sender Account', details.sender_account || (currentUser && (currentUser.account_number || currentUser.acc_number || currentUser.phone)) || '-');

      // Bank name: prefer name from bank list
      const bankNameFromList = getBankName(details.bank_code || details.bank_name || '');
      const bankDisplayName = bankNameFromList || details.bank_name || details.bank_code || '-';
      addDetail('Bank Name', bankDisplayName);

      addDetail('Recipient', details.recipient || (receiverUsername || currentAccount) || '-');
      addDetail('Recipient Account', details.recipient_account || currentAccount || '-');
      addDetail('Transaction NO.', details.transaction_no || (details.txn || details.transaction_id) || '-');

      card.appendChild(grid);

      // actions
      const actions = document.createElement('div');
      actions.className = 'result-actions';
      const viewBtn = document.createElement('button');
      viewBtn.className = 'btn-outline';
      viewBtn.textContent = 'View Transactions';
      viewBtn.addEventListener('click', () => { window.location.href = 'transactions.html'; });

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn-cancel';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.addEventListener('click', () => { if (overlay.parentNode) overlay.parentNode.removeChild(overlay); });

      actions.appendChild(viewBtn);
      actions.appendChild(cancelBtn);
      card.appendChild(actions);

      overlay.appendChild(card);
      resultRoot.appendChild(overlay);
      viewBtn.focus();
    }

    function formatCurrency(n){
      try {
        const v = Number(n);
        return '₦' + v.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
      } catch(e){ return '₦' + n; }
    }

    // Send money handler
    sendBtn.addEventListener("click", async function(){
      const amountEl = document.getElementById("amount");
      const amount = Number(amountEl.value);
      const bankCode = bankSelect.value;
      const acct = currentAccount;

      if (!acct || acct.length !== 10) {
        showResultModal({ success:false, amount: amount, message: "Enter a valid 10-digit receiver account", details:{}, });
        return;
      }
      if (!bankCode) {
        showResultModal({ success:false, amount: amount, message: "Please select a bank", details:{} });
        return;
      }
      if (!amount || Number.isNaN(amount) || amount <= 0) {
        showResultModal({ success:false, amount: amount, message: "Enter a valid amount", details:{} });
        return;
      }

      const balance = await fetchBalance();
      if (amount > balance) {
        showResultModal({ success:false, amount: amount, message: "Insufficient funds", details:{} });
        return;
      }

      try {
        const res = await fetch(`${BACKEND_URL}/send_money`, {
          method: "POST",
          headers: {"Content-Type":"application/json","Accept":"application/json"},
          body: JSON.stringify({
            sender_phone: (currentUser && currentUser.phone) || null,
            receiver_acc: acct,
            amount: amount,
            receiver_bank: bankCode
          })
        });
        const body = await res.json().catch(()=>null);

        if (res.ok && body && (body.status === "success" || body.success === true)) {

          // Decide internal PayMe bank by code "00023"
          const chosenBankName = getBankName(bankCode) || (body && body.bank_name) || '';
          const INTERNAL_BANK_CODE = '00023';
          const isInternalBank = String(bankCode) === INTERNAL_BANK_CODE;

          // Update local user balance (subtract sender's amount regardless)
          let user = JSON.parse(localStorage.getItem("loggedInUser"));
          if (!user) user = JSON.parse(localStorage.getItem("user")) || {};
          try { user.balance = parseFloat(balance) - parseFloat(amount); } catch(e){ user.balance = user.balance ? (user.balance - amount) : null; }
          localStorage.setItem("loggedInUser", JSON.stringify(user));
          localStorage.setItem("user", JSON.stringify(user));

          // save transaction locally
          let transactions = JSON.parse(localStorage.getItem("transactions")) || [];
          transactions.push({
            type: "Transfer Out",
            amount: amount,
            description: "Transfer to " + (receiverUsername || acct) + " (" + (chosenBankName || bankCode) + ")",
            date: new Date().toLocaleString(),
            backend_id: body.transaction_id || body.txn || null
          });
          localStorage.setItem("transactions", JSON.stringify(transactions));

          // show the success-style result modal. Pass backend details when possible.
          showResultModal({
            success: true,
            amount: amount,
            message: body.message || body.msg || "Transfer completed successfully.",
            details: {
              date: new Date().toLocaleString(),
              sender: body.sender_name || (currentUser && (currentUser.name || currentUser.username)) || '',
              sender_account: body.sender_account || (currentUser && (currentUser.account_number || currentUser.acc_number || currentUser.phone)) || '',
              bank_name: chosenBankName || bankCode,
              recipient: body.recipient_name || receiverUsername || '',
              recipient_account: body.recipient_account || acct,
              transaction_no: body.transaction_id || body.txn || null,
              bank_code: bankCode
            }
          });

          amountEl.value = "";

        } else {
          const msg = (body && (body.message || body.error || body.msg)) ? (body.message || body.error || body.msg) : "Transfer failed.";
          showResultModal({
            success: false,
            amount: amount,
            message: msg,
            details: {
              date: new Date().toLocaleString(),
              bank_name: getBankName(bankCode) || bankCode,
              recipient: receiverUsername || acct,
              recipient_account: acct,
              transaction_no: body && (body.transaction_id || body.txn) || null,
              bank_code: bankCode
            }
          });
        }
      } catch (err) {
        dbg("send error", err);
        showResultModal({ success:false, amount:amount, message: "Error connecting to server.", details:{} });
      }
    });

    // ESC key to close bank modal
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (!bankModal.classList.contains("hidden")) closeBankModal();
      }
    });
  </script>
</body>
</html>
