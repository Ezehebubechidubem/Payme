<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Savings Page</title>
  <style>
  /* --- base / layout --- */
  :root {
    --bg: #f3f3f3;
    --card-bg: #fff;
    --primary: #00c853;
    --muted: #666;
    --danger: #e53935;
  }

  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    background: var(--bg);
    font-family: Arial, sans-serif;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Container is responsive and fits any screen */
  .container {
    width: 100%;
    max-width: 920px;          /* nice max width on large screens */
    margin: 12px auto;         /* small top/bottom margin */
    padding: 12px;
    box-sizing: border-box;
    min-height: calc(100vh - 24px); /* ensures full-screen feel on mobile */
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  h2 {
    text-align: center;
    color: #333;
    margin: 6px 0 0 0;
  }

  .card {
    background: var(--card-bg);
    padding: 14px;
    border-radius: 10px;
    box-shadow: 0px 3px 6px rgba(0,0,0,0.06);
    box-sizing: border-box;
    width: 100%;
    overflow: hidden;
  }

  /* Form controls: full width and mobile-friendly */
  form label { display:block; margin:10px 0 6px; color:var(--muted) }
  form input, form select {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 15px;
    box-sizing: border-box;
  }
  button {
    background: var(--primary);
    color: white;
    padding: 10px;
    border: none;
    width: 100%;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    font-size: 15px;
  }
  button:hover { background: #018f44 }

  .action-container { display:flex; gap:8px; justify-content:center; align-items:center; }

  .back-btn { background:#007bff; margin-top:6px; }
  .back-btn:hover { background:#0056b3 }

  .disabled-btn { background:#ccc !important; cursor:not-allowed }

  /* Table area: responsive and constrained to viewport */
  .table-wrap {
    width: 100%;
    box-sizing: border-box;
    margin-top: 12px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #eee;
    background: #fff;
  }

  /* Scrollable area that fits the screen: will not exceed viewport */
  #savingsScroll {
    max-height: calc(50vh); /* initial; will scroll independently */
    overflow:auto;
  }

  /* Table styles adapted to be responsive */
  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed; /* prevent horizontal overflow */
    min-width: 100%;
  }
  thead th {
    background: #fafafa;
    position: sticky;
    top: 0;
    z-index: 1;
    padding: 10px;
    text-align:center;
    font-size: 13px;
    color: #333;
    border-bottom: 1px solid #eee;
  }
  tbody td {
    padding: 10px;
    border-bottom: 1px solid #f1f1f1;
    text-align: center;
    font-size: 14px;
    word-break: break-word; /* avoid overflow */
  }

  /* "See more" holder */
  .show-more-wrap {
    display:flex;
    justify-content:center;
    padding:10px;
    background:#fff;
    border-top:1px solid #eee;
  }
  .show-more-btn {
    background:#fff;
    border:1px solid #ddd;
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer;
    font-weight:700;
  }
  .show-more-btn:hover { background:#fafafa }

  /* Modal popup styles (used to replace alerts) */
  .modal-overlay {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.45);
    z-index: 9999;
  }
  .modal-overlay.show { display:flex; }
  .modal {
    width: calc(100% - 48px);
    max-width: 420px;
    background: #fff;
    border-radius: 12px;
    padding: 18px;
    box-shadow: 0 18px 40px rgba(10,20,30,0.15);
    text-align:center;
  }
  .modal .badge { width:68px; height:68px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:32px; margin-bottom:12px; color:#fff; }
  .modal .badge.success { background: linear-gradient(135deg,#00c853,#43a047); }
  .modal .badge.error { background: linear-gradient(135deg,#f44336,#e53935); }
  .modal h3 { margin:6px 0 6px; font-size:18px; }
  .modal p { margin: 0 0 12px; color:#555; }
  .modal .actions { display:flex; gap:10px; justify-content:center; margin-top:12px; }
  .modal .btn { padding:10px 14px; border-radius:8px; cursor:pointer; border:0; font-weight:700; }
  .modal .btn-outline { background:#fff; border:1px solid #ddd; color:#333; }
  .modal .btn-primary { background:var(--primary); color:#fff; border:0; }

  /* small screen tweaks */
  @media (max-width: 600px) {
    #savingsScroll { max-height: calc(55vh); }
    .container { padding:10px; }
    .card { padding:12px; }
    input, select { font-size: 14px; padding:9px; }
    thead th, tbody td { font-size: 13px; padding:8px; }
  }
  </style>
</head>
<body>
  <div class="container">
    <h2>💰 Savings Dashboard</h2>

    <!-- Create Savings -->
    <div class="card">
      <h3>Create Savings</h3>
      <form id="savingsForm">
        <label>Amount</label>
        <input type="number" id="amount" required>

        <label>Type</label>
        <select id="savingsType">
          <option value="flexible">Flexible</option>
          <option value="fixed">Fixed</option>
        </select>

        <label>Duration</label>
        <select id="duration">
          <option value="7">7 Days</option>
          <option value="30">30 Days</option>
          <option value="60">60 Days</option>
          <option value="180">180 Days</option>
          <option value="365">1 Year</option>
          <option value="730">2 Years</option>
          <option value="1095">3 Years</option>
        </select>

        <button type="submit">Start Saving</button>
      </form>
    </div>

    <!-- Active Savings -->
    <div class="card">
      <h3>Active Savings</h3>

      <!-- table wrapper (scrollable, constrained) -->
      <div class="table-wrap">
        <div id="savingsScroll" tabindex="0" aria-label="Savings list">
          <table aria-describedby="savings caption">
            <thead>
              <tr>
                <th>Amount</th>
                <th>Type</th>
                <th>End Date</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="savingsTable"></tbody>
          </table>
        </div>

        <!-- show more holder (initially hidden; shown when more than 5 items exist) -->
        <div class="show-more-wrap" id="showMoreWrap" style="display:none">
      <button id="showMoreBtn" class="show-more-btn" style="background:#00c853;color:#ffffff;border:1px solid #00a853;padding:8px 12px;border-radius:8px;cursor:pointer;"><strong style="color:inherit;">See more</strong></button>
        </div>
      </div>
    </div>

    <!-- Back button -->
    <button class="back-btn" onclick="window.location.href='paymelogin.html'">⬅ Back to Dashboard</button>
  </div>

  <!-- SUCCESS / ERROR POPUPS (replace alert) -->
  <div id="successModal" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="badge success">✓</div>
      <h3 id="successTitle">Success</h3>
      <p id="successMessage">Operation completed</p>
      <div class="actions">
        <button id="successOk" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <div id="errorModal" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="alertdialog" aria-modal="true">
      <div class="badge error">✕</div>
      <h3 id="errorTitle">Error</h3>
      <p id="errorMessage">Something went wrong</p>
      <div class="actions">
        <button id="errorOk" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // CONFIG: your backend base URL (unchanged)
    const API_BASE = "https://payme-update.onrender.com";

    // modal helpers (replace alert)
    const successModal = document.getElementById('successModal');
    const successTitle = document.getElementById('successTitle');
    const successMessage = document.getElementById('successMessage');
    const successOk = document.getElementById('successOk');

    const errorModal = document.getElementById('errorModal');
    const errorTitle = document.getElementById('errorTitle');
    const errorMessage = document.getElementById('errorMessage');
    const errorOk = document.getElementById('errorOk');

    function showSuccess(message, title = "Success", onOk = null) {
      successTitle.textContent = title;
      successMessage.textContent = message || "";
      successModal.classList.add('show');
      successModal.setAttribute('aria-hidden','false');
      successOk.focus();
      successOk.onclick = function() {
        successModal.classList.remove('show');
        successModal.setAttribute('aria-hidden','true');
        successOk.onclick = null;
        if (typeof onOk === "function") { try { onOk(); } catch(e){ console.warn(e); } }
      };
    }
    function showError(message, title = "Error", onOk = null) {
      errorTitle.textContent = title;
      errorMessage.textContent = message || "";
      errorModal.classList.add('show');
      errorModal.setAttribute('aria-hidden','false');
      errorOk.focus();
      errorOk.onclick = function() {
        errorModal.classList.remove('show');
        errorModal.setAttribute('aria-hidden','true');
        errorOk.onclick = null;
        if (typeof onOk === "function") { try { onOk(); } catch(e){ console.warn(e); } }
      };
    }

    // countdown intervals map
    const countdownMap = new Map();

    // read stored user from localStorage (both keys for compatibility)
    function readStoredUser() {
      const raw = localStorage.getItem("loggedInUser") || localStorage.getItem("user");
      if (!raw) return null;
      try { return JSON.parse(raw); } catch (e) { return null; }
    }

    // persist user to both keys so other pages pick updated balance/id
    function persistUser(userObj) {
      try {
        localStorage.setItem("loggedInUser", JSON.stringify(userObj));
        localStorage.setItem("user", JSON.stringify(userObj));
      } catch (e) {
        console.warn("Could not persist user to localStorage", e);
      }
    }

    // If login didn't save id, fetch /user/:phone to get id and balance
    async function ensureUserHasId(u) {
      if (!u) return null;
      if (u.id) return u;
      if (!u.phone) return u;
      try {
        const res = await fetch(`${API_BASE}/user/${encodeURIComponent(u.phone)}`);
        if (!res.ok) {
          console.warn("Could not fetch user details:", res.status);
          return u;
        }
        const data = await res.json();
        if (data && data.status === "success" && data.user) {
          const newUser = Object.assign({}, u, data.user);
          persistUser(newUser);
          return newUser;
        }
        return u;
      } catch (err) {
        console.warn("Network error while fetching user details:", err);
        return u;
      }
    }

    function toFloat(v) { const n = parseFloat(v); return isNaN(n) ? 0 : n; }
    function toInt(v) { const n = parseInt(v, 10); return isNaN(n) ? 0 : n; }

    // refresh stored balance from backend
    async function refreshStoredBalance(user) {
      if (!user || !user.phone) return;
      try {
        const res = await fetch(`${API_BASE}/balance/${encodeURIComponent(user.phone)}`);
        if (!res.ok) return;
        const d = await res.json();
        if (typeof d.balance !== "undefined") {
          user.balance = Number(d.balance);
          persistUser(user);
        }
      } catch (err) {
        // ignore network error
      }
    }

    // clear countdown intervals
    function clearCountdowns() {
      for (const id of countdownMap.keys()) {
        clearInterval(countdownMap.get(id));
      }
      countdownMap.clear();
    }

    // Start countdown for a row; when finishes reload savings to allow backend sweep
    function startCountdownForRow(id, endDate, user) {
      const timerEl = document.getElementById(`timer-${id}`);
      if (!timerEl) return;

      if (countdownMap.has(id)) {
        clearInterval(countdownMap.get(id));
        countdownMap.delete(id);
      }

      function update() {
        const now = new Date();
        const distance = new Date(endDate) - now;
        if (distance <= 0) {
          timerEl.innerText = "✅ Completed";
          if (countdownMap.has(id)) {
            clearInterval(countdownMap.get(id));
            countdownMap.delete(id);
          }
          // small delay to let backend sweep matured savings, then reload
          setTimeout(() => loadSavings(user), 600);
          return;
        }
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance / (1000 * 60 * 60)) % 24);
        const mins = Math.floor((distance / (1000 * 60)) % 60);
        const secs = Math.floor((distance / 1000) % 60);
        timerEl.innerText = `${days}d ${hours}h ${mins}m ${secs}s`;
      }

      update();
      const iv = setInterval(update, 1000);
      countdownMap.set(id, iv);
    }

    // --- Pagination state for savings list (show 5 last items initially) ---
    const PAGE_SIZE = 5;
    let allSavings = [];      // full list returned from backend (most recent first)
    let displayedCount = 0;   // how many currently rendered
    let isExpanded = false;   // toggle state for See more / See less
    const savingsTable = document.getElementById("savingsTable");
    const showMoreWrap = document.getElementById("showMoreWrap");
    const showMoreBtn = document.getElementById("showMoreBtn");
    const savingsScroll = document.getElementById("savingsScroll");

    // render a specific window (0 .. displayedCount-1) from allSavings
    function renderSavingsSlice(user) {
      // clear table
      savingsTable.innerHTML = "";
      if (!allSavings || allSavings.length === 0) {
        savingsTable.innerHTML = `<tr><td colspan="5">No savings found</td></tr>`;
        showMoreWrap.style.display = 'none';
        return;
      }

      // ensure displayedCount does not exceed length
      displayedCount = Math.min(displayedCount || PAGE_SIZE, allSavings.length);

      const visible = allSavings.slice(0, displayedCount);

      for (const s of visible) {
        const id = s.id;
        const amount = s.amount;
        const type = s.savings_type || s.type || "flexible";
        const endRaw = s.end_date || s.endDate || s.end || null;
        const endDate = endRaw ? new Date(endRaw) : null;
        const status = (s.status || "").toString().toLowerCase();
        const canWithdraw = typeof s.can_withdraw !== "undefined" ? !!s.can_withdraw : null;

        let statusText = "Active";
        if (status === "withdrawn") statusText = "✅ Withdrawn";
        else if (endDate && endDate <= new Date()) statusText = "Completed";

        let actionHtml = "";
        if (status === "withdrawn") {
          actionHtml = `<button class="disabled-btn" disabled>Withdrawn</button>`;
        } else if (canWithdraw === true) {
          actionHtml = `<button data-id="${id}" class="withdraw-btn">Withdraw</button>`;
        } else if (canWithdraw === false) {
          actionHtml = `<button class="disabled-btn" disabled>Locked</button>`;
        } else {
          if (type === "flexible") {
            actionHtml = `<button data-id="${id}" class="withdraw-btn">Withdraw</button>`;
          } else if (type === "fixed") {
            if (endDate && endDate <= new Date()) {
              actionHtml = `<button data-id="${id}" class="withdraw-btn">Withdraw</button>`;
            } else {
              actionHtml = `<button class="disabled-btn" disabled>Locked</button>`;
            }
          } else {
            actionHtml = `<button class="disabled-btn" disabled>Locked</button>`;
          }
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${amount}</td>
          <td>${type}</td>
          <td>${endDate ? endDate.toLocaleString() : "-"}</td>
          <td id="timer-${id}">${statusText}</td>
          <td>
            <div class="action-container">
              ${actionHtml}
            </div>
          </td>
        `;
        savingsTable.appendChild(tr);

        // attach withdraw handler if button exists
        const btn = tr.querySelector("button.withdraw-btn");
        if (btn) {
          btn.addEventListener("click", async function () {
            const sid = toInt(this.getAttribute("data-id"));
            this.disabled = true;
            this.classList.add("disabled-btn");
            await handleWithdraw(user, sid, amount, type, id);
          });
        }

        // start countdown if there is an end date and not withdrawn
        if (status !== "withdrawn" && endDate) {
          startCountdownForRow(id, endDate, user);
        }
      }

      // manage "see more/see less" button visibility and label
      if (allSavings.length > PAGE_SIZE) {
        showMoreWrap.style.display = 'flex';
        // if currently expanded show "See less", else "See more"
        showMoreBtn.textContent = isExpanded ? "See less" : "See more";
        // if we've loaded all items by other means, reflect that state
        if (displayedCount >= allSavings.length) {
          isExpanded = true;
          showMoreBtn.textContent = "See less";
        } else if (displayedCount <= PAGE_SIZE) {
          isExpanded = false;
          showMoreBtn.textContent = "See more";
        }
      } else {
        showMoreWrap.style.display = 'none';
      }
    }

    // show next page of savings (increments displayedCount by PAGE_SIZE)
    function showNextSavingsPage(user) {
      if (!allSavings || displayedCount >= allSavings.length) return;
      displayedCount = Math.min(displayedCount + PAGE_SIZE, allSavings.length);
      // if after loading we have everything, mark expanded
      if (displayedCount >= allSavings.length) isExpanded = true;
      renderSavingsSlice(user);
    }

    // show all or collapse
    function toggleSeeMore(user) {
      if (!allSavings || allSavings.length === 0) return;
      if (!isExpanded) {
        // expand to show all
        displayedCount = allSavings.length;
        isExpanded = true;
        showMoreBtn.textContent = "See less";
        renderSavingsSlice(user);
        // scroll to top of the saved list for clarity
        savingsScroll.scrollTop = 0;
      } else {
        // collapse to initial page size
        displayedCount = Math.min(PAGE_SIZE, allSavings.length);
        isExpanded = false;
        showMoreBtn.textContent = "See more";
        renderSavingsSlice(user);
        savingsScroll.scrollTop = 0;
      }
    }

    // visible threshold detection for scroll (auto-load next page)
    let isLoadingMore = false;
    savingsScroll.addEventListener('scroll', function() {
      if (isLoadingMore) return;
      const scrolled = savingsScroll.scrollTop + savingsScroll.clientHeight;
      const nearBottom = scrolled + 40 >= savingsScroll.scrollHeight;
      if (nearBottom && allSavings && displayedCount < allSavings.length && !isExpanded) {
        isLoadingMore = true;
        setTimeout(() => {
          showNextSavingsPage(currentUserGlobal);
          isLoadingMore = false;
        }, 250);
      }
      // if user scrolled enough to load all items via auto load, update toggle state
      if (allSavings && displayedCount >= allSavings.length) {
        isExpanded = true;
        showMoreBtn.textContent = "See less";
      }
    });

    // attach show more button
    showMoreBtn.addEventListener('click', function(){
      toggleSeeMore(currentUserGlobal);
    });

       // loadSavings now fetches entire list, stores in allSavings and renders the first page
    let currentUserGlobal = null;
    async function loadSavings(user) {
      if (!user || !user.id) {
        console.error("loadSavings called without user id");
        return;
      }

      clearCountdowns();
      savingsTable.innerHTML = `<tr><td colspan="5">Loading...</td></tr>`;

      try {
        const res = await fetch(`${API_BASE}/savings/list/${encodeURIComponent(user.id)}`);
        if (!res.ok) {
          let errText = `Failed to load savings (${res.status})`;
          try {
            const j = await res.json();
            if (j && j.message) errText = j.message;
          } catch(e){}
          savingsTable.innerHTML = `<tr><td colspan="5">${errText}</td></tr>`;
          return;
        }

        const json = await res.json();
        const rows = (json && json.savings) ? json.savings : [];
        // sort rows by id descending (most recent first) — backend already does that but ensure it
        rows.sort((a,b) => (b.id || 0) - (a.id || 0));
        allSavings = rows;
        displayedCount = Math.min(PAGE_SIZE, allSavings.length);
        isExpanded = false;
        currentUserGlobal = user;
        renderSavingsSlice(user);
      } catch (err) {
        console.error("Error loading savings:", err);
        savingsTable.innerHTML = `<tr><td colspan="5">Error loading savings</td></tr>`;
      }
    }

    // withdraw handler (unchanged logic except alerts replaced with modal)
    async function handleWithdraw(user, savingsId, amount, type, rowId) {
      if (!user || !user.id) {
        showError("User not ready. Try logging in again.", "User not ready");
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/savings/withdraw`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: user.id, savings_id: savingsId })
        });
        const json = await res.json();

        if (json && json.status === "success") {
          const timerEl = document.getElementById(`timer-${savingsId}`);
          if (timerEl) timerEl.innerText = "✅ Withdrawn";
          const btn = document.querySelector(`button[data-id="${savingsId}"]`);
          if (btn) { btn.disabled = true; btn.classList.add("disabled-btn"); btn.innerText = "Withdrawn"; }

          await refreshStoredBalance(user);

          showSuccess(json.message || `₦${amount} withdrawn and credited to main balance.`, "Withdrawn", function(){
            setTimeout(() => loadSavings(user), 800);
          });
        } else {
          const msg = (json && json.message) ? json.message : "Withdrawal failed";
          showError("❌ " + msg, "Withdraw failed", function(){
            setTimeout(() => loadSavings(user), 500);
          });
        }
      } catch (err) {
        console.error("Withdraw error:", err);
        showError("❌ Withdraw failed (network error)", "Network error", function(){
          setTimeout(() => loadSavings(user), 500);
        });
      }
    }

    // create savings (same behavior but alerts replaced)
    async function handleCreateSavings(user, amount, savingsType, durationDays) {
      if (!user) {
        showError("Please login first", "Authentication required");
        return;
      }
      if (toFloat(amount) <= 0) {
        showError("Amount must be > 0", "Invalid amount");
        return;
      }
      if (!["flexible","fixed"].includes(savingsType)) {
        showError("Invalid savings type", "Invalid input");
        return;
      }
      if (toInt(durationDays) <= 0) {
        showError("Invalid duration", "Invalid input");
        return;
      }

      try {
        const payload = {
          user_id: user.id,
          phone: user.phone,
          amount: toFloat(amount),
          savings_type: savingsType,
          duration_days: toInt(durationDays)
        };

        const res = await fetch(`${API_BASE}/savings/create`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const json = await res.json();

        if (json && json.status === "success") {
          await refreshStoredBalance(user);
          showSuccess(json.message || "Savings created", "Saved", function(){
            setTimeout(() => loadSavings(user), 300);
          });
        } else {
          showError("❌ " + (json && json.message ? json.message : "Could not create savings"), "Create failed");
        }
      } catch (err) {
        console.error("Create savings error:", err);
        showError("❌ Create failed (network error)", "Network error");
      }
    }

    // goBack preserved (some variants of your markup call window.goBack)
    function goBack() {
      window.location.href = "paymelogin.html";
    }
    window.goBack = goBack;

    // init wiring
    async function init() {
      let stored = readStoredUser();
      if (!stored) {
        showError("Please login first", "Not logged in", function(){
          window.location.href = "login.html";
        });
        return;
      }

      const user = await ensureUserHasId(stored);
      if (!user || !user.id) {
        showError("Could not determine your user id. Please login again.", "User error", function(){
          window.location.href = "login.html";
        });
        return;
      }

      // wire form submit
      const form = document.getElementById("savingsForm");
      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        const amount = document.getElementById("amount").value;
        const savingsType = document.getElementById("savingsType").value;
        const duration = document.getElementById("duration").value;
        await handleCreateSavings(user, amount, savingsType, duration);
      });

      await refreshStoredBalance(user);

      // initial load of savings -> allSavings will be populated; render first 5
      await loadSavings(user);

      // clear timers when user navigates away (prevent leaking intervals)
      window.addEventListener("beforeunload", () => clearCountdowns());
    }

    // Start
    init();
  })();
  </script>
</body>
</html>
