<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PAYME — Agent</title>

  <!-- Font Awesome (icons) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <style>
    :root{
      --primary:#00c853;
      --primary-dark:#009624;
      --bg:#ffffff;
      --card:#ffffff;
      --muted:#777;
      --soft:#e8f5e9;
      --line:#e0e0e0;
      --badge:#ff3b30;
      --text:#1b1b1b;
      --toast-bg: rgba(0,0,0,0.75);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      padding-bottom:84px;
    }
    .app{max-width:440px;margin:0 auto}
    .topbar{
      background:var(--card);
      padding:14px 16px 12px;
      display:flex;align-items:center;gap:12px;
      border-bottom:1px solid var(--line);
      position:sticky;top:0;z-index:10;
    }
    .avatar{width:34px;height:34px;border-radius:50%;
      background:linear-gradient(135deg,#222,#666);flex:0 0 auto;}
    .hello{line-height:1.1}
    .hello .hi{font-weight:700;font-size:15px}
    .hello .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .topbar-actions{margin-left:auto;display:flex;align-items:center;gap:14px}
    .icon-btn{position:relative;font-size:18px;color:var(--muted);cursor:pointer}
    .badge{position:absolute;top:-6px;right:-8px;background:var(--badge);color:#fff;
      font-size:10px;font-weight:700;line-height:1;padding:3px 5px;border-radius:10px;}
    .card{background:var(--soft);margin:12px; padding:14px; border-radius:14px;
      box-shadow:0 1px 0 rgba(0,0,0,.02) inset;}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .label{font-size:12px;color:#555;display:flex;align-items:center;gap:6px}
    .label i{font-size:12px}
    .amount{margin-top:4px;font-weight:800;font-size:26px;color:var(--primary-dark);
      display:flex;align-items:center;gap:6px}
    .chip-link{font-size:12px;color:#555;display:flex;align-items:center;gap:6px}
    .ghost-link{font-weight:600;color:var(--primary-dark)}
    .btn{background:var(--primary);color:#fff;border:0;cursor:pointer;
      padding:10px 16px;border-radius:22px;font-weight:700;font-size:13px}
    .btn:hover{background:var(--primary-dark)}
    .inline-promo{margin-top:12px;background:#fff;border-radius:10px;
      padding:10px 12px;display:flex;align-items:center;gap:10px}
    .inline-promo .dot{flex:0 0 auto;width:18px;height:18px;border-radius:50%;
      background:#c8e6c9;display:grid;place-items:center;color:var(--primary);font-size:11px}
    .inline-promo .text{font-size:13px;color:#333}
    .inline-promo .link{margin-left:auto;display:flex;align-items:center;gap:8px;color:var(--primary);font-weight:700}
    .quick{background:var(--card);margin:0 12px;border-radius:14px;padding:14px 8px;
      display:grid;grid-template-columns:repeat(4,1fr);text-align:center;gap:10px}
    .qa{display:flex;flex-direction:column;align-items:center;gap:6px;font-size:13px;color:#333}
    .qa i{font-size:20px;color:var(--primary)}
    .promo-card{margin:12px;background:var(--card);border-radius:14px;padding:14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px; position:relative; overflow:hidden}
    .promo-card .title{font-weight:800;color:#2e7d32}
    .promo-card .sub{font-size:12px;color:#666;margin-top:2px}
    .outline{border:1px solid var(--primary);background:#fff;color:var(--primary);padding:8px 14px;border-radius:18px;font-weight:700;cursor:pointer}
    .services{margin:12px;background:var(--card);border-radius:14px;padding:14px}
    .services .head{display:flex;align-items:center;justify-content:space-between}
    .services .head h3{font-size:16px}
    .services .more{color:#666;display:flex;align-items:center;gap:6px;font-size:13px}
    .grid{margin-top:12px;display:grid;grid-template-columns:repeat(4,1fr);gap:18px 12px}
    .svc{text-align:center;font-size:12.5px;color:#333;cursor:pointer}
    .svc i{display:block;margin:0 auto 6px;font-size:20px;color:var(--primary)}
    .big-banner{margin:12px;background:linear-gradient(135deg,#00c853,#43a047);
      color:#fff;border-radius:14px;padding:16px;text-align:center}
    .big-banner h2{font-size:18px;font-weight:900;letter-spacing:.2px}
    .tag{display:inline-block;background:#ffec66;color:#2e2e2e;border-radius:16px;padding:7px 12px;font-weight:800;margin-top:10px}
    .refer{margin:12px;background:var(--card);border-radius:14px;padding:14px;
      display:flex;align-items:center;justify-content:space-between}
    .refer h4{font-size:15px}
    .refer p{font-size:13px;color:#666;margin-top:3px}
    .refer .go{background:var(--primary);color:#fff;border:0;border-radius:18px;padding:8px 16px;font-weight:700}
    .bottom{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line);
      display:grid;grid-template-columns:repeat(5,1fr);padding:8px 0;z-index:20}
    .nav-item{text-align:center;font-size:11px;color:#666}
    .nav-item i{display:block;font-size:18px;margin-bottom:2px;color:#666}
    .nav-item.active, .nav-item.active i{color:#000}
    a{text-decoration:none;color:inherit}
    button{font:inherit}

    /* agent-specific account block inside promo area */
    .agent-account {
      display:flex;
      gap:12px;
      align-items:center;
      width:100%;
      justify-content:space-between;
    }
    .acct-left {
      display:flex;
      gap:12px;
      align-items:center;
      flex:1;
      min-width:0;
    }
    .acct-badge {
      width:68px;height:68px;border-radius:10px;background:linear-gradient(135deg,#e8f5e9,#c8e6c9);
      display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--primary-dark);
      font-size:18px;flex:0 0 68px;
    }
    .acct-info { min-width:0; }
    .acct-label { font-size:12px;color:#666; }
    .acct-number { font-weight:900;font-size:18px;color:var(--primary-dark); overflow:hidden;text-overflow:ellipsis;white-space:nowrap; }
    .acct-owner { font-size:12px;color:#666;margin-top:4px; }

    .acct-actions { display:flex; gap:8px; align-items:center; justify-content:flex-end; }
    .copy-btn { background:var(--primary); color:#fff; border-radius:10px; padding:8px 10px; font-weight:700; cursor:pointer; border:0; }
    .small-ghost { border:1px solid var(--line); padding:8px 10px; border-radius:10px; background:#fff; cursor:pointer; }

    /* modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; z-index:60; }
    .modal { width:92%; max-width:420px; background:#fff; border-radius:12px; padding:16px; box-shadow:0 12px 30px rgba(0,0,0,0.15); }
    .modal h3{ margin-bottom:8px; font-size:18px; }
    .modal .acc-card { background:#f7fdf7; border:1px solid #e6f4e7; padding:12px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; }
    .modal .acc-card .left { overflow:hidden; min-width:0; }
    .modal .acc-card .acc-num { font-weight:900; color:var(--primary-dark); font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .modal .acc-card .acc-name { font-size:13px; color:#666; margin-top:4px; }
    .modal .modal-actions { display:flex; gap:10px; margin-top:12px; justify-content:flex-end; }

    /* toast */
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:94px; background:var(--toast-bg); color:#fff; padding:8px 12px; border-radius:10px; font-size:13px; display:none; z-index:80; }

    /* for responsive icon sizes */
    .qa i { font-size:22px; }
    .qa span{ font-size:12px; display:block; margin-top:4px; }
  </style>
  <script>
    // define API_BASE early so scripts can use it (adjust if needed)
    const API_BASE = "https://payme-update.onrender.com";
  </script>
</head>
<body>
  <div class="app">
    <!-- Top bar -->
    <header class="topbar">
      <div class="avatar" aria-hidden="true"></div>
      <div class="hello">
        <div class="hi"><a href="profile.html" id="hiUser">Hi, User</a></div>
        <div class="sub">Agent Dashboard — Serve customers & POS</div>
      </div>
      <div class="topbar-actions">
        <div class="icon-btn" title="Help"><i class="fa-solid fa-headset"></i></div>
        <div class="icon-btn" title="Notifications">
          <i class="fa-solid fa-bell"></i>
          <span class="badge" id="notifBadge">0</span>
        </div>
      </div>
    </header>

    <!-- Balance card -->
    <section class="card">
      <div class="row">
        <div>
          <div class="label"><i class="fa-regular fa-circle-question"></i> Available Balance</div>
          <div class="amount" id="balance">₦0.00</div>
        </div>
        <div style="text-align:right">
          <a class="chip-link" href="transactions.html"><span>Transaction History</span> <i class="fa-solid fa-angle-right"></i></a>
          <div style="margin-top:8px">
            <a href="addmoney.html" class="btn">Add Money</a>
          </div>
        </div>
      </div>

      <div class="inline-promo">
        <div class="dot"><i class="fa-solid fa-arrow-trend-up"></i></div>
        <div class="text">Agent earnings? Track daily float & commissions</div>
        <a href="#" class="link">Agent Tools <i class="fa-solid fa-angle-right"></i></a>
      </div>
    </section>

    <!-- Quick actions (agent) -->
    <section class="quick" aria-label="Agent quick actions">
      <!-- Cash Out (external) -->
      <a href="toWallet.html" style="text-decoration: none; color: inherit;">
        <div class="qa" title="Cash Out">
          <i class="fa-solid fa-money-bill-transfer"></i>
          <span>Cash Out</span>
        </div>
      </a>

      <!-- Transfer (to bank) -->
      <a href="tobank.html" style="text-decoration: none; color: inherit;">
        <div class="qa" title="Transfer to bank">
          <i class="fa-solid fa-arrow-right-arrow-left"></i>
          <span>Transfer</span>
        </div>
      </a>

      <!-- POS (Agent) -->
      <a href="pos.html" style="text-decoration: none; color: inherit;">
        <div class="qa" title="POS / Transactions">
          <i class="fa-solid fa-square-terminal"></i>
          <span>POS</span>
        </div>
      </a>

      <!-- Cash In (open modal showing account number to receive funds) -->
      <button class="qa" id="cashInBtn" style="background:none;border:0;cursor:pointer">
        <i class="fa-solid fa-wallet"></i>
        <span>Cash In</span>
      </button>
    </section>

    <!-- Promo / Agent account area (replaces announcement promo for agent) -->
    <section class="promo-card" id="promoCard">
      <div id="agentAccountBlock" class="agent-account" aria-live="polite">
        <div class="acct-left">
          <div class="acct-badge" aria-hidden="true">AG</div>
          <div class="acct-info">
            <div class="acct-label">Agent Receive Account</div>
            <div class="acct-number" id="agentAccountNumber">—</div>
            <div class="acct-owner" id="agentAccountName">No name</div>
          </div>
        </div>

        <div class="acct-actions">
          <button class="copy-btn" id="copyAcctBtn" title="Copy account number">
            <i class="fa-regular fa-copy"></i> Copy
          </button>
          <button class="small-ghost" id="refreshAcctBtn" title="Refresh from server">
            <i class="fa-solid fa-rotate-right"></i>
          </button>
        </div>
      </div>
    </section>

    <!-- Services -->
    <section class="services">
      <div class="head">
        <h3>Services</h3>
        <div class="more">
          <a href="services.html">More</a>
          <i class="fa-solid fa-angle-right"></i>
        </div>
      </div>
    </section>

    <div class="grid" aria-hidden="false">
      <div class="svc"><a href="airtime.html"><i class="fa-solid fa-phone"></i>Airtime</a></div>
      <div class="svc"><a href="Data.html"><i class="fa-solid fa-signal"></i>Data</a></div>
      <div class="svc"><div onclick="window.location.href='betting.html'"><i class="fa-solid fa-dice"></i>Betting</div></div>
      <div class="svc"><i class="fa-solid fa-bolt"></i>Electricity</div>
      <div class="svc"><i class="fa-solid fa-shield-halved"></i>Insurance</div>
      <div class="svc"><i class="fa-solid fa-coins"></i>Loan</div>
      <div class="svc"><i class="fa-solid fa-tv"></i>TV</div>
      <div class="svc"><i class="fa-solid fa-gift"></i>Refer & Earn</div>
      <div class="svc"><i class="fa-solid fa-money-bill"></i>Withdraw</div>
      <div class="svc"><i class="fa-solid fa-box"></i>CashBox</div>
      <div class="svc"><a href="savings.html"><i class="fa-solid fa-lightbulb"></i>SmartEarn</a></div>
      <div class="svc"><i class="fa-solid fa-store"></i>My Business Hub</div>
    </div>

    <!-- Big banner -->
    <section class="big-banner">
      <h2>Agent Float Management</h2>
      <div class="tag">Track POS & Agent Earnings</div>
    </section>

  </div>

  <!-- Bottom navigation -->
  <nav class="bottom">
    <a class="nav-item active" href="#"><i class="fa-solid fa-house"></i>Home</a>
    <a class="nav-item" href="#"><i class="fa-solid fa-credit-card"></i>Loan</a>
    <a class="nav-item" href="#"><i class="fa-solid fa-chart-line"></i>Wealth</a>
    <a class="nav-item" href="#"><i class="fa-solid fa-gift"></i>Reward</a>
    <a class="nav-item" href="profile.html"><i class="fa-solid fa-user"></i>Me</a>
  </nav>

  <!-- Cash-In Modal -->
  <div class="modal-backdrop" id="cashInModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <h3>Receive Cash (Account details)</h3>
      <div class="acc-card">
        <div class="left">
          <div class="acc-num" id="modalAcctNumber">—</div>
          <div class="acc-name" id="modalAcctName">—</div>
        </div>
        <div>
          <button class="copy-btn" id="modalCopyBtn"><i class="fa-regular fa-copy"></i></button>
        </div>
      </div>
      <div class="modal-actions">
        <button class="small-ghost" id="modalCloseBtn">Close</button>
        <button class="btn" id="modalGotItBtn">Done</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">Copied</div>

<script>
  // ---------- Session & hi-user (minimal authoritative fetch, uses your backend routes) ----------
  function getStoredUser() {
    const j = localStorage.getItem("loggedInUser") || localStorage.getItem("user");
    try { return j ? JSON.parse(j) : null; } catch(e) { return null; }
  }

  function updateUIWithUser(user){
    if(!user) return;
    const hi = document.getElementById("hiUser");
    if (hi) hi.innerText = "Hi, " + (user.username || user.name || "User");
    const balEl = document.getElementById("balance");
    if (balEl) {
      const b = typeof user.balance !== "undefined" ? Number(user.balance) : (user.balance ? Number(user.balance) : 0);
      balEl.innerText = "₦" + (isNaN(b) ? "0.00" : b.toFixed(2));
    }
    // agent account info: prefer account_number, else try last 10 digits of phone
    const acctEl = document.getElementById("agentAccountNumber");
    const ownerEl = document.getElementById("agentAccountName");
    let acc = user.account_number || user.acc || null;
    if(!acc && user.phone) {
      // if phone is 11 digits (e.g. 080...) take last 10 digits; but agent acc must start with 7/8/9 - we won't fabricate start digit; prefer account_number from backend
      const digits = String(user.phone).replace(/\D/g,'');
      if(digits.length >= 10) acc = digits.slice(-10);
    }
    if(!acc) {
      acctEl.innerText = 'No account number';
    } else {
      acctEl.innerText = acc;
    }
    ownerEl.innerText = user.username || user.name || 'No name';
    // modal elements
    const modalNum = document.getElementById('modalAcctNumber');
    const modalName = document.getElementById('modalAcctName');
    if(modalNum) modalNum.innerText = acc || '—';
    if(modalName) modalName.innerText = user.username || user.name || '—';
  }

  async function fetchJsonIfOk(url){
    try {
      const res = await fetch(url, { credentials: 'include', cache: 'no-store' });
      if(!res.ok) return null;
      return await res.json().catch(()=>null);
    } catch(e){ return null; }
  }

  async function fetchUserFromServer(phone, account_number){
    const candidates = [];
    if (phone) {
      candidates.push(`${API_BASE}/user/${encodeURIComponent(phone)}`);
      candidates.push(`${API_BASE}/api/user/${encodeURIComponent(phone)}`);
    }
    if (account_number) {
      candidates.push(`${API_BASE}/user_by_account/${encodeURIComponent(account_number)}`);
      candidates.push(`${API_BASE}/api/user_by_account/${encodeURIComponent(account_number)}`);
    }
    for(const url of candidates){
      const j = await fetchJsonIfOk(url);
      if(!j) continue;
      if (j.status === 'success' && j.user) return j.user;
      if (j.status === 'success' && j.username) return { username: j.username, phone: j.phone, account_number: j.account_number, balance: j.balance };
      if (j.username || j.phone || j.account_number) return j;
      if (j.user) return j.user;
    }
    return null;
  }

  async function fetchBalanceByPhone(phone){
    if(!phone) return null;
    const urls = [`${API_BASE}/balance/${encodeURIComponent(phone)}`, `${API_BASE}/api/balance/${encodeURIComponent(phone)}`];
    for(const u of urls){
      try {
        const j = await fetchJsonIfOk(u);
        if(j && (typeof j.balance === 'number' || !isNaN(Number(j.balance)))) return Number(j.balance);
      } catch(e){}
    }
    return null;
  }

  async function ensureCurrentUser(){
    const stored = getStoredUser();
    if(!stored) return;
    updateUIWithUser(stored); // quick show
    try {
      const serv = await fetchUserFromServer(stored.phone, stored.account_number || stored.acc);
      if(serv){
        if(typeof serv.balance === 'undefined'){
          const b = await fetchBalanceByPhone(serv.phone || stored.phone);
          if(b !== null) serv.balance = b;
        }
        const normalized = {
          username: serv.username || serv.name || stored.username || stored.name,
          phone: serv.phone || stored.phone || stored.phone,
          account_number: serv.account_number || serv.acc || stored.account_number || stored.acc,
          balance: typeof serv.balance !== 'undefined' ? Number(serv.balance) : (stored.balance !== undefined ? stored.balance : undefined)
        };
        try { localStorage.setItem('loggedInUser', JSON.stringify(normalized)); localStorage.setItem('user', JSON.stringify(normalized)); } catch(e){}
        updateUIWithUser(normalized);
        return;
      }
      // fallback to stored
      updateUIWithUser(stored);
    } catch(e){
      updateUIWithUser(stored);
    }
  }

  // run on start + focus + storage changes
  window.addEventListener('load', ()=>{ const s = getStoredUser(); if(s) updateUIWithUser(s); ensureCurrentUser().catch(()=>{}); });
  window.addEventListener('focus', ()=>ensureCurrentUser().catch(()=>{}));
  window.addEventListener('storage', (e)=>{ if(!e) return; if(e.key==='loggedInUser' || e.key==='user') setTimeout(()=>ensureCurrentUser().catch(()=>{}),50); });
  setInterval(()=>{ const u=getStoredUser(); if(u && (u.phone||u.account_number)) ensureCurrentUser().catch(()=>{}); },15000);

  // ---------- copy helpers & modal ----------
  const toast = document.getElementById('toast');
  function showToast(msg='Copied', ms=1600){
    if(!toast) return;
    toast.innerText = msg;
    toast.style.display = 'block';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.style.display='none', ms);
  }

  async function copyText(text){
    if(!text) return showToast('Nothing to copy');
    try{
      await navigator.clipboard.writeText(String(text));
      showToast('Copied to clipboard');
    }catch(e){
      // fallback for older browsers
      const ta = document.createElement('textarea');
      ta.value = String(text);
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand('copy'); showToast('Copied'); } catch(err){ showToast('Copy failed'); }
      ta.remove();
    }
  }

  document.getElementById('copyAcctBtn').addEventListener('click', ()=>{
    const acc = document.getElementById('agentAccountNumber').innerText || '';
    copyText(acc);
  });

  document.getElementById('refreshAcctBtn').addEventListener('click', ()=>{
    ensureCurrentUser().catch(()=>{});
    showToast('Refreshed');
  });

  // Cash In modal handlers
  const cashInBtn = document.getElementById('cashInBtn');
  const cashInModal = document.getElementById('cashInModal');
  const modalCloseBtn = document.getElementById('modalCloseBtn');
  const modalGotItBtn = document.getElementById('modalGotItBtn');
  const modalCopyBtn = document.getElementById('modalCopyBtn');

  function openCashInModal(){
    // fill modal with current data
    const acc = document.getElementById('agentAccountNumber').innerText || '';
    const name = document.getElementById('agentAccountName').innerText || '';
    document.getElementById('modalAcctNumber').innerText = acc;
    document.getElementById('modalAcctName').innerText = name;
    cashInModal.style.display = 'flex';
    cashInModal.setAttribute('aria-hidden','false');
  }
  function closeCashInModal(){
    cashInModal.style.display = 'none';
    cashInModal.setAttribute('aria-hidden','true');
  }
  cashInBtn.addEventListener('click', openCashInModal);
  modalCloseBtn.addEventListener('click', closeCashInModal);
  modalGotItBtn.addEventListener('click', closeCashInModal);
  modalCopyBtn.addEventListener('click', ()=> {
    const acc = document.getElementById('modalAcctNumber').innerText || '';
    copyText(acc);
  });
  // close modal when clicking backdrop
  cashInModal.addEventListener('click', (e)=>{
    if(e.target === cashInModal) closeCashInModal();
  });

  // ---------- logout clearing (captures links to paymeregister.html) ----------
  document.addEventListener('click', function(e){
    const a = e.target.closest && e.target.closest('a');
    if(!a) return;
    const href = a.getAttribute('href') || '';
    if(href.includes('paymeregister.html') || a.classList.contains('logout')){
      try {
        localStorage.removeItem('loggedInUser'); localStorage.removeItem('user');
        sessionStorage.removeItem('loggedInUser'); sessionStorage.removeItem('user');
      } catch(e){}
      // allow navigation
      // small delay not required — navigation will happen
    }
  });
</script>
</body>
</html>
