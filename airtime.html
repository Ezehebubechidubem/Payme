<!-- airtime.html — standalone, fully integrated with your backend and auto-notify dashboard/transactions -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Airtime — PayGo</title>
  <style>
    :root{
      --bg:#f6f7f8; --card:#fff; --muted:#8d9498; --accent-strong:#05b884;
      --radius:14px; --shadow:0 6px 18px rgba(18,24,30,0.06);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:#111; padding:18px; display:flex; justify-content:center; -webkit-font-smoothing:antialiased;}
    .wrap{ width:100%; max-width:420px; }

    .topbar{ display:flex; align-items:center; gap:12px; margin-bottom:12px }
    .topbar h1{ margin:0; font-size:18px; font-weight:600; flex:1 }
    .balance{ font-weight:700; color:#333; text-align:right; font-size:14px }

    .card{ background:var(--card); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); margin-bottom:12px }

    /* carrier */
    .carrier-row{ display:flex; align-items:center; gap:10px }
    .carrier-select{ display:flex; align-items:center; gap:12px; flex:1; padding:10px; border-radius:10px; border:1px solid #f0f0f0; background:transparent; cursor:pointer }
    .logo-badge{ width:42px; height:42px; border-radius:10px; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; flex-shrink:0 }
    .phone-input{ border:0; outline:0; font-weight:500; color:#444; width:100%; font-size:15px; background:transparent }
    .profile-btn{ border:none; background:transparent; color:var(--accent-strong); font-size:20px }

    /* amounts */
    .section-title{ margin:0 0 8px 2px; font-weight:600 }
    .amount-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px }
    .amt{ background:#fbfbfb; border-radius:10px; padding:12px; border:1px solid #f1f4f5; display:flex; flex-direction:column; align-items:center; gap:6px; cursor:pointer; min-height:72px; text-align:center }
    .cashback{ background:#e8f9f3; color:#047a54; padding:4px 8px; border-radius:8px; font-size:11px; width:100%; text-align:center }
    .amt strong{ font-size:16px }
    .amt small{ color:var(--muted) }
    .amt.active{ outline:2px solid rgba(5,184,132,0.12); transform:translateY(-3px) }

    .custom-row{ display:flex; gap:10px; align-items:center; margin-top:12px }
    .naira{ padding:10px 12px; border-radius:10px; background:#fff; border:1px solid #eee; font-weight:700 }
    .amount-input{ flex:1; padding:12px; border-radius:10px; border:1px solid #eee; font-size:15px }

    .pay-btn{ background:var(--accent-strong); color:#fff; border:0; padding:10px 16px; border-radius:999px; font-weight:700; cursor:pointer }
    .pay-btn[disabled]{ opacity:0.45; cursor:not-allowed }

    .tiny{ font-size:13px; color:var(--muted) }
    .service-row{ display:flex; align-items:center; justify-content:space-between; gap:10px }
    .service-left{ display:flex; gap:12px; align-items:center }
    .service-icon{ width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#e6f7ef;color:#06a96b; font-weight:700 }

    /* modal (carrier list) */
    .modal-overlay{ position:fixed; inset:0; display:none; align-items:flex-end; justify-content:center; background:rgba(0,0,0,0.36); z-index:60 }
    .modal-overlay.show{ display:flex }
    .modal{ width:100%; max-width:420px; background:var(--card); border-top-left-radius:18px; border-top-right-radius:18px; padding:12px; box-shadow:0 -10px 30px rgba(12,18,20,0.12) }
    .modal-handle{ width:36px;height:6px;background:#e6ecea;border-radius:8px;margin:4px auto 10px }
    .modal-list{ max-height:60vh; overflow:auto; }
    .carrier-item{ display:flex; align-items:center; gap:12px; padding:12px; border-radius:10px; margin-bottom:8px; border:1px solid #f3f6f6; cursor:pointer }
    .carrier-item .logo-badge{ width:44px; height:36px; border-radius:8px; flex-shrink:0 }
    .carrier-item .name{ font-weight:700; flex:1 }
    .carrier-check{ width:18px;height:18px;border-radius:50%;border:1.6px solid #d3d8d9; display:flex;align-items:center;justify-content:center }
    .carrier-item.active .carrier-check{ background:var(--accent-strong); color:#fff; border:0 }

    /* confirm overlay */
    .confirm-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.28); z-index:80 }
    .confirm-overlay.show{ display:flex }
    .confirm-card{ background:#fff; padding:16px; border-radius:12px; width:92%; max-width:420px; box-shadow:0 10px 30px rgba(12,18,20,0.12) }
    .confirm-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:12px }

    /* toast */
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:26px; background:#0e9f72; color:#fff; padding:10px 16px; border-radius:999px; z-index:90; display:none }

    @media (max-width:360px){ .amount-grid{ gap:8px } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>Airtime</h1>
      <div class="balance" id="balanceDisplay">₦0</div>
    </div>

    <!-- Carrier selection -->
    <div class="card">
      <div class="carrier-row">
        <div id="carrierSelect" class="carrier-select" aria-haspopup="dialog" title="Choose network">
          <div id="carrierLogo" class="logo-badge" style="background:#e53935"><!-- svg inserted later --></div>
          <input id="phoneInput" class="phone-input" placeholder="e.g 906*******" inputmode="tel" />
          <div style="color:#b7c6c1">▾</div>
        </div>

        <button class="profile-btn" title="Profile" aria-label="Profile">
          <!-- profile icon -->
          <svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0 2c-4 0-8 2-8 6v2h16v-2c0-4-4-6-8-6z"/></svg>
        </button>
      </div>
    </div>

    <!-- Amounts -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-end">
        <div>
          <div class="section-title">Select Amount</div>
          <div class="tiny">Cashback shown for each box</div>
        </div>
        <div><button id="topupBtn" class="tiny">Top up</button></div>
      </div>

      <div class="amount-grid" id="amountGrid">
        <button class="amt" data-value="50"><div class="cashback">₦1 Cashback</div><strong>₦50</strong><small class="tiny">Pay ₦50</small></button>
        <button class="amt" data-value="100"><div class="cashback">₦2 Cashback</div><strong>₦100</strong><small class="tiny">Pay ₦100</small></button>
        <button class="amt" data-value="200"><div class="cashback">₦4 Cashback</div><strong>₦200</strong><small class="tiny">Pay ₦200</small></button>

        <button class="amt" data-value="1000"><div class="cashback">₦10 Cashback</div><strong>₦1,000</strong><small class="tiny">Pay ₦1,000</small></button>
        <button class="amt" data-value="2000"><div class="cashback">₦20 Cashback</div><strong>₦2,000</strong><small class="tiny">Pay ₦2,000</small></button>
        <button class="amt" data-value="10000"><div class="cashback">₦100 Cashback</div><strong>₦10,000</strong><small class="tiny">Pay ₦10,000</small></button>
      </div>

      <div class="custom-row">
        <div class="naira">₦</div>
        <input id="customAmount" class="amount-input" type="number" placeholder="50-500,000" min="50" max="500000" />
        <button id="payBtn" class="pay-btn" disabled>Pay</button>
      </div>

      <div style="margin-top:8px" class="tiny">Fee: 1% (rounded up). Total deducted = amount + fee.</div>
    </div>

    <!-- Save beneficiary -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700">Save Beneficiary</div>
          <div class="tiny">Save this number for next time</div>
        </div>
        <label>
          <input id="saveToggle" type="checkbox" />
        </label>
      </div>
    </div>

    <!-- Service -->
    <div class="card service-row">
      <div class="service-left">
        <div class="service-icon">USSD</div>
        <div>
          <div style="font-weight:700">USSD Enquiry</div>
          <div class="tiny">Check phone balance and more</div>
        </div>
      </div>
      <div>›</div>
    </div>
  </div>

  <!-- Carrier selection modal with logos -->
  <div id="modalOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-handle"></div>
      <div id="carrierList" class="modal-list"></div>
    </div>
  </div>

  <!-- Confirm modal -->
  <div id="confirmOverlay" class="confirm-overlay" aria-hidden="true">
    <div class="confirm-card" role="dialog">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:44px;height:44px;border-radius:8px;background:#f0fdf6;display:flex;align-items:center;justify-content:center">✓</div>
        <div>
          <div id="confirmTitle" style="font-weight:700"></div>
          <div id="confirmSub" class="tiny"></div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div style="display:flex;justify-content:space-between"><div class="tiny">Amount</div><div id="confirmAmount" style="font-weight:800"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="tiny">Fee</div><div id="confirmFee" style="font-weight:700"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="tiny">Total</div><div id="confirmTotal" style="font-weight:900"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="tiny">Phone</div><div id="confirmPhone"></div></div>
      </div>

      <div class="confirm-actions">
        <button id="cancelConfirm" class="tiny">Cancel</button>
        <button id="okConfirm" class="pay-btn">Confirm</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Payment successful ✅</div>

  <script>
  /*******************************************************
   * CONFIG
   *******************************************************/
  const BACKEND_URL = 'https://payme-update.onrender.com'; // <-- your Render backend
  const USER_ID = 1; // <-- change to dynamic logged-in user ID in your app

  /*******************************************************
   * NETWORKS (logos use inline SVG or shapes; replace with images if you have them)
   *******************************************************/
  const networks = [
    {
      id: 'airtel',
      name: 'Airtel',
      color: '#e53935',
      short: 'A',
      // inline SVG (simple circle + letter). You can replace `svg` value with <img src="...">
      svg: `<svg width="34" height="22" viewBox="0 0 50 30" xmlns="http://www.w3.org/2000/svg">
             <rect width="50" height="30" rx="6" fill="#e53935"></rect>
             <text x="25" y="20" fill="#fff" font-size="14" font-family="Inter, Arial" font-weight="700" text-anchor="middle">airtel</text>
           </svg>`
    },
    {
      id: 'mtn',
      name: 'MTN',
      color: '#ffd54f',
      short: 'M',
      svg: `<svg width="40" height="26" viewBox="0 0 60 34">
             <rect width="60" height="34" rx="6" fill="#ffd54f"></rect>
             <text x="30" y="22" fill="#111" font-size="14" font-family="Inter, Arial" font-weight="800" text-anchor="middle">MTN</text>
           </svg>`
    },
    {
      id: 'glo',
      name: 'Glo',
      color: '#35b44a',
      short: 'g',
      svg: `<svg width="34" height="22" viewBox="0 0 50 30">
             <rect width="50" height="30" rx="6" fill="#35b44a"></rect>
             <text x="25" y="20" fill="#fff" font-size="14" font-family="Inter, Arial" font-weight="800" text-anchor="middle">glo</text>
           </svg>`
    },
    {
      id: '9mobile',
      name: '9Mobile',
      color: '#00a0b0',
      short: '9',
      svg: `<svg width="34" height="22" viewBox="0 0 50 30">
             <rect width="50" height="30" rx="6" fill="#00a0b0"></rect>
             <text x="25" y="20" fill="#fff" font-size="14" font-family="Inter, Arial" font-weight="800" text-anchor="middle">9</text>
           </svg>`
    }
  ];

  /*******************************************************
   * UI elements
   *******************************************************/
  const balanceDisplay = document.getElementById('balanceDisplay');
  const carrierSelect = document.getElementById('carrierSelect');
  const carrierLogo = document.getElementById('carrierLogo');
  const modalOverlay = document.getElementById('modalOverlay');
  const carrierList = document.getElementById('carrierList');

  const amountBtns = document.querySelectorAll('.amt');
  const customAmount = document.getElementById('customAmount');
  const payBtn = document.getElementById('payBtn');
  const phoneInput = document.getElementById('phoneInput');

  const confirmOverlay = document.getElementById('confirmOverlay');
  const confirmTitle = document.getElementById('confirmTitle');
  const confirmSub = document.getElementById('confirmSub');
  const confirmAmount = document.getElementById('confirmAmount');
  const confirmFee = document.getElementById('confirmFee');
  const confirmTotal = document.getElementById('confirmTotal');
  const confirmPhone = document.getElementById('confirmPhone');
  const okConfirm = document.getElementById('okConfirm');
  const cancelConfirm = document.getElementById('cancelConfirm');

  const toast = document.getElementById('toast');
  const topupBtn = document.getElementById('topupBtn');

  /*******************************************************
   * State
   *******************************************************/
  let selectedNetwork = networks[0];
  let selectedAmount = null;

  /*******************************************************
   * Helpers
   *******************************************************/
  function formatN(n){ return '₦' + Number(n).toLocaleString(); }
  function showToast(msg, ms = 2000){
    toast.textContent = msg; toast.style.display = 'block';
    setTimeout(()=> toast.style.display = 'none', ms);
  }

  /*******************************************************
   * Build carrier modal UI with logos
   *******************************************************/
  function renderCarrierList(){
    carrierList.innerHTML = '';
    networks.forEach(n => {
      const item = document.createElement('div');
      item.className = 'carrier-item';
      item.dataset.id = n.id;
      item.innerHTML = `
        <div class="logo-badge" style="background:${n.color}">${n.svg}</div>
        <div class="name">${n.name}</div>
        <div class="carrier-check" aria-hidden="true"></div>
      `;
      item.addEventListener('click', () => {
        setNetwork(n.id);
        hideModal();
      });
      carrierList.appendChild(item);
    });
    // mark active
    document.querySelectorAll('.carrier-item').forEach(it => {
      it.classList.toggle('active', it.dataset.id === selectedNetwork.id);
    });
  }

  function setNetwork(id){
    const n = networks.find(x => x.id === id) || networks[0];
    selectedNetwork = n;
    // set badge (use svg innerHTML)
    carrierLogo.innerHTML = n.svg;
    carrierLogo.style.background = n.color;
    // mark active in modal
    document.querySelectorAll('.carrier-item').forEach(it => it.classList.toggle('active', it.dataset.id === id));
  }

  carrierSelect.addEventListener('click', (e) => {
    renderCarrierList();
    modalOverlay.classList.add('show');
    modalOverlay.setAttribute('aria-hidden','false');
  });

  modalOverlay.addEventListener('click', (e) => {
    if (e.target === modalOverlay) hideModal();
  });
  function hideModal(){ modalOverlay.classList.remove('show'); modalOverlay.setAttribute('aria-hidden','true'); }

  // initialize carrier badge
  setNetwork(selectedNetwork.id);

  /*******************************************************
   * Amount selection & validation
   *******************************************************/
  amountBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      amountBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedAmount = Number(btn.dataset.value);
      customAmount.value = '';
      updatePayState();
    });
  });

  customAmount.addEventListener('input', () => {
    amountBtns.forEach(b => b.classList.remove('active'));
    const v = Number(customAmount.value);
    selectedAmount = (isNaN(v) || v <= 0) ? null : v;
    updatePayState();
  });

  phoneInput.addEventListener('input', updatePayState);

  function validPhone(p){
    if(!p) return false;
    const digits = p.replace(/\D/g,'');
    return digits.length >= 7; // approximate
  }

  function updatePayState(){
    const amountOk = selectedAmount && selectedAmount >= 50 && selectedAmount <= 500000;
    const phoneOk = validPhone(phoneInput.value.trim());
    payBtn.disabled = !(amountOk && phoneOk);
  }

  /*******************************************************
   * Fetch balance on load
   *******************************************************/
  async function fetchBalance(){
    try {
      const res = await fetch(`${BACKEND_URL}/get_balance?user_id=${USER_ID}`);
      const json = await res.json();
      if (res.ok) balanceDisplay.textContent = formatN(json.balance);
      else console.error('balance error', json);
    } catch(err){
      console.error('fetchBalance error', err);
    }
  }
  fetchBalance();

  /*******************************************************
   * Confirm -> call backend -> broadcast event to other pages
   *******************************************************/
  payBtn.addEventListener('click', () => {
    if (!selectedAmount) return alert('Choose or enter an amount (₦50 - ₦500,000).');
    if (!validPhone(phoneInput.value.trim())) return alert('Enter a valid phone number.');
    const fee = Math.ceil(selectedAmount * 0.01);
    const total = selectedAmount + fee;
    confirmTitle.textContent = `${selectedNetwork.name} airtime`;
    confirmSub.textContent = `Cashback applies automatically (if eligible)`;
    confirmAmount.textContent = formatN(selectedAmount);
    confirmFee.textContent = formatN(fee);
    confirmTotal.textContent = formatN(total);
    confirmPhone.textContent = phoneInput.value.trim();
    confirmOverlay.classList.add('show');
    confirmOverlay.setAttribute('aria-hidden','false');
  });

  cancelConfirm.addEventListener('click', () => {
    confirmOverlay.classList.remove('show');
    confirmOverlay.setAttribute('aria-hidden','true');
  });

  okConfirm.addEventListener('click', async () => {
    okConfirm.disabled = true;
    const amount = Number(selectedAmount);
    const payload = {
      user_id: USER_ID,
      phone: phoneInput.value.trim(),
      network: selectedNetwork.name,
      amount
    };
    try {
      const res = await fetch(`${BACKEND_URL}/buy_airtime`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) {
        alert('Purchase failed: ' + (data.error || JSON.stringify(data)));
        console.error('buy_airtime failed', data);
        return;
      }

      // success: update UI
      balanceDisplay.textContent = formatN(data.balance);
      showToast('Payment successful ✅');
      confirmOverlay.classList.remove('show');

      // reset selection
      amountBtns.forEach(b => b.classList.remove('active'));
      customAmount.value = '';
      selectedAmount = null;
      updatePayState();

            // reset selection
      amountBtns.forEach(b => b.classList.remove('active'));
      customAmount.value = '';
      selectedAmount = null;
      updatePayState();

      // Broadcast to other tabs/pages (dashboard, transactions)
      const eventPayload = {
        type: 'airtime_purchase',
        transaction: data.transaction, // includes id, amount, fee, total, network, phone, date, status
        balance: data.balance,
        source: 'airtime.html',
        ts: Date.now()
      };

      broadcastEvent(eventPayload);

    } catch (err) {
      console.error('network error', err);
      alert('Network/server error');
    } finally {
      okConfirm.disabled = false;
    }
  });

  /*******************************************************
   * Topup helper (for testing) — calls /topup
   *******************************************************/
  topupBtn.addEventListener('click', async () => {
    const val = prompt('Top up amount (for testing):', '5000');
    if (!val) return;
    const amt = Number(val);
    if (isNaN(amt) || amt <= 0) return alert('Invalid amount');
    try {
      const res = await fetch(`${BACKEND_URL}/topup`, {
        method:'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ user_id: USER_ID, amount: amt })
      });
      const data = await res.json();
      if (res.ok) {
        showToast('Topup successful');
        balanceDisplay.textContent = formatN(data.balance);
        // broadcast topup too
        broadcastEvent({ type: 'topup', balance: data.balance, transaction: data.transaction, ts: Date.now() });
      } else {
        alert('Topup error: ' + (data.error || JSON.stringify(data)));
      }
    } catch(err) { console.error(err); alert('Topup failed'); }
  });

  /*******************************************************
   * Cross-tab notification: BroadcastChannel + localStorage fallback
   * So other pages (dashboard.html, transactions.html) can listen and refresh
   *******************************************************/
  const CHANNEL_NAME = 'paygo_channel';
  let bc = null;
  try { bc = new BroadcastChannel(CHANNEL_NAME); }
  catch(e) { bc = null; }

  function broadcastEvent(payload){
    // BroadcastChannel (same-origin)
    if (bc) {
      try { bc.postMessage(payload); } catch(e) { console.warn('bc post error', e); }
    }
    // localStorage fallback (fires storage event in other tabs)
    try {
      const key = 'paygo_event';
      localStorage.setItem(key, JSON.stringify(payload));
      // remove quickly to keep storage tidy (note: storage events fire even if value removed)
      setTimeout(()=> localStorage.removeItem(key), 500);
    } catch(e) { console.warn('localStorage broadcast failed', e); }
  }

  /*******************************************************
   * optional: also send server-side webhook or event if you need real-time across devices
   *******************************************************/

  /*******************************************************
   * Listen for escape key to close modals
   *******************************************************/
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      hideModal();
      confirmOverlay.classList.remove('show');
    }
  });

  // keep balance up-to-date periodically
  setInterval(fetchBalance, 30_000);
  </script>
</body>
</html>

