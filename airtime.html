<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PAYME — Airtime</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root{
      --primary:#00c853; --primary-dark:#009624; --bg:#ffffff; --card:#ffffff;
      --muted:#777; --soft:#e8f5e9; --line:#e0e0e0; --text:#1b1b1b;
      --radius:14px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);padding-bottom:96px}
    .wrap{max-width:440px;margin:0 auto;padding:12px}
    /* TOPBAR */
    .topbar{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .back-area{display:flex;align-items:center;gap:10px}
    .back-area a{color:var(--muted);text-decoration:none;display:flex;align-items:center;gap:8px;font-weight:700}
    .title-small{font-weight:700;color:#222;font-size:16px}
    /* card */
    .card{background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:12px;box-shadow:0 1px 0 rgba(0,0,0,.03) inset}
    .label{font-size:12px;color:var(--muted);margin-bottom:8px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .tiny{font-size:13px;color:var(--muted)}
    /* network display (header) */
    .selected-network{display:flex;align-items:center;gap:10px}
    .selected-network .logo-small{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#f5f6f7}
    .selected-network .logo-small img{width:100%;height:100%;object-fit:cover;display:block}
    .change-btn{background:transparent;border:0;color:var(--primary);font-weight:700;cursor:pointer}
    /* modal list (bottom sheet) */
    .modal-overlay{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,0.36);z-index:60}
    .modal-overlay.show{display:flex}
    .sheet{width:100%;max-width:440px;background:var(--card);border-top-left-radius:18px;border-top-right-radius:18px;padding:10px 10px 18px;box-shadow:0 -10px 30px rgba(12,18,20,0.12)}
    .sheet .sheet-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;background:#fff;border:1px solid #f2f2f2;margin-bottom:8px}
    .sheet .sheet-item:hover{background:#fbfbfb}
    .sheet .sheet-logo{width:44px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .sheet .sheet-logo img{max-width:100%;max-height:100%}
    .sheet .sheet-title{flex:1;font-weight:700}
    .sheet .sheet-check{width:22px;height:22px;border-radius:50%;border:1.6px solid #ccc;display:flex;align-items:center;justify-content:center}
    .sheet .sheet-check.selected{background:var(--primary);border-color:var(--primary);color:#fff}
    /* amount grid & inputs */
    .amount-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .amt{background:#fbfbfb;border-radius:10px;padding:10px;text-align:center;cursor:pointer;border:1px solid #f1f4f5}
    .amt.active{outline:2px solid rgba(0,200,83,0.12);transform:translateY(-3px)}
    .cashback{background:#e8f9f3;color:#047a54;padding:4px 6px;border-radius:8px;font-size:12px;margin-bottom:6px}
    .custom-row{display:flex;gap:10px;align-items:center;margin-top:12px}
    .naira{padding:10px;border-radius:10px;background:#fff;border:1px solid #eee}
    input[type=number], input[type=tel]{flex:1;padding:10px;border-radius:10px;border:1px solid #eee}
    .pay-btn{background:var(--primary);color:#fff;border:0;padding:10px 14px;border-radius:999px;font-weight:700;cursor:pointer}
    .pay-btn[disabled]{opacity:0.45;cursor:not-allowed}
    .muted-note{font-size:12px;color:#888;margin-top:8px}
    /* confirm overlay */
    .confirm-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.28);z-index:80}
    .confirm-overlay.show{display:flex}
    .confirm-card{background:#fff;padding:16px;border-radius:12px;width:92%;max-width:420px;box-shadow:0 8px 30px rgba(12,18,20,0.12)}
    .confirm-row{display:flex;align-items:center;gap:12px}
    .network-logo{width:48px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .network-logo img{max-width:100%;max-height:100%}
    /* success modal */
    .popup-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.42);z-index:90}
    .popup{background:#fff;padding:18px;border-radius:12px;max-width:360px;width:86%;text-align:center;box-shadow:0 14px 40px rgba(12,18,20,0.14)}
    .popup .ok-badge{width:72px;height:72px;border-radius:36px;background:linear-gradient(135deg,#00c853,#43a047);display:inline-flex;align-items:center;justify-content:center;color:#fff;font-size:28px;margin-bottom:12px}
    .popup h3{margin-bottom:4px}
    .popup p{color:#666;font-size:14px;margin-bottom:10px}
    .popup .btns{display:flex;gap:10px;justify-content:center;margin-top:8px}
    .btn-outline{padding:8px 12px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .btn-primary{padding:8px 12px;border-radius:10px;border:0;background:var(--primary);color:#fff;cursor:pointer}
    .loader { display:inline-block; width:14px; height:14px; border-radius:50%; border:3px solid rgba(255,255,255,0.2); border-top-color: #fff; animation: spin .7s linear infinite; vertical-align: middle; margin-left:8px; }
    @keyframes spin { to { transform: rotate(360deg);} }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- TOPBAR with back & title -->
    <div class="topbar" role="banner">
      <div class="back-area">
        <a href="dashboard.html" title="Back to dashboard"><i class="fa-solid fa-arrow-left"></i></a>
      </div>
      <div class="title-small">Airtime</div>
      <div style="margin-left:auto">
        <a href="history.html" class="tiny" style="color:var(--primary)">History</a>
      </div>
    </div>

    <!-- RECIPIENT + selected network (no dropdown) -->
    <div class="card">
      <div class="label">Recipient Number</div>

      <div class="row" style="align-items:center">
        <div class="selected-network">
          <div class="logo-small" id="selectedLogo">
            <!-- logo img inserted by JS -->
          </div>
          <div id="selectedName" style="font-weight:700;color:#333">Airtel</div>
        </div>

        <div>
          <button id="openNetworkList" class="change-btn">Change</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <input id="recipientInput" type="tel" placeholder="e.g 0803xxxxxxx" inputmode="numeric" />
      </div>
      <div class="muted-note">Tip: recipient number must be <strong>11 digits</strong>.</div>
    </div>

    <!-- AMOUNT card -->
    <div class="card">
      <div class="row" style="align-items:flex-end">
        <div>
          <div class="label">Amount</div>
          <div class="tiny">Choose quick amount or enter custom</div>
        </div>
      </div>

      <div id="amountGrid" class="amount-grid" style="margin-top:10px">
        <div class="amt" data-value="50"><div class="cashback">₦1 Cashback</div><strong>₦50</strong></div>
        <div class="amt" data-value="100"><div class="cashback">₦2 Cashback</div><strong>₦100</strong></div>
        <div class="amt" data-value="200"><div class="cashback">₦4 Cashback</div><strong>₦200</strong></div>

        <div class="amt" data-value="1000"><div class="cashback">₦10 Cashback</div><strong>₦1,000</strong></div>
        <div class="amt" data-value="2000"><div class="cashback">₦20 Cashback</div><strong>₦2,000</strong></div>
        <div class="amt" data-value="10000"><div class="cashback">₦100 Cashback</div><strong>₦10,000</strong></div>
      </div>

      <div class="custom-row">
        <div class="naira">₦</div>
        <input id="customAmount" type="number" placeholder="50 - 500,000" min="50" max="500000" />
        <button id="payBtn" class="pay-btn" disabled>Pay</button>
      </div>

      <div style="margin-top:8px" class="tiny">Fee: 1% (rounded up). Total deducted = amount + fee.</div>
    </div>

    <!-- Save beneficiary -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700">Save as beneficiary</div>
          <div class="tiny">Save this number for next time</div>
        </div>
        <label><input id="saveToggle" type="checkbox" /></label>
      </div>
    </div>

  </div>

  <!-- NETWORK LIST (bottom sheet modal) -->
  <div id="networkModal" class="modal-overlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="Select network">
      <!-- JS will populate list items -->
    </div>
  </div>

  <!-- confirm modal -->
  <div id="confirmOverlay" class="confirm-overlay" aria-hidden="true">
    <div class="confirm-card" role="dialog" aria-modal="true">
      <div class="confirm-row">
        <div class="network-logo" id="confirmLogo"></div>
        <div>
          <div id="confirmTitle" style="font-weight:800">Confirm Purchase</div>
          <div id="confirmSub" class="tiny">Confirm before we proceed</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div style="display:flex;justify-content:space-between"><div class="tiny">Amount</div><div id="confirmAmount" style="font-weight:800"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="tiny">Fee</div><div id="confirmFee"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="tiny">Total</div><div id="confirmTotal" style="font-weight:800"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="tiny">To</div><div id="confirmTo"></div></div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="cancelBtn" class="tiny">Cancel</button>
        <button id="confirmBtn" class="pay-btn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- success popup (centered) -->
  <div id="successPopup" class="popup-overlay" aria-hidden="true">
    <div class="popup" role="dialog" aria-modal="true">
      <div class="ok-badge">✓</div>
      <h3 id="successTitle">Payment successful</h3>
      <p id="successMessage">Your airtime was delivered.</p>
      <div class="btns">
        <button id="closeSuccess" class="btn-outline">Close</button>
        <button id="viewTx" class="btn-primary">View Transactions</button>
      </div>
    </div>
  </div>

  <!-- error popup -->
  <div id="errorPopup" class="popup-overlay" aria-hidden="true">
    <div class="popup" role="alertdialog" aria-modal="true">
      <div class="ok-badge" style="background:#f44336">!</div>
      <h3 id="errorTitle">Error</h3>
      <p id="errorMessage">Something went wrong</p>
      <div class="btns" style="justify-content:center">
        <button id="closeError" class="btn-primary">OK</button>
      </div>
    </div>
  </div>

<script>
/* ---------- CONFIG ---------- */
const API_BASE = "https://payme-update.onrender.com"; // your backend base
const LOGO_PATHS = {
  airtel: '/assets/logos/airtel.png',
  mtn: '/assets/logos/mtn.png',
  glo: '/assets/logos/glo.png',
  '9mobile': '/assets/logos/9mobile.png'
};

/* ---------- local helpers ---------- */
function getStoredUser() {
  const j = localStorage.getItem("loggedInUser") || localStorage.getItem("user");
  try { return j ? JSON.parse(j) : null; } catch(e){ return null; }
}
function setStoredUser(u) {
  try {
    localStorage.setItem("loggedInUser", JSON.stringify(u));
    localStorage.setItem("user", JSON.stringify(u));
    const ev = { type: "airtime_purchase", user: u, ts: Date.now() };
    localStorage.setItem("payme_event", JSON.stringify(ev));
    setTimeout(()=> localStorage.removeItem("payme_event"), 900);
  } catch(e){ console.error("storage error", e); }
}
function formatN(n){ return '₦' + Number(n).toLocaleString(); }

/* ---------- networks data (order matches screenshot) ---------- */
const NETWORKS = [
  { id:'airtel', name:'Airtel', color:'#e53935', logo: LOGO_PATHS.airtel },
  { id:'mtn', name:'MTN', color:'#ffd54f', logo: LOGO_PATHS.mtn },
  { id:'glo', name:'Glo', color:'#35b44a', logo: LOGO_PATHS.glo },
  { id:'9mobile', name:'9Mobile', color:'#00a0b0', logo: LOGO_PATHS['9mobile'] }
];

/* ---------- UI refs ---------- */
const selectedLogo = document.getElementById('selectedLogo');
const selectedName = document.getElementById('selectedName');
const openNetworkList = document.getElementById('openNetworkList');
const networkModal = document.getElementById('networkModal');
const sheet = document.querySelector('.sheet');

const recipientInput = document.getElementById('recipientInput');
const amountBtns = document.querySelectorAll('.amt');
const customAmount = document.getElementById('customAmount');
const payBtn = document.getElementById('payBtn');

const confirmOverlay = document.getElementById('confirmOverlay');
const confirmAmount = document.getElementById('confirmAmount');
const confirmFee = document.getElementById('confirmFee');
const confirmTotal = document.getElementById('confirmTotal');
const confirmTo = document.getElementById('confirmTo');
const confirmTitle = document.getElementById('confirmTitle');
const confirmLogo = document.getElementById('confirmLogo');
const confirmSub = document.getElementById('confirmSub');
const cancelBtn = document.getElementById('cancelBtn');
const confirmBtn = document.getElementById('confirmBtn');

const successPopup = document.getElementById('successPopup');
const successTitle = document.getElementById('successTitle');
const successMessage = document.getElementById('successMessage');
const closeSuccess = document.getElementById('closeSuccess');
const viewTx = document.getElementById('viewTx');

const errorPopup = document.getElementById('errorPopup');
const errorTitle = document.getElementById('errorTitle');
const errorMessage = document.getElementById('errorMessage');
const closeError = document.getElementById('closeError');

/* ---------- initial selection ---------- */
let selectedNetwork = NETWORKS[0];
function renderSelectedNetwork() {
  selectedName.textContent = selectedNetwork.name;
  selectedLogo.innerHTML = '';
  const img = document.createElement('img');
  img.src = selectedNetwork.logo;
  img.alt = selectedNetwork.name;
  img.onerror = () => { selectedLogo.innerHTML = `<div style="font-weight:800;color:${selectedNetwork.color}">${selectedNetwork.name[0]}</div>`; };
  selectedLogo.appendChild(img);
}
renderSelectedNetwork();

/* ---------- build sheet list (modal) ---------- */
function buildNetworkSheet() {
  sheet.innerHTML = ''; // clear
  NETWORKS.forEach(n => {
    const item = document.createElement('div');
    item.className = 'sheet-item';
    item.dataset.id = n.id;

    const logoWrap = document.createElement('div');
    logoWrap.className = 'sheet-logo';
    const img = document.createElement('img');
    img.src = n.logo;
    img.alt = n.name;
    img.onerror = () => { logoWrap.innerHTML = `<div style="font-weight:800;color:${n.color}">${n.name[0]}</div>`; };
    logoWrap.appendChild(img);

    const title = document.createElement('div');
    title.className = 'sheet-title';
    title.textContent = n.name;

    const check = document.createElement('div');
    check.className = 'sheet-check';
    if (n.id === selectedNetwork.id) { check.classList.add('selected'); check.innerHTML = '✓'; }

    item.appendChild(logoWrap);
    item.appendChild(title);
    item.appendChild(check);

    item.addEventListener('click', () => {
      // update selected network
      selectedNetwork = n;
      // re-render sheet (update selected state)
      buildNetworkSheet();
      renderSelectedNetwork();
      // close sheet
      networkModal.classList.remove('show');
      networkModal.setAttribute('aria-hidden','true');
    });

    sheet.appendChild(item);
  });
}
openNetworkList.addEventListener('click', () => {
  buildNetworkSheet();
  networkModal.classList.add('show');
  networkModal.setAttribute('aria-hidden','false');
});
networkModal.addEventListener('click', (e) => { if (e.target === networkModal) { networkModal.classList.remove('show'); networkModal.setAttribute('aria-hidden','true'); } });

/* ---------- amounts handlers ---------- */
let selectedAmount = null;
amountBtns.forEach(b => {
  b.addEventListener('click', () => {
    amountBtns.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    customAmount.value = '';
    selectedAmount = Number(b.dataset.value);
    updatePayState();
  });
});
customAmount.addEventListener('input', ()=> {
  amountBtns.forEach(x=>x.classList.remove('active'));
  const v = Number(customAmount.value);
  selectedAmount = isNaN(v) ? null : v;
  updatePayState();
});
recipientInput.addEventListener('input', updatePayState);

function onlyDigits(s){ return (s || '').replace(/\D/g,''); }
function validRecipient(p){
  const d = onlyDigits(p);
  return d.length === 11; // MUST be exactly 11 digits
}
function updatePayState(){
  const to = (recipientInput.value || '').trim();
  const ok = selectedAmount && selectedAmount >= 50 && selectedAmount <= 500000 && validRecipient(to);
  payBtn.disabled = !ok;
}

/* ---------- load guard ---------- */
window.addEventListener('load', () => {
  const user = getStoredUser();
  if (!user || !user.phone) {
    // your flow: go to dashboard (which may require login)
    alert('You must be logged in to buy airtime. Redirecting.');
    window.location.href = 'dashboard.html';
    return;
  }
});

/* ---------- confirmation UI ---------- */
function showConfirmUI(amount, fee, total, to){
  confirmTitle.textContent = `Buy ${selectedNetwork.name} Airtime`;
  confirmSub.textContent = 'Confirm before we proceed';
  confirmAmount.textContent = formatN(amount);
  confirmFee.textContent = formatN(fee);
  confirmTotal.textContent = formatN(total);
  confirmTo.textContent = to;
  // set logo
  confirmLogo.innerHTML = '';
  const img = document.createElement('img');
  img.src = selectedNetwork.logo;
  img.alt = selectedNetwork.name;
  img.onerror = () => { confirmLogo.innerHTML = `<div style="font-weight:800;color:${selectedNetwork.color}">${selectedNetwork.name[0]}</div>`; };
  confirmLogo.appendChild(img);
  confirmOverlay.classList.add('show');
  confirmOverlay.setAttribute('aria-hidden','false');
}
payBtn.addEventListener('click', ()=> {
  const to = recipientInput.value.trim();
  if (!validRecipient(to)) {
    showError('Invalid recipient', 'Recipient number must be exactly 11 digits (e.g. 0803xxxxxxx).');
    return;
  }
  const amt = Number(selectedAmount || customAmount.value);
  if (!amt || amt < 50) {
    showError('Invalid amount', 'Please enter a valid amount (minimum ₦50).');
    return;
  }
  const fee = Math.ceil(amt * 0.01);
  const total = amt + fee;
  showConfirmUI(amt, fee, total, to);
});
cancelBtn.addEventListener('click', ()=> { confirmOverlay.classList.remove('show'); confirmOverlay.setAttribute('aria-hidden','true'); });

/* ---------- error/success popups ---------- */
function showSuccess(title, msg) {
  successTitle.textContent = title || 'Payment successful';
  successMessage.textContent = msg || '';
  successPopup.classList.add('show');
  successPopup.style.display = 'flex';
  successPopup.setAttribute('aria-hidden','false');
}
function hideSuccess(){ successPopup.classList.remove('show'); successPopup.style.display='none'; successPopup.setAttribute('aria-hidden','true'); }

function showError(title, msg) {
  errorTitle.textContent = title || 'Error';
  errorMessage.textContent = msg || 'Something went wrong';
  errorPopup.classList.add('show');
  errorPopup.style.display = 'flex';
  errorPo