<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PAYME — Airtime</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root{
      --primary:#00c853; --primary-dark:#009624; --bg:#ffffff; --card:#ffffff;
      --muted:#777; --soft:#e8f5e9; --line:#e0e0e0; --text:#1b1b1b;
      --radius:14px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);padding-bottom:84px}
    .wrap{max-width:440px;margin:0 auto;padding:12px}
    .topbar{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .topbar h1{font-size:18px;margin:0;font-weight:700}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:12px;box-shadow:0 1px 0 rgba(0,0,0,.03) inset}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .label{font-size:12px;color:var(--muted)}
    .amount-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .amt{background:#fbfbfb;border-radius:10px;padding:10px;text-align:center;cursor:pointer;border:1px solid #f1f4f5}
    .amt.active{outline:2px solid rgba(0,200,83,0.12);transform:translateY(-3px)}
    .cashback{background:#e8f9f3;color:#047a54;padding:4px 6px;border-radius:8px;font-size:12px;margin-bottom:6px}
    .custom-row{display:flex;gap:10px;align-items:center;margin-top:12px}
    .naira{padding:10px;border-radius:10px;background:#fff;border:1px solid #eee}
    input[type=number], input[type=tel]{flex:1;padding:10px;border-radius:10px;border:1px solid #eee}
    .pay-btn{background:var(--primary);color:#fff;border:0;padding:10px 14px;border-radius:999px;font-weight:700;cursor:pointer}
    .pay-btn[disabled]{opacity:0.45;cursor:not-allowed}
    .tiny{font-size:13px;color:var(--muted)}
    .modal-overlay{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,0.36);z-index:60}
    .modal-overlay.show{display:flex}
    .modal{width:100%;max-width:420px;background:var(--card);border-top-left-radius:18px;border-top-right-radius:18px;padding:12px;box-shadow:0 -10px 30px rgba(12,18,20,0.12)}
    .modal-list{max-height:60vh;overflow:auto}
    .carrier-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;border:1px solid #f3f6f6;margin-bottom:8px;cursor:pointer}
    .logo-badge{width:44px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
    .confirm-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.28);z-index:80}
    .confirm-overlay.show{display:flex}
    .confirm-card{background:#fff;padding:16px;border-radius:12px;width:92%;max-width:420px}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0e9f72;color:#fff;padding:10px 14px;border-radius:999px;display:none}
    .muted-note{font-size:12px;color:#888;margin-top:8px}
    .loader { display:inline-block; width:14px; height:14px; border-radius:50%; border:3px solid rgba(255,255,255,0.2); border-top-color: #fff; animation: spin .7s linear infinite; vertical-align: middle; margin-left:8px; }
    @keyframes spin { to { transform: rotate(360deg);} }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <h1>Airtime</h1>
      <a href="dashboard.html" style="margin-left:auto;color:var(--muted);font-weight:700">Back</a>
    </header>

    <!-- Recipient -->
    <div class="card">
      <div class="label">Recipient Number</div>
      <div style="margin-top:8px" class="row">
        <div id="selectedNetworkBadge" style="display:flex;align-items:center;gap:10px">
          <div id="networkBadge" class="logo-badge" style="background:#e53935">A</div>
          <div id="networkName" style="font-weight:700">Airtel</div>
        </div>
        <button id="chooseNetworkBtn" class="tiny">Change</button>
      </div>

      <div style="margin-top:10px">
        <input id="recipientInput" type="tel" placeholder="e.g 0803xxxxxxx" inputmode="tel" />
      </div>
      <div class="muted-note">Tip: enter recipient number in local format (e.g. 0803xxxxxxx)</div>
    </div>

    <!-- Amount -->
    <div class="card">
      <div class="row" style="align-items:flex-end">
        <div>
          <div class="label">Amount</div>
          <div class="tiny">Choose quick amount or enter custom</div>
        </div>
      </div>

      <div class="amount-grid" id="amountGrid" style="margin-top:10px">
        <div class="amt" data-value="50"><div class="cashback">₦1 Cashback</div><strong>₦50</strong></div>
        <div class="amt" data-value="100"><div class="cashback">₦2 Cashback</div><strong>₦100</strong></div>
        <div class="amt" data-value="200"><div class="cashback">₦4 Cashback</div><strong>₦200</strong></div>

        <div class="amt" data-value="1000"><div class="cashback">₦10 Cashback</div><strong>₦1,000</strong></div>
        <div class="amt" data-value="2000"><div class="cashback">₦20 Cashback</div><strong>₦2,000</strong></div>
        <div class="amt" data-value="10000"><div class="cashback">₦100 Cashback</div><strong>₦10,000</strong></div>
      </div>

      <div class="custom-row">
        <div class="naira">₦</div>
        <input id="customAmount" type="number" placeholder="50 - 500,000" min="50" max="500000" />
        <button id="payBtn" class="pay-btn" disabled>Pay</button>
      </div>

      <div style="margin-top:8px" class="tiny">Fee: 1% (rounded up). Total deducted = amount + fee.</div>
    </div>

    <!-- Save beneficiary -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700">Save as beneficiary</div>
          <div class="tiny">Save this number for next time</div>
        </div>
        <label><input id="saveToggle" type="checkbox" /></label>
      </div>
    </div>
  </div>

  <!-- carrier modal -->
  <div id="modalOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog">
      <div class="modal-list" id="carrierList"></div>
    </div>
  </div>

  <!-- confirm -->
  <div id="confirmOverlay" class="confirm-overlay" aria-hidden="true">
    <div class="confirm-card">
      <div style="font-weight:700" id="confirmTitle">Confirm Purchase</div>
      <div style="margin-top:8px" class="tiny" id="confirmSub"></div>

      <div style="margin-top:12px">
        <div style="display:flex;justify-content:space-between"><div class="tiny">Amount</div><div id="confirmAmount" style="font-weight:800"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="tiny">Fee</div><div id="confirmFee"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="tiny">Total</div><div id="confirmTotal" style="font-weight:800"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="tiny">To</div><div id="confirmTo"></div></div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="cancelBtn" class="tiny">Cancel</button>
        <button id="confirmBtn" class="pay-btn">Confirm</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Payment successful</div>

<script>
/* ---------- CONFIG ---------- */
const API_BASE = "https://payme-update.onrender.com"; // your backend

/* ---------- small helpers ---------- */
function getStoredUser() {
  const j = localStorage.getItem("loggedInUser") || localStorage.getItem("user");
  try { return j ? JSON.parse(j) : null; } catch(e){ return null; }
}
function setStoredUser(u) {
  try {
    localStorage.setItem("loggedInUser", JSON.stringify(u));
    localStorage.setItem("user", JSON.stringify(u));
    // short event so other tabs can pick up
    const ev = { type: "airtime_purchase", user: u, ts: Date.now() };
    localStorage.setItem("payme_event", JSON.stringify(ev));
    setTimeout(()=> localStorage.removeItem("payme_event"), 800);
  } catch(e){ console.error("storage error", e); }
}
function showToast(msg, ms=1600){
  const t = document.getElementById('toast'); t.textContent = msg; t.style.display = 'block';
  setTimeout(()=> t.style.display = 'none', ms);
}

/* ---------- networks ---------- */
const networks = [
  { id: 'airtel', name:'Airtel', color:'#e53935', short:'AIRTEL', svg: `<svg width="90" height="28" xmlns="http://www.w3.org/2000/svg"><rect rx="6" width="90" height="28" fill="#e53935"/><text x="45" y="19" font-family="Inter, Arial" font-weight="700" font-size="12" text-anchor="middle" fill="#fff">AIRTEL</text></svg>` },
  { id: 'mtn', name:'MTN', color:'#ffd54f', short:'MTN', svg: `<svg width="90" height="28"><rect rx="6" width="90" height="28" fill="#ffd54f"/><text x="45" y="19" font-family="Inter, Arial" font-weight="800" font-size="12" text-anchor="middle" fill="#111">MTN</text></svg>` },
  { id: 'glo', name:'Glo', color:'#35b44a', short:'GLO', svg: `<svg width="90" height="28"><rect rx="6" width="90" height="28" fill="#35b44a"/><text x="45" y="19" font-family="Inter, Arial" font-weight="800" font-size="12" text-anchor="middle" fill="#fff">GLO</text></svg>` },
  { id: '9mobile', name:'9Mobile', color:'#00a0b0', short:'9MOBILE', svg: `<svg width="90" height="28"><rect rx="6" width="90" height="28" fill="#00a0b0"/><text x="45" y="19" font-family="Inter, Arial" font-weight="800" font-size="12" text-anchor="middle" fill="#fff">9MOBILE</text></svg>` }
];

/* ---------- UI refs ---------- */
let selectedNetwork = networks[0];
const networkBadge = document.getElementById('networkBadge');
const networkName = document.getElementById('networkName');
const chooseNetworkBtn = document.getElementById('chooseNetworkBtn');
const modalOverlay = document.getElementById('modalOverlay');
const carrierList = document.getElementById('carrierList');
const recipientInput = document.getElementById('recipientInput');
const amountBtns = document.querySelectorAll('.amt');
const customAmount = document.getElementById('customAmount');
const payBtn = document.getElementById('payBtn');
const confirmOverlay = document.getElementById('confirmOverlay');
const confirmAmount = document.getElementById('confirmAmount');
const confirmFee = document.getElementById('confirmFee');
const confirmTotal = document.getElementById('confirmTotal');
const confirmTo = document.getElementById('confirmTo');
const confirmTitle = document.getElementById('confirmTitle');
const cancelBtn = document.getElementById('cancelBtn');
const confirmBtn = document.getElementById('confirmBtn');

function renderNetworkBadge(n){
  networkBadge.style.background = n.color;
  networkBadge.innerHTML = n.svg;
  networkName.textContent = n.name;
}
renderNetworkBadge(selectedNetwork);

/* ---------- modal ---------- */
chooseNetworkBtn.addEventListener('click', ()=> {
  carrierList.innerHTML = '';
  networks.forEach(n => {
    const div = document.createElement('div');
    div.className = 'carrier-item';
    div.innerHTML = `<div class="logo-badge" style="background:${n.color}">${n.svg}</div>
                     <div style="font-weight:700;flex:1">${n.name}</div>
                     <div style="color:#999">${n.short}</div>`;
    div.addEventListener('click', () => {
      selectedNetwork = n;
      renderNetworkBadge(n);
      modalOverlay.classList.remove('show');
    });
    carrierList.appendChild(div);
  });
  modalOverlay.classList.add('show');
});
modalOverlay.addEventListener('click', (e)=> { if(e.target === modalOverlay) modalOverlay.classList.remove('show'); });

/* ---------- amount selection & validation ---------- */
let selectedAmount = null;
amountBtns.forEach(b => {
  b.addEventListener('click', () => {
    amountBtns.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    customAmount.value = '';
    selectedAmount = Number(b.dataset.value);
    updatePayState();
  });
});
customAmount.addEventListener('input', ()=> {
  amountBtns.forEach(x=>x.classList.remove('active'));
  const v = Number(customAmount.value);
  selectedAmount = isNaN(v) ? null : v;
  updatePayState();
});
recipientInput.addEventListener('input', updatePayState);

function validPhone(p){
  if(!p) return false;
  const digits = p.replace(/\D/g,'');
  return digits.length >= 7; // len >=7 is flexible for different formats; server will handle correctness for user phone
}

function updatePayState(){
  const to = (recipientInput.value || '').trim();
  const ok = selectedAmount && selectedAmount >= 50 && selectedAmount <= 500000 && validPhone(to);
  payBtn.disabled = !ok;
}

/* ---------- load guard: require logged-in user ---------- */
window.addEventListener('load', () => {
  const user = getStoredUser();
  if (!user || !user.phone) {
    alert('You must be logged in to buy airtime. Redirecting to login/dashboard.');
    // prefer redirect to dashboard or login page in your app:
    window.location.href = 'dashboard.html';
    return;
  }
});

/* ---------- purchase flow ---------- */
payBtn.addEventListener('click', ()=>{
  const to = recipientInput.value.trim();
  if (!validPhone(to)) return alert('Enter a valid recipient phone');
  const amt = Number(selectedAmount || customAmount.value);
  if (!amt || amt < 50) return alert('Enter a valid amount (minimum ₦50)');
  const fee = Math.ceil(amt * 0.01);
  const total = amt + fee;

  confirmTitle.textContent = `Buy ${selectedNetwork.name} Airtime`;
  document.getElementById('confirmSub').textContent = 'Confirm before we proceed';
  confirmAmount.textContent = `₦${Number(amt).toLocaleString()}`;
  confirmFee.textContent = `₦${Number(fee).toLocaleString()}`;
  confirmTotal.textContent = `₦${Number(total).toLocaleString()}`;
  confirmTo.textContent = to;
  confirmOverlay.classList.add('show');
});

cancelBtn.addEventListener('click', ()=> confirmOverlay.classList.remove('show'));

/* Confirm + call backend */
confirmBtn.addEventListener('click', async () => {
  confirmBtn.disabled = true;
  const recipient = recipientInput.value.trim();
  const amount = Number(selectedAmount || customAmount.value);
  const user = getStoredUser();
  if (!user || !user.phone) { alert('You must be logged in'); confirmBtn.disabled=false; return; }

  // small UI loading indicator
  const oldHtml = confirmBtn.innerHTML;
  confirmBtn.innerHTML = 'Processing <span class="loader"></span>';

  const payload = {
    phone: user.phone,             // your backend identifies sender via phone
    network: selectedNetwork.name,
    amount: amount,
    recipient: recipient
  };

  try {
    const res = await fetch(`${API_BASE}/buy_airtime`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    // parse JSON safely
    let data = null;
    try { data = await res.json(); } catch(e) { data = null; }

    // unified error handling: backend sometimes returns {"status":"error", "message":...}
    if (!res.ok || (data && data.status && data.status !== 'success')) {
      const reason = (data && (data.message || data.error)) ? (data.message || data.error) : (data ? JSON.stringify(data) : `HTTP ${res.status}`);
      console.error('buy_airtime failed', res.status, data);
      alert('Purchase failed: ' + reason);
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = oldHtml;
      return;
    }

    // Success path: backend should return new balance and optional transaction
    // Accept multiple possible shapes: { balance: <num>, transaction: {...} } OR {status:'success', balance:..., transaction:...}
    const newBalance = (data && (typeof data.balance !== 'undefined')) ? Number(data.balance) : null;
    const txn = data && data.transaction ? data.transaction : {
      id: null, type: 'Airtime', network: selectedNetwork.name, recipient: recipient, amount: amount,
      fee: Math.ceil(amount * 0.01), total: (amount + Math.ceil(amount*0.01)), date: (new Date()).toISOString(), status: 'success'
    };

    // If backend didn't provide updated balance, fetch /user/<phone> to be sure
    let updatedUser = user;
    if (newBalance === null) {
      try {
        const r2 = await fetch(`${API_BASE}/user/${encodeURIComponent(user.phone)}`);
        if (r2.ok) {
          const j = await r2.json();
          if (j && j.status === 'success' && j.user) {
            updatedUser = j.user;
          }
        }
      } catch(err2){
        console.warn('Could not refetch user after purchase', err2);
      }
    } else {
      updatedUser = Object.assign({}, user, { balance: newBalance });
    }

    // Persist updated user to localStorage so dashboard picks it up
    setStoredUser(updatedUser);

    // Fire event payload that transactions.html listener can parse
    const evt = { type:'airtime_purchase', transaction: txn, balance: (updatedUser.balance || newBalance), ts: Date.now() };
    try {
      localStorage.setItem('payme_event', JSON.stringify(evt));
      setTimeout(()=> localStorage.removeItem('payme_event'), 1000);
    } catch(e){ /* ignore */ }

    // success UI
    confirmOverlay.classList.remove('show');
    showToast('Payment successful ✅');

    // reset UI
    amountBtns.forEach(x=>x.classList.remove('active'));
    customAmount.value = '';
    recipientInput.value = '';
    selectedAmount = null;
    updatePayState();

    // optional: redirect to dashboard or transactions
    // window.location.href = 'dashboard.html';

  } catch (err) {
    console.error('Network error', err);
    alert('Network error while purchasing airtime — check console for details.');
  } finally {
    confirmBtn.disabled = false;
    confirmBtn.innerHTML = oldHtml;
  }
});

/* close overlays on ESC */
document.addEventListener('keydown', (e)=> { if (e.key === 'Escape') { confirmOverlay.classList.remove('show'); modalOverlay.classList.remove('show'); } });
</script>
</body>
</html>