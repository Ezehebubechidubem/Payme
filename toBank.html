<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transfer to Bank/Wallet - PAYME</title>
  <style>
    body{font-family:Arial, sans-serif;background:#f4f6f8;margin:0;padding:20px}
    .container{max-width:400px;margin:auto;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);padding:20px;position:relative}
    .back-arrow{position:fixed;left:12px;top:12px;width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;text-decoration:none;color:#555;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.08);z-index:999}
    .back-arrow i{font-size:18px}
    h2{text-align:center;margin-bottom:20px;color:#00c853}
    label{font-size:14px;font-weight:bold;margin-bottom:6px;display:block}
    input{width:100%;padding:10px;margin-bottom:16px;border:1px solid #ccc;border-radius:6px;font-size:14px}
    button{width:100%;background:#00c853;border:none;color:#fff;padding:12px;border-radius:6px;font-weight:bold;cursor:pointer;font-size:14px;margin-bottom:10px}
    button:hover{background:#009624}
    .receiver-info{font-size:14px;padding:10px;background:#e8f5e9;border-radius:6px;margin-bottom:16px;display:none}
    .error{color:red;font-size:13px;margin-bottom:10px;display:none}
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:9999}
    .modal-overlay.show{display:flex}
    .modal{width:calc(100% - 48px);max-width:520px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 18px 40px rgba(10,20,30,0.15);text-align:center}
    .modal .badge{width:68px;height:68px;border-radius:50%;background:linear-gradient(135deg,#00c853,#43a047);color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:32px;margin-bottom:12px}
    .modal .badge.error{background:linear-gradient(135deg,#f44336,#e53935)}
    .detail-list{text-align:left;margin-top:12px}
    .detail-item{display:flex;justify-content:space-between;padding:10px 12px;background:#fafafa;border-radius:10px;margin-bottom:10px}
    .detail-label{color:#666;font-size:13px}
    .detail-value{font-weight:700;text-align:right}
    .modal .actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
    .btn-outline{padding:10px 14px;border-radius:8px;border:1px solid #ddd;background:#fff;color:#333;cursor:pointer}
    .btn-primary{padding:10px 14px;border-radius:8px;border:0;background:#00c853;color:#fff;cursor:pointer}
    @media(max-width:420px){.container{padding:16px}.modal{padding:14px}.back-arrow{left:8px;top:8px;width:36px;height:36px}}
  </style>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
</head>
<body>

  <!-- top-left arrow (replaces back button) -->
  <a class="back-arrow" href="paymelogin.html" aria-label="Back to dashboard"><i class="fa fa-arrow-left"></i></a>

  <div class="container">
    <h2>Transfer Money</h2>

    <label for="accountNumber">Receiver Account Number</label>
    <input type="text" id="accountNumber" placeholder="Enter account number" maxlength="10" />

    <div class="receiver-info" id="receiverInfo"></div>
    <div class="error" id="error"></div>

    <label for="amount">Amount (₦)</label>
    <input type="number" id="amount" placeholder="Enter amount" />

    <button id="sendBtn">Send Money</button>
  </div>

  <!-- SUCCESS POPUP (detailed) -->
  <div id="successModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="badge">₦</div>
      <h3 id="successTitle">Money received</h3>
      <p id="successSubtitle" style="font-weight:700;font-size:28px;margin:4px 0">₦<span id="successAmount">0.00</span></p>
      <div style="display:inline-block;padding:8px 12px;border-radius:8px;background:#e8f5e9;color:#0b8a39;font-weight:700;margin-bottom:12px" id="successStatus">Successful</div>

      <div class="detail-list" id="detailList"></div>

      <div class="actions" style="margin-top:6px">
        <button id="viewTransactionsBtn" class="btn-outline">View Transactions</button>
        <button id="closeSuccessBtn" class="btn-primary">Done</button>
      </div>
    </div>
  </div>

  <!-- ERROR POPUP -->
  <div id="errorModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="badge error">✕</div>
      <h3 id="errorHeader">Error</h3>
      <p id="errorText">An error occurred</p>
      <div class="actions">
        <button id="errorOkBtn" class="btn-primary">OK</button>
      </div>
    </div>
  </div>

<script>
  const API_BASE = "https://payme-update.onrender.com";

  const accountInput = document.getElementById("accountNumber");
  const receiverInfo = document.getElementById("receiverInfo");
  const errorBox = document.getElementById("error");
  const sendBtn = document.getElementById("sendBtn");
  const amountInput = document.getElementById("amount");
  const successModal = document.getElementById("successModal");
  const detailList = document.getElementById("detailList");
  const successAmountEl = document.getElementById("successAmount");
  const successStatusEl = document.getElementById("successStatus");
  const successTitle = document.getElementById("successTitle");
  const viewTransactionsBtn = document.getElementById("viewTransactionsBtn");
  const closeSuccessBtn = document.getElementById("closeSuccessBtn");
  const errorModal = document.getElementById("errorModal");
  const errorHeader = document.getElementById("errorHeader");
  const errorText = document.getElementById("errorText");
  const errorOkBtn = document.getElementById("errorOkBtn");

  const currentUser = JSON.parse(localStorage.getItem("loggedInUser")) || JSON.parse(localStorage.getItem("user")) || null;

  let receiverExists = false;
  let receiverUsername = "";
  let lookupController = null;

  function showErrorPopup(message, title = "Error", onOk = null) {
    errorHeader.textContent = title;
    errorText.textContent = message;
    errorModal.classList.add('show');
    errorModal.setAttribute('aria-hidden','false');
    errorOkBtn.focus();
    errorOkBtn.onclick = function() {
      hideErrorPopup();
      if (typeof onOk === 'function') onOk();
    };
  }
  function hideErrorPopup() {
    errorModal.classList.remove('show');
    errorModal.setAttribute('aria-hidden','true');
    errorOkBtn.onclick = null;
  }
  function formatMoney(n){ if (n == null) return "0.00"; return Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

  async function fetchBalance() {
    if (!currentUser || !currentUser.phone) return 0;
    try {
      const res = await fetch(`${API_BASE}/balance/${currentUser.phone}`);
      const data = await res.json().catch(()=>null);
      if (res.ok && data && (data.balance !== undefined)) {
        localStorage.setItem("balance", data.balance);
        return parseFloat(data.balance);
      }
    } catch (e){}
    return parseFloat(localStorage.getItem("balance")) || 0;
  }

  // must be a registered recipient
  async function lookupReceiver(acc) {
    receiverExists = false;
    receiverUsername = "";
    receiverInfo.style.display = "none";
    errorBox.style.display = "none";

    if (!acc || acc.length !== 10) return;

    const userAcc = currentUser ? (currentUser.account_number || currentUser.acc_number || currentUser.accountNumber || '') : '';
    if (userAcc && String(userAcc) === String(acc)) {
      errorBox.textContent = "❌ You cannot send money to yourself!";
      errorBox.style.display = "block";
      receiverExists = false;
      return;
    }

    try {
      if (lookupController) lookupController.abort();
      lookupController = new AbortController();
      const res = await fetch(`${API_BASE}/user_by_account/${acc}`, { signal: lookupController.signal });
      lookupController = null;
      const data = await res.json().catch(()=>null);

      if (res.ok && data && data.status === "success" && (data.username || data.name)) {
        receiverExists = true;
        receiverUsername = data.username || data.name || '';
        receiverInfo.textContent = "✅ Receiver: " + receiverUsername;
        receiverInfo.style.display = "block";
        errorBox.style.display = "none";
      } else {
        receiverExists = false;
        receiverUsername = "";
        errorBox.textContent = "❌ Invalid account — recipient not registered";
        errorBox.style.display = "block";
        receiverInfo.style.display = "none";
      }
    } catch (err) {
      receiverExists = false;
      receiverUsername = "";
      if (err.name === 'AbortError') return;
      errorBox.textContent = "❌ Invalid account or network error — recipient not registered";
      errorBox.style.display = "block";
      receiverInfo.style.display = "none";
      console.warn('lookupReceiver error', err);
    }
  }

  accountInput.addEventListener('input', function() {
    let v = accountInput.value || '';
    v = v.replace(/\D/g,'');
    if (v.length > 10) v = v.slice(0,10);
    if (accountInput.value !== v) accountInput.value = v;
    if (v.length === 10) lookupReceiver(v);
    else { receiverExists = false; receiverUsername = ""; receiverInfo.style.display = "none"; errorBox.style.display = "none"; }
  });

  function generateReference(){
    return 'tx-' + Date.now() + '-' + Math.random().toString(36).slice(2,9);
  }

  function lockUI(){ sendBtn.disabled = true; sendBtn.textContent = 'Processing...'; }
  function unlockUI(){ sendBtn.disabled = false; sendBtn.textContent = 'Send Money'; }

  // click handler: builds pending_tx, ensures fresh balance, sets idempotency key and redirects
  sendBtn.addEventListener('click', async function(){
    lockUI();
    try {
      const receiverAcc = accountInput.value.trim();
      const amount = parseFloat(amountInput.value);

      if (!receiverAcc || receiverAcc.length !== 10) {
        showErrorPopup("Please enter a valid 10-digit receiver account.", "Invalid account", function(){ unlockUI(); });
        return;
      }
      if (!amount || isNaN(amount) || amount <= 0) {
        showErrorPopup("Enter a valid amount.", "Invalid amount", function(){ unlockUI(); });
        return;
      }

      if (!receiverExists) {
        await lookupReceiver(receiverAcc);
        if (!receiverExists) {
          showErrorPopup("Invalid account — recipient not registered", "Invalid recipient", function(){ unlockUI(); });
          return;
        }
      }

      const userAcc = currentUser ? (currentUser.account_number || currentUser.acc_number || currentUser.accountNumber || '') : null;
      if (userAcc && receiverAcc === String(userAcc)) {
        showErrorPopup("You cannot send money to your own account!", "Invalid transfer", function(){ unlockUI(); });
        return;
      }

      // fetch freshest balance from server (avoid stale localStorage)
      const balance = await fetchBalance();
      if (amount > balance) {
        showErrorPopup("Insufficient funds.", "Insufficient balance", function(){ unlockUI(); });
        return;
      }

      const reference = generateReference();
      const amountKobo = Math.round(amount * 100);

      const pending = {
        phone: (currentUser && currentUser.phone) || null,
        sender: (currentUser && (currentUser.username || currentUser.name)) || 'You',
        senderAccount: (currentUser && (currentUser.account_number || currentUser.acc_number || currentUser.accountNumber)) || '-',
        receiver_acc: receiverAcc,
        recipient: receiverUsername || receiverAcc,
        recipientAccount: receiverAcc,
        amount: amount,
        amount_kobo: amountKobo,
        receiver_bank: "PAYME",
        receiver_bank_name: "PAYME",
        network: "PAYME",
        product: 'towallet',
        created_at: new Date().toISOString(),
        reference: reference,
        idempotency_key: reference
      };

      try { sessionStorage.setItem('pending_tx', JSON.stringify(pending)); }
      catch (e) {
        console.error('session storage failed', e);
        showErrorPopup('Unable to create pending transaction. Try again.', 'Storage error', function(){ unlockUI(); });
        return;
      }

      // Redirect to Mainauthentication for PIN confirmation and final execute
      // Mainauthentication should read sessionStorage.pending_tx and use reference/idempotency_key
      window.location.href = 'Mainauthentication.html';

    } finally {
      // deliberately leave UI locked when redirecting; unlock only if needed
    }
  });

  // When returning from Mainauthentication, show success popup if last_tx_success is set in sessionStorage
  (function showReturnPopupIfExists(){
    try {
      const last = sessionStorage.getItem('last_tx_success');
      if (!last) return;
      const payload = JSON.parse(last);
      sessionStorage.removeItem('last_tx_success');

      const amount = Number(payload.amount || payload.orderAmount || payload.total || 0);
      successAmountEl.textContent = formatMoney(amount);
      successStatusEl.textContent = (payload.statusText || payload.message || 'Successful');
      successTitle.textContent = payload.type === 'error' ? 'Transaction failed' : 'Money received';

      detailList.innerHTML = '';
      function addDetail(label, value){
        const row = document.createElement('div');
        row.className = 'detail-item';
        const lab = document.createElement('div'); lab.className='detail-label'; lab.textContent = label;
        const val = document.createElement('div'); val.className='detail-value'; val.textContent = value ?? '-';
        row.appendChild(lab); row.appendChild(val);
        detailList.appendChild(row);
      }

      addDetail('Order amount','₦'+formatMoney(amount));
      addDetail('Date/Time', payload.datetime || new Date().toLocaleString());
      addDetail('Sender', (payload.sender || (currentUser && (currentUser.username || currentUser.name))) || 'You');
      addDetail('Sender Account', (payload.senderAccount || (currentUser && currentUser.account_number)) || '-');
      addDetail('Bank Name','PAYME');
      addDetail('Recipient', payload.recipient || payload.receiver_name || payload.receiver || '-');
      addDetail('Recipient Account', payload.recipientAccount || payload.receiver_acc || payload.receiver || '-');
      addDetail('Transaction NO.', payload.txnNo || payload.transaction_id || payload.reference || '-');

      successModal.classList.add('show');
      successModal.setAttribute('aria-hidden','false');
      closeSuccessBtn.focus();
    } catch (e) { console.warn('showReturnPopupIfExists error', e); }
  })();

  viewTransactionsBtn.addEventListener('click', function(){
    successModal.classList.remove('show'); successModal.setAttribute('aria-hidden','true');
    window.location.href = 'transactions.html';
  });
  closeSuccessBtn.addEventListener('click', function(){
    successModal.classList.remove('show'); successModal.setAttribute('aria-hidden','true');
  });
  errorOkBtn.addEventListener('click', hideErrorPopup);

  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') {
      if (successModal.classList.contains('show')) { successModal.classList.remove('show'); successModal.setAttribute('aria-hidden','true'); }
      if (errorModal.classList.contains('show')) { hideErrorPopup(); }
    }
  });

  if (!currentUser) {
    showErrorPopup("No logged-in user found. Please login first.", "Not logged in", function(){ window.location.href = "paymelogin.html"; });
  }
</script>
</body>
</html>