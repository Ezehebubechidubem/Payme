<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PAYME — Confirm Transaction (PIN)</title>
  <style>
    :root{ --bg:#fafafa; --card:#fff; --accent:#00a884; --danger:#d9534f; --muted:#666; }
    html,body{height:100%;margin:0;font-family:system-ui,Arial;background:var(--bg);display:flex;align-items:center;justify-content:center}
    .card{width:100%;max-width:420px;background:var(--card);border-radius:12px;padding:20px;box-shadow:0 12px 40px rgba(0,0,0,0.08)}
    h2{margin:0 0 6px}
    p{color:var(--muted);margin:0 0 12px}
    .pin-dots{display:flex;gap:10px;justify-content:center;margin:18px 0}
    .dot{width:56px;height:56px;border-radius:8px;border:1px solid #eee;display:flex;align-items:center;justify-content:center;font-size:24px;background:#fff}
    .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .key{height:64px;border-radius:10px;background:#fff;border:1px solid #eee;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;user-select:none}
    .row{display:flex;gap:8px;margin-top:12px}
    .btn{flex:1;padding:10px;border-radius:10px;border:0;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-outline{background:#fff;border:1px solid #ddd}
    .danger{color:var(--danger);margin-top:8px;text-align:center;display:none}
    .note{color:#666;font-size:13px;text-align:center;margin-top:8px}
    .hidden{display:none}
    .key.disabled { opacity:0.6; pointer-events:none; }
    .small-muted{font-size:12px;color:#888;margin-top:8px;text-align:center}
  </style>
</head>
<body>
  <div class="card" role="dialog" aria-modal="true">
    <h2>Enter your 4-digit PIN</h2>
    <p>Confirm this transaction with the PIN linked to your account.</p>

    <div class="pin-dots" id="pinDots" aria-hidden="false">
      <div class="dot" data-index="0" aria-hidden="true"></div>
      <div class="dot" data-index="1" aria-hidden="true"></div>
      <div class="dot" data-index="2" aria-hidden="true"></div>
      <div class="dot" data-index="3" aria-hidden="true"></div>
    </div>

    <div id="message" class="note">Type your 4-digit PIN</div>
    <div id="error" class="danger" role="alert"></div>
    <div id="statusHint" class="small-muted" aria-live="polite"></div>

    <div class="keypad" id="keypad" aria-label="PIN keypad" style="margin-top:14px">
      <div class="key" role="button" tabindex="0">1</div><div class="key" role="button" tabindex="0">2</div><div class="key" role="button" tabindex="0">3</div>
      <div class="key" role="button" tabindex="0">4</div><div class="key" role="button" tabindex="0">5</div><div class="key" role="button" tabindex="0">6</div>
      <div class="key" role="button" tabindex="0">7</div><div class="key" role="button" tabindex="0">8</div><div class="key" role="button" tabindex="0">9</div>
      <div class="key" id="blank" aria-hidden="true"></div><div class="key" role="button" tabindex="0">0</div><div class="key" id="back" role="button" tabindex="0" aria-label="Backspace">⌫</div>
    </div>

    <div class="row" style="margin-top:18px">
      <button id="cancelBtn" class="btn btn-outline">Cancel</button>
      <button id="submitBtn" class="btn btn-primary" disabled>Verify & Pay</button>
    </div>
  </div>

<script>
  (function(){
    // ------------- CONFIG -------------
    const API_BASE = "https://payme-update.onrender.com";
    const VERIFY_ROUTE = `${API_BASE}/api/pin/verify`;
    const STATUS_ROUTE = `${API_BASE}/api/pin/status`;
    const LOCK_THRESHOLD = 3;                   // must match backend
    const LOCK_DURATION_HOURS = 4;              // informative only (backend enforces)
    // localstorage key prefix
    const LOCK_KEY_PREFIX = 'pin_lock_';

    // ------------- ELEMENTS -------------
    const keypad = document.getElementById('keypad');
    const pinDots = Array.from(document.querySelectorAll('.dot'));
    const message = document.getElementById('message');
    const errorEl = document.getElementById('error');
    const statusHint = document.getElementById('statusHint');
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    // ------------- STATE -------------
    let current = '';
    let pending = null;
    let lockInfo = { failedAttempts: 0, lockedUntil: null };
    let lockKey = null;
    let countdownTimer = null;

    // ------------- Helpers -------------
    function getStoredUser() {
      const j = localStorage.getItem("loggedInUser") || localStorage.getItem("user");
      try { return j ? JSON.parse(j) : null; } catch(e){ return null; }
    }

    function refreshDots(){
      pinDots.forEach((d,i)=> {
        const ch = current[i] || '';
        d.textContent = ch ? '•' : '';
        d.classList.toggle('filled', !!ch);
      });
      submitBtn.disabled = (current.length !== 4) || isLocked();
    }

    function showError(msg){
      errorEl.style.display='block';
      errorEl.textContent = msg;
    }
    function clearError(){
      errorEl.style.display='none';
      errorEl.textContent='';
    }

    function setStatusHint(text){
      statusHint.textContent = text || '';
    }

    function isLockedLocal(){
      if (!lockInfo || !lockInfo.lockedUntil) return false;
      try { return (new Date(lockInfo.lockedUntil) > new Date()); } catch(e){ return false; }
    }

    function isLocked(){ return isLockedLocal(); }

    function disableKeypad(){
      keypad.querySelectorAll('.key').forEach(k => k.classList.add('disabled'));
      submitBtn.disabled = true;
    }
    function enableKeypad(){
      keypad.querySelectorAll('.key').forEach(k => k.classList.remove('disabled'));
      submitBtn.disabled = (current.length !== 4) || isLocked();
    }

    function saveLocalLock(accountId){
      if (!accountId) return;
      try {
        localStorage.setItem(LOCK_KEY_PREFIX + accountId, JSON.stringify(lockInfo));
      } catch(e){}
    }
    function loadLocalLock(accountId){
      if (!accountId) return { failedAttempts:0, lockedUntil:null };
      try {
        const raw = localStorage.getItem(LOCK_KEY_PREFIX + accountId);
        if (!raw) return { failedAttempts:0, lockedUntil:null };
        return JSON.parse(raw);
      } catch(e){ return { failedAttempts:0, lockedUntil:null }; }
    }
    function clearLocalLock(accountId){
      if (!accountId) return;
      try { localStorage.removeItem(LOCK_KEY_PREFIX + accountId); } catch(e){}
      lockInfo = { failedAttempts:0, lockedUntil:null };
      enableKeypad();
      setStatusHint('');
      if (countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
    }

    function startCountdown(untilIso){
      if (!untilIso) return;
      if (countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
      countdownTimer = setInterval(()=>{
        const until = new Date(untilIso);
        const msLeft = until - new Date();
        if (msLeft <= 0) {
          clearInterval(countdownTimer);
          countdownTimer = null;
          // attempt to re-check server status (if online)
          fetchStatusAndUpdateUI();
          return;
        }
        const sec = Math.floor(msLeft/1000)%60;
        const min = Math.floor(msLeft/60000)%60;
        const hrs = Math.floor(msLeft/(3600*1000));
        let display = '';
        if (hrs>0) display = `${hrs}h ${min}m`;
        else if (min>0) display = `${min}m ${sec}s`;
        else display = `${sec}s`;
        setStatusHint(`Too many failed attempts. Try again in ${display}.`);
      }, 1000);
    }

    // ------------- Network helpers -------------
    async function fetchStatusAndUpdateUI(){
      // status endpoint requires auth cookie — include credentials
      const user = getStoredUser();
      const acct = user ? (user.account_number || user.accountNumber || user.phone) : null;
      if (!acct) {
        // no logged-in user info; try to keep UI enabled but warn user
        setStatusHint('You must be logged in to verify PIN.');
        return;
      }
      lockKey = LOCK_KEY_PREFIX + acct;

      // try load local cached lock first (fast)
      const local = loadLocalLock(acct);
      lockInfo = local || { failedAttempts:0, lockedUntil:null };
      if (isLockedLocal()) {
        disableKeypad();
        startCountdown(lockInfo.lockedUntil);
      }

      // then check server
      try {
        const res = await fetch(STATUS_ROUTE, { method:'GET', credentials:'include', headers:{ 'Accept':'application/json' } });
        if (!res.ok) {
          // server not reachable or not logged in
          const txt = await res.text().catch(()=>null);
          // If 401, user not logged in; otherwise show minimal hint.
          if (res.status === 401) {
            setStatusHint('Not authenticated. Please log in to set or use PIN.');
          } else {
            setStatusHint('Could not verify PIN status (server).');
          }
          return;
        }
        const j = await res.json().catch(()=>null);
        if (!j) return;
        // Backend returns { hasPin, locked, lockedUntil, failedAttempts }
        lockInfo.failedAttempts = Number(j.failedAttempts || 0);
        lockInfo.lockedUntil = j.locked || false ? (j.lockedUntil || null) : (j.lockedUntil || null);
        saveLocalLock(acct);
        if (j.locked && lockInfo.lockedUntil) {
          disableKeypad();
          startCountdown(lockInfo.lockedUntil);
        } else {
          // not locked: update hint about attempts left
          const left = Math.max(0, LOCK_THRESHOLD - lockInfo.failedAttempts);
          if (left > 0) setStatusHint(`${left} attempt${left>1?'s':''} left before account lock.`);
          else setStatusHint('');
          enableKeypad();
        }
      } catch (err) {
        // network fail: keep local lock state and hint
        console.warn('status fetch failed', err);
      }
    }

    // ------------- Input handling -------------
    function handleKeyEl(keyEl){
      if (keyEl.id === 'back') { current = current.slice(0,-1); clearError(); refreshDots(); return; }
      if (keyEl.id === 'blank') return;
      if (current.length >= 4) return;
      current += (keyEl.textContent || '').trim();
      refreshDots();
    }

    keypad.addEventListener('click', ev=>{
      const k = ev.target;
      if (!k.classList.contains('key')) return;
      if (isLocked()) return;
      handleKeyEl(k);
    });
    document.addEventListener('keydown', ev=>{
      if (ev.key >= '0' && ev.key <= '9') { ev.preventDefault(); if (!isLocked()) { handleKeyEl({ id: null, textContent: ev.key }); } return; }
      if (ev.key === 'Backspace' || ev.key === 'Delete') { ev.preventDefault(); handleKeyEl({ id:'back' }); return; }
      if (ev.key === 'Enter') { ev.preventDefault(); if (!submitBtn.disabled) submitBtn.click(); }
    });

    // ------------- Verify flow -------------
    submitBtn.addEventListener('click', async ()=>{
      clearError();
      if (isLocked()) {
        showError('Account is locked. Wait until lock expires.');
        return;
      }
      if (!current || current.length !==4) { showError('Enter 4-digit PIN'); return; }

      const user = getStoredUser();
      const accountNumber = user ? (user.account_number || user.accountNumber || user.phone) : null;
      if (!accountNumber) { showError('You must be logged in.'); return; }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Verifying...';

      try {
        const payload = { account_number: String(accountNumber), pin: String(current) };
        const res = await fetch(VERIFY_ROUTE, { method:'POST', credentials:'include', headers: { 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
        const j = await res.json().catch(()=>null);

        if (res.ok && j && j.success) {
          // success: clear local lock and proceed with transaction
          clearLocalLock(accountNumber);
          // proceed to execute payment flow (existing logic)
          // we assume sessionStorage.pending_tx already set by previous page
          // redirect back to caller page to continue flow
          window.location.href = sessionStorage.getItem('return_to') || document.referrer || 'airtime.html';
          return;
        }

        // If server says locked (403), use lockedUntil if provided.
        if (res.status === 403) {
          const lockedUntil = (j && j.lockedUntil) ? j.lockedUntil : null;
          lockInfo.failedAttempts = LOCK_THRESHOLD;
          lockInfo.lockedUntil = lockedUntil || new Date(Date.now() + LOCK_DURATION_HOURS*3600*1000).toISOString();
          saveLocalLock(accountNumber);
          disableKeypad();
          startCountdown(lockInfo.lockedUntil);
          showError((j && j.message) ? j.message : 'Too many failed attempts — account locked.');
          return;
        }

        // For invalid PIN (401) or other non-OK replies:
        if (res.status === 401 || (j && j.success === false)) {
          // request fresh status from server to show attempt count
          await fetchStatusAndUpdateUI();
          const left = Math.max(0, LOCK_THRESHOLD - (lockInfo.failedAttempts || 0));
          if (left > 0) {
            showError(`Invalid PIN — ${left} attempt${left>1?'s':''} left before lock.`);
          } else {
            showError('Invalid PIN.');
          }
          current = '';
          refreshDots();
          return;
        }

        // Fallback generic error
        showError((j && j.message) ? j.message : `Verification failed (HTTP ${res.status})`);
      } catch (err) {
        console.error('verify error', err);
        showError('Network error while verifying PIN');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Verify & Pay';
      }
    });

    cancelBtn.addEventListener('click', ()=> {
      // preserve existing behavior (go back)
      if (sessionStorage.getItem('pending_tx')) {
        try {
          const p = JSON.parse(sessionStorage.getItem('pending_tx'));
          if (p && (p.product === 'towallet')) { window.location.href='towallet.html'; return; }
        } catch(e){}
      }
      window.location.href = 'airtime.html';
    });

    // ------------- Init -------------
    (function init(){
      // load pending tx if any (your old logic used this)
      try {
        pending = sessionStorage.getItem('pending_tx') ? JSON.parse(sessionStorage.getItem('pending_tx')) : null;
      } catch(e) { pending = null; }

      const user = getStoredUser();
      const acctId = user ? ((user.account_number || user.accountNumber) || user.phone) : null;
      if (acctId) {
        lockKey = LOCK_KEY_PREFIX + acctId;
        // load local cached lock
        lockInfo = loadLocalLock(acctId) || { failedAttempts:0, lockedUntil:null };
        if (isLockedLocal()) {
          disableKeypad();
          startCountdown(lockInfo.lockedUntil);
        }
      }
      // Always try to fetch authoritative status from server (will update lock state across browsers)
      fetchStatusAndUpdateUI();

      // update initial UI text about pending tx
      if (!pending) {
        const params = new URLSearchParams(window.location.search);
        const debugList = [];
        if (!params.get('phone') && !params.get('recipient')) debugList.push('phone/recipient');
        if (!params.get('network')) debugList.push('network');
        if (!params.get('amount')) debugList.push('amount');
        if (!params.get('receiver_acc') && !sessionStorage.getItem('pending_tx')) debugList.push('receiver_acc (for towallet)');
        if (debugList.length) {
          message.textContent = 'Missing fields: ' + debugList.join(', ') + '. Please return and retry.';
        } else {
          message.textContent = 'No pending transaction found. Go back and try again.';
        }
        submitBtn.disabled = true;
      } else {
        // show the transaction amount/receiver (reuse your original format)
        if (pending.product === 'towallet' || pending.receiver_acc) {
          const recv = pending.receiver_acc || pending.recipient || pending.phone || '-';
          const bank = pending.receiver_bank_name || pending.receiver_bank || pending.bankName || '';
          message.textContent = `Confirm ₦${Number(pending.amount || 0).toLocaleString()} to ${recv}${bank ? ' ('+bank+')' : ''}`;
        } else {
          const recipient = pending.recipient || pending.phone || '-';
          const network = pending.network || '-';
          message.textContent = `Confirm ₦${Number(pending.amount || 0).toLocaleString()} to ${recipient} (${network})`;
        }
        refreshDots();
      }

      // accessibility: focus first key
      const firstKey = keypad.querySelector('.key');
      try { firstKey && firstKey.focus(); } catch(e){}
    })();

    // expose for debugging (optional)
    window._payme_pin_debug = { fetchStatusAndUpdateUI, loadLocalLock, saveLocalLock };

  })();
</script>
</body>
</html>