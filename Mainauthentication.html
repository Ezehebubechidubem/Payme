<!-- Mainauthentication.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PAYME — Confirm Transaction (PIN)</title>
  <style>
    :root{ --bg:#fafafa; --card:#fff; --accent:#00a884; --danger:#d9534f; --muted:#666; }
    html,body{height:100%;margin:0;font-family:system-ui,Arial;background:var(--bg);display:flex;align-items:center;justify-content:center}
    .card{width:100%;max-width:420px;background:var(--card);border-radius:12px;padding:20px;box-shadow:0 12px 40px rgba(0,0,0,0.08)}
    h2{margin:0 0 6px}
    p{color:var(--muted);margin:0 0 12px}
    .pin-dots{display:flex;gap:10px;justify-content:center;margin:18px 0}
    .dot{width:56px;height:56px;border-radius:8px;border:1px solid #eee;display:flex;align-items:center;justify-content:center;font-size:24px;background:#fff}
    .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .key{height:64px;border-radius:10px;background:#fff;border:1px solid #eee;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;user-select:none}
    .row{display:flex;gap:8px;margin-top:12px}
    .btn{flex:1;padding:10px;border-radius:10px;border:0;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-outline{background:#fff;border:1px solid #ddd}
    .danger{color:var(--danger);margin-top:8px;text-align:center;display:none}
    .note{color:#666;font-size:13px;text-align:center;margin-top:8px}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="card" role="dialog" aria-modal="true">
    <h2>Enter your 4-digit PIN</h2>
    <p>Confirm this transaction with the PIN linked to your account.</p>

    <div class="pin-dots" id="pinDots" aria-hidden="false">
      <div class="dot" data-index="0" aria-hidden="true"></div>
      <div class="dot" data-index="1" aria-hidden="true"></div>
      <div class="dot" data-index="2" aria-hidden="true"></div>
      <div class="dot" data-index="3" aria-hidden="true"></div>
    </div>

    <div id="message" class="note">Type your 4-digit PIN</div>
    <div id="error" class="danger" role="alert"></div>

    <div class="keypad" id="keypad" aria-label="PIN keypad" style="margin-top:14px">
      <div class="key" role="button" tabindex="0">1</div><div class="key" role="button" tabindex="0">2</div><div class="key" role="button" tabindex="0">3</div>
      <div class="key" role="button" tabindex="0">4</div><div class="key" role="button" tabindex="0">5</div><div class="key" role="button" tabindex="0">6</div>
      <div class="key" role="button" tabindex="0">7</div><div class="key" role="button" tabindex="0">8</div><div class="key" role="button" tabindex="0">9</div>
      <div class="key" id="blank" aria-hidden="true"></div><div class="key" role="button" tabindex="0">0</div><div class="key" id="back" role="button" tabindex="0" aria-label="Backspace">⌫</div>
    </div>

    <div class="row" style="margin-top:18px">
      <button id="cancelBtn" class="btn btn-outline">Cancel</button>
      <button id="submitBtn" class="btn btn-primary" disabled>Verify & Pay</button>
    </div>
  </div>

<script>
  (function(){
    const API_BASE = "https://payme-update.onrender.com";
    const keypad = document.getElementById('keypad');
    const pinDots = Array.from(document.querySelectorAll('.dot'));
    const message = document.getElementById('message');
    const errorEl = document.getElementById('error');
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    function getStoredUser() {
      const j = localStorage.getItem("loggedInUser") || localStorage.getItem("user");
      try { return j ? JSON.parse(j) : null; } catch(e){ return null; }
    }

    function getPending() {
      try { const p = sessionStorage.getItem('pending_tx'); return p ? JSON.parse(p) : null; } catch(e){ return null; }
    }
    function clearPending() {
      try { sessionStorage.removeItem('pending_tx'); } catch(e){}
    }

    let current = '';

    function refreshDots(){
      pinDots.forEach((d,i)=>{
        const ch = current[i] || '';
        d.textContent = ch ? '•' : '';
        d.classList.toggle('filled', !!ch);
      });
      submitBtn.disabled = (current.length !== 4);
    }

    function showError(msg){
      errorEl.style.display='block';
      errorEl.textContent=msg;
    }
    function clearError(){ errorEl.style.display='none'; errorEl.textContent=''; }

    keypad.addEventListener('click', ev=>{
      const k = ev.target;
      if (!k.classList.contains('key')) return;
      handleKey(k);
    });
    keypad.addEventListener('keydown', ev=>{
      if (ev.key === 'Enter' || ev.key === ' ') {
        const k = document.activeElement;
        if (k && k.classList.contains('key')) {
          ev.preventDefault();
          handleKey(k);
        }
      }
    });
    function handleKey(k){
      if (k.id === 'back') { current = current.slice(0,-1); clearError(); refreshDots(); return; }
      if (k.id === 'blank') return;
      if (current.length >= 4) return;
      current += (k.textContent || '').trim();
      refreshDots();
    }

    cancelBtn.addEventListener('click', ()=>{
      // redirect back to airtime (data.html)
      window.location.href = 'data.html';
    });

    submitBtn.addEventListener('click', async ()=>{
      clearError();
      const pending = getPending();
      if (!pending) {
        showError('No pending transaction found. Go back and try again.');
        return;
      }

      const user = getStoredUser();
      if (!user || !(user.account_number || user.accountNumber)) {
        showError('You must be logged in. Please log in and try again.');
        return;
      }

      const accountNumber = (user.account_number || user.accountNumber || '').toString();
      const payload = { account_number: accountNumber, pin: current };

      try {
        const res = await fetch(`${API_BASE}/api/pin/verify`, {
          method: 'POST',
          credentials: 'include',           // <- include session cookie
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const j = await res.json().catch(()=>({ success:false, message: 'Invalid server response' }));

        if (res.ok && j.success) {
          // PIN ok -> execute pending transaction (also include credentials)
          const txPayload = {
            phone: pending.phone,
            network: pending.network,
            amount: pending.amount,
            recipient: pending.recipient,
            product: pending.product || 'airtime'
          };

          try {
            const execRes = await fetch(`${API_BASE}/buy_airtime`, {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(txPayload)
            });
            const execJson = await execRes.json().catch(()=>null);

            if (execRes.ok && execJson && execJson.status === 'success') {
              clearPending();
              sessionStorage.setItem('last_tx_success', JSON.stringify({
                message: execJson.message || 'Airtime purchased successfully',
                amount: pending.amount,
                network: pending.network
              }));
              window.location.href = 'data.html';
              return;
            } else {
              const reason = execJson && (execJson.message || execJson.error) ? (execJson.message || execJson.error) : `HTTP ${execRes.status}`;
              showError('Transaction failed: ' + reason);
              return;
            }
          } catch(execErr){
            console.error('execution error', execErr);
            showError('Network error while executing transaction.');
            return;
          }

        } else {
          const msg = (j && j.message) ? j.message : 'Invalid PIN';
          showError(msg);
          current = '';
          refreshDots();
          return;
        }
      } catch(err){
        console.error('verify error', err);
        showError('Network error while verifying PIN');
        return;
      }
    });

    (function init(){
      const pending = getPending();
      if (!pending) {
        message.textContent = 'No pending transaction — go back and try again.';
        submitBtn.disabled = true;
      } else {
        message.textContent = `Confirm ₦${Number(pending.amount).toLocaleString()} to ${pending.recipient} (${pending.network})`;
      }
      refreshDots();
    })();

    document.querySelectorAll('.key').forEach(k => { k.setAttribute('tabindex', '0'); });

  })();
</script>
</body>
</html>