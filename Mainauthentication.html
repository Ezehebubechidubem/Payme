<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PAYME — Confirm Transaction (PIN)</title>
  <style>
    :root{ --bg:#fafafa; --card:#fff; --accent:#00a884; --danger:#d9534f; --muted:#666; }
    html,body{height:100%;margin:0;font-family:system-ui,Arial;background:var(--bg);display:flex;align-items:center;justify-content:center}
    .card{width:100%;max-width:420px;background:var(--card);border-radius:12px;padding:20px;box-shadow:0 12px 40px rgba(0,0,0,0.08)}
    h2{margin:0 0 6px}
    p{color:var(--muted);margin:0 0 12px}
    .pin-dots{display:flex;gap:10px;justify-content:center;margin:18px 0}
    .dot{width:56px;height:56px;border-radius:8px;border:1px solid #eee;display:flex;align-items:center;justify-content:center;font-size:24px;background:#fff}
    .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .key{height:64px;border-radius:10px;background:#fff;border:1px solid #eee;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;user-select:none}
    .row{display:flex;gap:8px;margin-top:12px}
    .btn{flex:1;padding:10px;border-radius:10px;border:0;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-outline{background:#fff;border:1px solid #ddd}
    .danger{color:var(--danger);margin-top:8px;text-align:center;display:none}
    .note{color:#666;font-size:13px;text-align:center;margin-top:8px}
    .hidden{display:none}
    .key.disabled { opacity:0.6; pointer-events:none; }
    .small-muted{font-size:12px;color:#888;margin-top:8px;text-align:center}
  </style>
</head>
<body>
  <div class="card" role="dialog" aria-modal="true">
    <h2>Enter your 4-digit PIN</h2>
    <p>Confirm this transaction with the PIN linked to your account.</p>

    <div class="pin-dots" id="pinDots" aria-hidden="false">
      <div class="dot" data-index="0" aria-hidden="true"></div>
      <div class="dot" data-index="1" aria-hidden="true"></div>
      <div class="dot" data-index="2" aria-hidden="true"></div>
      <div class="dot" data-index="3" aria-hidden="true"></div>
    </div>

    <div id="message" class="note">Type your 4-digit PIN</div>
    <div id="error" class="danger" role="alert"></div>
    <div id="statusHint" class="small-muted" aria-live="polite"></div>

    <div class="keypad" id="keypad" aria-label="PIN keypad" style="margin-top:14px">
      <div class="key" role="button" tabindex="0">1</div><div class="key" role="button" tabindex="0">2</div><div class="key" role="button" tabindex="0">3</div>
      <div class="key" role="button" tabindex="0">4</div><div class="key" role="button" tabindex="0">5</div><div class="key" role="button" tabindex="0">6</div>
      <div class="key" role="button" tabindex="0">7</div><div class="key" role="button" tabindex="0">8</div><div class="key" role="button" tabindex="0">9</div>
      <div class="key" id="blank" aria-hidden="true"></div><div class="key" role="button" tabindex="0">0</div><div class="key" id="back" role="button" tabindex="0" aria-label="Backspace">⌫</div>
    </div>

    <div class="row" style="margin-top:18px">
      <button id="cancelBtn" class="btn btn-outline">Cancel</button>
      <button id="submitBtn" class="btn btn-primary" disabled>Verify & Pay</button>
    </div>
  </div>

<script>
  (function(){
    // ---------- CONFIG ----------
    const API_BASE = "https://payme-update.onrender.com";
    const VERIFY_ROUTE = `${API_BASE}/api/pin/verify`;
    const STATUS_ROUTE = `${API_BASE}/api/pin/status`;
    const LOCK_THRESHOLD = 3;           // match backend threshold
    const POLL_INTERVAL_MS = 8000;     // poll server status for cross-browser sync

    // ---------- DOM ----------
    const keypad = document.getElementById('keypad');
    const pinDots = Array.from(document.querySelectorAll('.dot'));
    const message = document.getElementById('message');
    const errorEl = document.getElementById('error');
    const statusHint = document.getElementById('statusHint');
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    // ---------- STATE ----------
    let current = '';
    let pending = null;
    let lockInfo = { failedAttempts: 0, lockedUntil: null }; // authoritative if filled by server
    let pollTimer = null;
    let countdownTimer = null;

    // ---------- helpers ----------
    function getStoredUser() {
      const j = localStorage.getItem("loggedInUser") || localStorage.getItem("user");
      try { return j ? JSON.parse(j) : null; } catch(e){ return null; }
    }

    function refreshDots(){
      pinDots.forEach((d,i)=> {
        const ch = current[i] || '';
        d.textContent = ch ? '•' : '';
        d.classList.toggle('filled', !!ch);
      });
      submitBtn.disabled = (current.length !== 4) || isLocked();
    }

    function showError(msg){
      errorEl.style.display='block';
      errorEl.textContent = msg;
    }
    function clearError(){
      errorEl.style.display='none'; errorEl.textContent='';
    }
    function setStatusHint(text){ statusHint.textContent = text || ''; }

    function isLocked(){
      if (!lockInfo || !lockInfo.lockedUntil) return false;
      try { return new Date(lockInfo.lockedUntil) > new Date(); } catch(e){ return false; }
    }

    function disableKeypad(){
      keypad.querySelectorAll('.key').forEach(k => k.classList.add('disabled'));
      submitBtn.disabled = true;
    }
    function enableKeypad(){
      keypad.querySelectorAll('.key').forEach(k => k.classList.remove('disabled'));
      submitBtn.disabled = (current.length !== 4) || isLocked();
    }

    function formatRemaining(ms){
      if (ms <= 0) return '0s';
      const totalSec = Math.floor(ms/1000);
      const hrs = Math.floor(totalSec / 3600);
      const mins = Math.floor((totalSec % 3600) / 60);
      const secs = totalSec % 60;
      if (hrs > 0) return `${hrs}h ${mins}m`;
      if (mins > 0) return `${mins}m ${secs}s`;
      return `${secs}s`;
    }

    function startCountdown(untilIso){
      if (countdownTimer) clearInterval(countdownTimer);
      if (!untilIso) return;
      countdownTimer = setInterval(()=> {
        const until = new Date(untilIso);
        const msLeft = until - new Date();
        if (msLeft <= 0) {
          clearInterval(countdownTimer);
          countdownTimer = null;
          // re-check authoritative server state
          fetchStatusAndUpdateUI();
          return;
        }
        setStatusHint(`Too many failed attempts. Try again in ${formatRemaining(msLeft)}.`);
      }, 1000);
    }

    // ---------- server sync ----------
    async function fetchStatusAndUpdateUI(){
      // Try to fetch /api/pin/status (server authoritative)
      try {
        const res = await fetch(STATUS_ROUTE, { method: 'GET', credentials: 'include', headers: { 'Accept': 'application/json' } });
        if (!res.ok) {
          // Not logged in or server error
          if (res.status === 401) {
            setStatusHint('Not authenticated — please log in.');
            // still keep local UI enabled/disabled as-is
            return;
          }
          // other server issues - skip
          return;
        }
        const j = await res.json().catch(()=>null);
        if (!j) return;
        // expected: { hasPin, locked: bool, lockedUntil: null|string, failedAttempts: 0 }
        lockInfo.failedAttempts = Number(j.failedAttempts || 0);
        lockInfo.lockedUntil = j.locked && j.lockedUntil ? j.lockedUntil : (j.lockedUntil || null);

        if (j.locked && lockInfo.lockedUntil) {
          disableKeypad();
          startCountdown(lockInfo.lockedUntil);
          showError(j.message || 'Too many failed attempts. Account locked.');
        } else {
          enableKeypad();
          const left = Math.max(0, LOCK_THRESHOLD - lockInfo.failedAttempts);
          if (left > 0) setStatusHint(`${left} attempt${left>1?'s':''} left before account lock.`);
          else setStatusHint('');
          clearError();
        }
      } catch (err) {
        // network issue: do nothing; leave local state as-is
        console.warn('status fetch failed', err);
      }
    }

    // start periodic polling
    function startPolling(){
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(fetchStatusAndUpdateUI, POLL_INTERVAL_MS);
    }
    function stopPolling(){ if (pollTimer) clearInterval(pollTimer); pollTimer = null; }

    // ---------- input handling ----------
    function handleKeyPress(k){
      if (k.id === 'back') { current = current.slice(0,-1); clearError(); refreshDots(); return; }
      if (k.id === 'blank') return;
      if (current.length >= 4) return;
      current += (k.textContent || '').trim();
      refreshDots();
    }

    keypad.addEventListener('click', ev=>{
      const k = ev.target;
      if (!k.classList.contains('key')) return;
      if (isLocked()) return;
      handleKeyPress(k);
    });
    document.addEventListener('keydown', ev=>{
      if (ev.key >= '0' && ev.key <= '9') { ev.preventDefault(); if (!isLocked()) handleKeyPress({ id:null, textContent: ev.key }); return; }
      if (ev.key === 'Backspace' || ev.key === 'Delete') { ev.preventDefault(); handleKeyPress({ id:'back' }); return; }
      if (ev.key === 'Enter') { ev.preventDefault(); if (!submitBtn.disabled) submitBtn.click(); }
    });

    // ---------- verify flow ----------
    submitBtn.addEventListener('click', async ()=>{
      clearError();
      if (isLocked()) { showError('Account is locked. Please wait until lock expires.'); return; }
      if (!current || current.length !== 4) { showError('Enter 4-digit PIN'); return; }

      const user = getStoredUser();
      const accountNumber = user ? (user.account_number || user.accountNumber || user.phone) : null;
      if (!accountNumber) { showError('You must be logged in.'); return; }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Verifying...';

      try {
        const payload = { account_number: String(accountNumber), pin: String(current) };
        const res = await fetch(VERIFY_ROUTE, { method: 'POST', credentials: 'include', headers: { 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
        const j = await res.json().catch(()=>null);

        if (res.ok && j && j.success) {
          // success — clear any UI lock state and proceed with transaction
          lockInfo.failedAttempts = 0;
          lockInfo.lockedUntil = null;
          startPostVerificationSuccess();
          return;
        }

        // server-enforced lock
        if (res.status === 403) {
          const lockedUntil = (j && j.lockedUntil) ? j.lockedUntil : null;
          lockInfo.failedAttempts = LOCK_THRESHOLD;
          lockInfo.lockedUntil = lockedUntil || new Date(Date.now() + 4 * 3600 * 1000).toISOString();
          disableKeypad();
          startCountdown(lockInfo.lockedUntil);
          showError((j && j.message) ? j.message : 'Too many failed attempts. Account locked.');
          return;
        }

        // invalid PIN -> fetch status to show remaining attempts
        if (res.status === 401 || (j && j.success === false)) {
          // fetch status to get updated failedAttempts count
          await fetchStatusAndUpdateUI();
          const left = Math.max(0, LOCK_THRESHOLD - lockInfo.failedAttempts);
          if (left > 0) showError(`Invalid PIN — ${left} attempt${left>1?'s':''} left before lock.`);
          else showError('Invalid PIN.');
          current = '';
          refreshDots();
          return;
        }

        // other server error
        showError((j && j.message) ? j.message : `Verification failed (HTTP ${res.status})`);
      } catch (err) {
        console.error('verify error', err);
        showError('Network error while verifying PIN');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Verify & Pay';
      }
    });

    // call after successful verification to continue flow
    function startPostVerificationSuccess(){
      clearError();
      setStatusHint('');
      // proceed with original behavior: go back to caller page so transaction execution continues
      // keep existing logic: redirect to referrer or airtime page
      const returnUrl = sessionStorage.getItem('return_to') || document.referrer || 'airtime.html';
      // small delay to show success state
      setTimeout(()=> { window.location.href = returnUrl; }, 250);
    }

    cancelBtn.addEventListener('click', ()=> {
      if (pending && pending.product === 'towallet') window.location.href = 'towallet.html';
      else window.location.href = 'airtime.html';
    });

    // ---------- init ----------
    (function init(){
      // load pending tx if any (keeps original behavior)
      try { pending = sessionStorage.getItem('pending_tx') ? JSON.parse(sessionStorage.getItem('pending_tx')) : null; } catch(e){ pending = null; }

      // show transaction details as before (unchanged)
      if (!pending) {
        const params = new URLSearchParams(window.location.search);
        const debugList = [];
        if (!params.get('phone') && !params.get('recipient')) debugList.push('phone/recipient');
        if (!params.get('network')) debugList.push('network');
        if (!params.get('amount')) debugList.push('amount');
        if (!params.get('receiver_acc') && !sessionStorage.getItem('pending_tx')) debugList.push('receiver_acc (for towallet)');
        if (debugList.length) {
          message.textContent = 'Missing fields: ' + debugList.join(', ') + '. Please return and retry.';
        } else {
          message.textContent = 'No pending transaction found. Go back and try again.';
        }
        submitBtn.disabled = true;
      } else {
        if (pending.product === 'towallet' || pending.receiver_acc) {
          const recv = pending.receiver_acc || pending.recipient || pending.phone || '-';
          const bank = pending.receiver_bank_name || pending.receiver_bank || pending.bankName || '';
          message.textContent = `Confirm ₦${Number(pending.amount || 0).toLocaleString()} to ${recv}${bank ? ' ('+bank+')' : ''}`;
        } else {
          const recipient = pending.recipient || pending.phone || '-';
          const network = pending.network || '-';
          message.textContent = `Confirm ₦${Number(pending.amount || 0).toLocaleString()} to ${recipient} (${network})`;
        }
        refreshDots();
      }

      // immediately fetch server status (authoritative) and start polling to stay synced across browsers
      fetchStatusAndUpdateUI();
      startPolling();

      // focus first key for keyboard users
      const firstKey = keypad.querySelector('.key');
      try { firstKey && firstKey.focus(); } catch(e){}
    })();

    // expose for debug (optional)
    window._payme_pin_debug = { fetchStatusAndUpdateUI };

  })();
</script>
</body>
</html>