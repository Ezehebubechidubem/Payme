<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PayGo App</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ---------- BASIC LAYOUT ---------- */
    :root {
      --primary: #5b4dff;
      --accent: #007bff;
      --bg: #f3f6fa;
      --card: #ffffff;
      --muted: #6b7280;
      --success: #0b6b3a;
    }
    * { box-sizing: border-box; }
    body { font-family: Inter, Arial, sans-serif; margin:0; background:var(--bg); color:#222; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; 
      .hidden {
  display: none !important;
}
    }
    header {
      display:flex; justify-content:space-between; align-items:center;
      background:var(--accent); color:#fff; padding:14px 16px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
      position:relative;
    }
    header .logo { font-weight:800; font-size:18px; letter-spacing:0.6px; }
    header .hamburger { font-size:20px; cursor:pointer; }

    /* PROFILE MENU */
    #profileMenu {
      position:absolute; right:12px; top:56px;
      background:var(--card); border-radius:10px; display:none;
      box-shadow:0 10px 30px rgba(0,0,0,0.12); z-index:200;
      width:200px;
    }
    #profileMenu div { padding:10px 14px; cursor:pointer; border-bottom:1px solid #f1f4f8; color:#333; }
    #profileMenu div:last-child { border-bottom:none; }
    #profileMenu div:hover { background:#f7f8ff; }

    /* WRAP & CARDS */
    .wrap { max-width:520px; margin:18px auto; padding:12px; }
    .card { background:var(--card); border-radius:12px; padding:14px; box-shadow:0 6px 20px rgba(0,0,0,0.06); margin-bottom:12px; }
    h2,h3 { margin:6px 0; font-weight:600; }
    input, button, textarea, select {
      width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid #e6eefc; font-size:14px;
      background: #fff;
    }
    button { background:var(--primary); color:#fff; border:none; cursor:pointer; padding:10px 12px; font-weight:600; }
    .muted { color:var(--muted); font-size:13px; }

    /* TOP ROW */
    .top-row { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .greeting { font-size:16px; font-weight:700; color:#213547; }
    .accountNo { font-size:13px; color:#495057; margin-top:2px; }

    /* TRANSACTIONS (above balance) */
    .tx-header { display:flex; justify-content:space-between; align-items:center; gap:8px; }

      #transactionList {
  max-height: 400px;   /* Fixes the visible height */
  overflow-y: auto;    /* Enables vertical scrollbar */
  border: 1px solid #eef2ff;
  padding: 6px;
  border-radius: 8px;
  background: #fff;
}
    }
    #transactionList.expanded { max-height:900px; } /* toggled state */
    .tx { padding:10px; border-bottom:1px solid #f1f4ff; font-size:14px; color:#1f2937; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .tx .tx-left { display:flex; flex-direction:column; }
    .tx .tx-amt { font-weight:700; color:var(--accent); }
    .tx .tx-type { font-size:13px; color:#6b7280; margin-top:4px; }
    .tx:last-child { border-bottom:none; }

    /* Balance area */
    .balance-wrap { display:flex; flex-direction:column; align-items:flex-start; gap:8px; margin-top:12px; }
    .balance { font-size:28px; color:var(--success); font-weight:800; }
    #btnAddMoney { width:160px; padding:8px 12px; border-radius:10px; }

    /* SERVICES ROW (3 primary) */
    .services-row { display:flex; gap:12px; margin-top:14px; }
    .service { flex:1; background:#fbfbff; border-radius:12px; padding:12px; text-align:center; cursor:pointer; box-shadow: inset 0 -6px 0 rgba(91,77,255,0.03); }
    .service i { font-size:20px; margin-bottom:8px; color:var(--accent); display:block; }
    .service small { display:block; font-size:12px; color:#233142; font-weight:600; }

    /* OTHER GRID */
    .grid { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:12px; }
    .grid-item { background:#fbfbff; border-radius:10px; padding:10px; text-align:center; cursor:pointer; font-size:13px; }
    .grid-item i { font-size:16px; color:var(--accent); margin-bottom:6px; display:block; }

    /* small control for transactions expansion (icon only) */
    .tx-control { background:transparent; border:none; cursor:pointer; font-size:16px; color:var(--accent); padding:6px; border-radius:8px; }
    .tx-control:focus { outline:none; box-shadow:0 2px 8px rgba(91,77,255,0.12); }

    /* TO BANK PAGE */
    .small-muted { font-size:13px; color:#6b7280; margin-top:4px; }

    /* Bottom nav */
    .bottom-nav {
      position:fixed; bottom:10px; left:50%; transform:translateX(-50%); background:#fff; width:520px; max-width:96%;
      border-radius:16px; display:flex; justify-content:space-around; padding:10px; box-shadow:0 10px 30px rgba(0,0,0,0.08); z-index:150;
    }
    .bottom-nav .nav-btn { text-align:center; flex:1; cursor:pointer; padding:6px 8px; }
    .bottom-nav i { font-size:18px; color:var(--accent); }
    .bottom-nav small { display:block; font-size:11px; color:#334155; margin-top:4px; }

    /* Responsive */
    @media (max-width:560px) {
      .wrap { padding:12px; }
      .bottom-nav { width:calc(100% - 24px); left:12px; transform:none; border-radius:12px; }
    }
  </style>
</head>
<body>

  <header>
    <div class="logo">PAYGO</div>
    <i id="hamburgerBtn" class="fas fa-bars hamburger" title="Menu"></i>
    <div id="profileMenu">
      <div id="menuProfile">Profile</div>
      <div id="menuKYC">KYC</div>
      <div id="menuTier">Tier</div>
      <div id="menuSettings">Settings</div>
      <div id="menuLogout">Logout</div>
    </div>
  </header>

  <div class="wrap">

    <!-- REGISTER -->
    <div id="registerCard" class="card">
      <h2>Create account</h2>
      <input id="regUsername" placeholder="Username (required)" />
      <input id="regName" placeholder="Full name (optional)" />
      <input id="regNumber" placeholder="Phone number (11 digits)" maxlength="11" type="number"/>
      <input id="regEmail" placeholder="Email (optional)" type="email" />
      <input id="regPassword" type="password" placeholder="Password" />
      <button id="btnRegister">Register</button>
      <p class="muted">Already have account? <a href="#" id="toLoginLink">Login</a></p>
    </div>

    <!-- LOGIN -->
    <div id="loginCard" class="card hidden">
      <h2>Login</h2>
      <input id="loginUsername" placeholder="Username or phone" />
      <input id="loginPassword" type="password" placeholder="Password" />
      <button id="btnLogin">Login</button>
      <p class="muted">Don't have account? <a href="#" id="toRegisterLink">Register</a></p>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboardCard" class="card hidden">
      <div class="top-row">
        <div>
          <div class="greeting" id="greeting">Hello 👋</div>
          <div class="accountNo" id="acctNumberDisplay"></div>
        </div>
      </div>

      <div class="balance-wrap">
        <h3 style="margin:8px 0 0 0">Available Balance</h3>
        <div class="balance" id="balanceDisplay">₦0.00</div>
        <button id="btnAddMoney">Add Money</button>
      </div>
      <div class="tx-header" style="margin-top:12px;">
        <h3 style="margin:0">Recent Transactions</h3>
        <!-- icon-only toggle to expand/collapse tx list (no text "See more") -->
        <button id="txExpandBtn" class="tx-control" title="Expand / Collapse transactions"><i class="fas fa-chevron-down"></i></button>
      </div>
      <div id="transactionList" class="card" style="padding:8px; margin-top:8px;"></div>


      <!-- Row of 3 primary services -->
      <div class="services-row" style="margin-top:16px;">
        <div class="service" id="toBankBtn"><i class="fas fa-university"></i><small>To Bank</small></div>
        <div class="service" id="toWalletBtn"><i class="fas fa-wallet"></i><small>Wallet</small></div>
        <div class="service" id="savingsBtn"><i class="fas fa-piggy-bank"></i><small>Savings</small></div>
      </div>

      <!-- Other services grid -->
      <div class="grid" style="margin-top:14px;">
        <div class="grid-item"><i class="fas fa-phone"></i><small>Airtime</small></div>
        <div class="grid-item"><i class="fas fa-wifi"></i><small>Data</small></div>
        <div class="grid-item"><i class="fas fa-tv"></i><small>TV</small></div>
        <div class="grid-item"><i class="fas fa-bolt"></i><small>Electricity</small></div>
        <div class="grid-item"><i class="fas fa-futbol"></i><small>Betting</small></div>
        <div class="grid-item"><i class="fas fa-gift"></i><small>Gift Card</small></div>
        <div class="grid-item"><i class="fas fa-store"></i><small>Business</small></div>
        <div class="grid-item"><i class="fas fa-cog"></i><small>More</small></div>
      </div>
    </div>

    <!-- TO BANK PAGE (separate view) -->
    <div id="toBankPage" class="card hidden">
      <h2>Send to Bank</h2>
      <input id="recipientAccount" placeholder="Recipient account number" />
      <div class="muted" id="recipientPreview">Enter account number to preview</div>
      <input id="sendAmount" type="number" placeholder="Amount" />
      <button id="btnSend">Send</button>
      <button id="btnCancelSend" style="background:#aaa;margin-top:8px;">Back</button>
      <p class="small-muted">Note: you will be asked to confirm before the transfer is processed.</p>
    </div>
  </div>

  <!-- Bottom Navigation (fixed) -->
  <div class="bottom-nav" role="navigation" aria-label="Bottom navigation">
    <div class="nav-btn" id="navHome"><i class="fas fa-home"></i><small>Home</small></div>
    <div class="nav-btn" id="navLoan"><i class="fas fa-hand-holding-usd"></i><small>Loan</small></div>
    <div class="nav-btn" id="navRefer"><i class="fas fa-users"></i><small>Refer</small></div>
  </div>

  <!-- external JS -->
  <script>/* paygo.js
   Frontend logic for PayGo — separate file.
   Matches backend endpoints (register/login/get_user/user/send/add-money/refresh)
*/

//////////////////////////
// CONFIG — change if needed
//////////////////////////
const API_BASE = "https://payme-update.onrender.com"; // ← update if your Flask runs elsewhere
const API_REGISTER   = `${API_BASE}/register`;   // alias to /signup
const API_LOGIN      = `${API_BASE}/login`;
const API_GET_USER   = `${API_BASE}/get_user`;   // GET /get_user/:accountNumber
const API_USER_BY_ID = id => `${API_BASE}/user/${id}`; // GET user+transactions
const API_SEND       = `${API_BASE}/send`;       // POST compatibility
const API_ADD_MONEY  = `${API_BASE}/add-money`;  // alias to update-balance
const API_REFRESH    = `${API_BASE}/refresh`;

//////////////////////////
// DOM helpers
//////////////////////////
const $ = id => document.getElementById(id);
const exists = id => !!$(id);

function fmtNGN(n){
  try {
    return new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN', minimumFractionDigits: 2 }).format(Number(n || 0));
  } catch(e) {
    return `₦${Number(n || 0).toFixed(2)}`;
  }
}

//////////////////////////
// Session helpers
//////////////////////////
function setUserId(id){ localStorage.setItem("user_id", String(id)); }
function getUserId(){ return localStorage.getItem("user_id"); }
function clearSession(){ localStorage.removeItem("user_id"); }

//////////////////////////
// View switching
//////////////////////////
function showCard(cardId){
  // hide known cards
  ["registerCard","loginCard","dashboardCard","toBankPage"].forEach(id => {
    const el = $(id);
    if(el) el.classList.add("hidden");
  });
  const tgt = $(cardId);
  if(tgt) tgt.classList.remove("hidden");

  // hamburger only visible on dashboard
  const ham = $("hamburgerBtn");
  if(ham) ham.style.display = (cardId === "dashboardCard") ? "inline-block" : "none";

  // close profile menu
  const menu = $("profileMenu");
  if(menu) menu.style.display = "none";
}

//////////////////////////
// AUTH: register & login
//////////////////////////
async function doRegister(){
  const username = $("regUsername").value.trim();
  const name     = $("regName").value.trim();
  const number   = $("regNumber").value.trim();
  const email    = $("regEmail").value.trim();
  const password = $("regPassword").value;

  const phone = (number || "").replace(/\D/g, "");
  if(!username || !phone || !password){
    alert("Please fill username, phone and password.");
    return;
  }
  if(phone.length < 10){
    alert("Phone must be at least 10 digits.");
    return;
  }

  try {
    const res = await fetch(API_REGISTER, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ username, name, email, number: phone, password })
    });
    const data = await res.json();
    if(res.ok && data.success){
      alert(data.message || "Registered. Please login.");
      showCard("loginCard");
    } else {
      alert(data.message || (data.error || "Registration failed"));
    }
  } catch(err){
    console.error("register error", err);
    alert("Network error during registration.");
  }
}

async function doLogin(){
  const loginVal = $("loginUsername").value.trim();
  const password = $("loginPassword").value;
  if(!loginVal || !password){ alert("Enter username/phone and password."); return; }

  try {
    const res = await fetch(API_LOGIN, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ username: loginVal, number: loginVal, password })
    });
    const data = await res.json();
    if(res.ok && data.success){
      const user = data.user;
      if(!user || !user.id){ alert("Login succeeded but user data missing."); return; }
      setUserId(user.id);
      await loadDashboard();
      showCard("dashboardCard");
    } else {
      alert(data.message || "Invalid credentials.");
    }
  } catch(err){
    console.error("login err", err);
    alert("Network error during login.");
  }
}

//////////////////////////
// DASHBOARD: load user & txs
//////////////////////////
async function loadDashboard(){
  const uid = getUserId();
  if(!uid) return;

  try {
    const res = await fetch(API_USER_BY_ID(uid));
    const json = await res.json();
    if(!res.ok || !json.success) throw new Error(json.message || "Failed to load user");

    const user = json.user;
    if(exists("greeting")) $("greeting").textContent = `Hello 👋 ${user.username || ""}`;
    if(exists("acctNumberDisplay")){
      const acc10 = (user.account_number || "").slice(-12); // show relevant tail
      $("acctNumberDisplay").textContent = `ACC: ${acc10}`;
    }
    if(exists("balanceDisplay")) $("balanceDisplay").textContent = fmtNGN(user.balance);

    // render first-5 transactions and wire expand control
    renderTransactionsLimited(json.transactions || []);
  } catch(err){
    console.error("loadDashboard", err);
    // don't interrupt UI drastically
    alert("Failed to load dashboard.");
  }
}

function renderTransactionsLimited(txs){
  const container = $("transactionList");
  if(!container) return;
  container.innerHTML = "";

  if(!txs || txs.length === 0){
    const no = document.createElement("div");
    no.className = "tx muted";
    no.textContent = "No transactions yet.";
    container.appendChild(no);
    return;
  }

  const limit = 3;
  const truncated = txs.slice(0, limit);

  truncated.forEach(t => {
    const row = document.createElement("div");
    row.className = "tx";
    const left = document.createElement("div");
    left.className = "tx-left";
    const amt = document.createElement("div");
    amt.className = "tx-amt";
    amt.textContent = fmtNGN(t.amount);
    const typ = document.createElement("div");
    typ.className = "tx-type";
    typ.textContent = `${t.type} • ${t.date || ""}`;
    left.appendChild(amt);
    left.appendChild(typ);

    const right = document.createElement("div");
    right.style.fontSize = "13px";
    right.style.color = "#475569";
    right.textContent = t.details || t.receiver || "";

    row.appendChild(left);
    row.appendChild(right);
    container.appendChild(row);
  });

  // store full set on container for expand toggling
  container._allTx = txs;

  // ensure correct collapsed state (initial)
  container.classList.remove("expanded");
  const expandBtn = $("txExpandBtn");
  if(expandBtn){
    expandBtn.querySelector("i").className = "fas fa-chevron-down";
  }
}

//////////////////////////
// Transactions expand/collapse (icon only)
//////////////////////////
function toggleExpandTx(){
  const container = $("transactionList");
  if(!container) return;
  const isExpanded = container.classList.toggle("expanded");
  const btn = $("txExpandBtn");
  if(btn) {
    const icon = btn.querySelector("i");
    if(isExpanded){
      icon.className = "fas fa-chevron-up";
      // render full list
      container.innerHTML = "";
      const all = container._allTx || [];
      all.forEach(t => {
        const row = document.createElement("div");
        row.className = "tx";
        const left = document.createElement("div");
        left.className = "tx-left";
        const amt = document.createElement("div");
        amt.className = "tx-amt";
        amt.textContent = fmtNGN(t.amount);
        const typ = document.createElement("div");
        typ.className = "tx-type";
        typ.textContent = `${t.type} • ${t.date || ""}`;
        left.appendChild(amt);
        left.appendChild(typ);

        const right = document.createElement("div");
        right.style.fontSize = "13px";
        right.style.color = "#475569";
        right.textContent = t.details || t.receiver || "";
        row.appendChild(left);
        row.appendChild(right);
        container.appendChild(row);
      });
      // scroll to bottom so user can scroll older tx easily
      setTimeout(()=> { container.scrollTop = container.scrollHeight; }, 80);
    } else {
      // collapse back to first 5
      icon.className = "fas fa-chevron-down";
      renderTransactionsLimited(container._allTx || []);
      setTimeout(()=> { container.scrollTop = 0; }, 80);
    }
  }
}

//////////////////////////
// To-Bank & preview & send
//////////////////////////
async function previewRecipient(){
  if(!exists("recipientAccount") || !exists("recipientPreview")) return;
  const acctRaw = $("recipientAccount").value.trim();
  const acct = acctRaw.replace(/\s+/g, '');
  if(!acct || acct.length < 4){ // being forgiving — backend accepts last-10
    $("recipientPreview").textContent = "Enter account number to preview";
    return;
  }

  try {
    // GET /get_user/<acct>
    const res = await fetch(`${API_GET_USER}/${encodeURIComponent(acct)}`);
    const json = await res.json();
    if(res.ok && json.success){
      $("recipientPreview").textContent = `Receiver: ${json.username} (ID: ${json.userId})`;
    } else {
      $("recipientPreview").textContent = "❌ Account not found";
    }
  } catch(err){
    console.error("previewRecipient", err);
    $("recipientPreview").textContent = "❌ Error checking account";
  }
}

async function sendMoney(){
  if(!getUserId()){
    alert("Please login first.");
    return;
  }
  const acct = $("recipientAccount").value.trim();
  const amt = parseFloat($("sendAmount").value);
  if(!acct || acct.length < 4){
    alert("Enter a valid account number.");
    return;
  }
  if(!amt || amt <= 0){
    alert("Enter a valid amount.");
    return;
  }

  const ok = confirm(`Send ${fmtNGN(amt)} to ${acct}?`);
  if(!ok) return;

  try {
    const res = await fetch(API_SEND, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ sender_id: getUserId(), receiver_account: acct, amount: amt })
    });
    const json = await res.json();
    if(res.ok && json.success){
      alert(json.message || "Sent successfully");
  if(exists("recipientAccount")) $("recipientAccount").value = "";
      if(exists("sendAmount")) $("sendAmount").value = "";
      if(exists("recipientPreview")) $("recipientPreview").textContent = "Enter account number to preview";
      await loadDashboard(); // refresh balance and transactions
      showCard("dashboardCard"); // back to dashboard
    } else {
      alert(json.message || "Send failed");
    }
  } catch(err){
    console.error("sendMoney error", err);
    alert("Network error during sending money.");
  }
}

//////////////////////////
// Add Money
//////////////////////////
async function addMoney(){
  const amt = parseFloat(prompt("Enter amount to add to wallet:", "0"));
  if(!amt || amt <= 0){ alert("Enter a valid amount."); return; }
  try {
    const res = await fetch(API_ADD_MONEY, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ user_id: getUserId(), amount: amt })
    });
    const json = await res.json();
    if(res.ok && json.success){
      alert(json.message || `Added ${fmtNGN(amt)} successfully`);
      await loadDashboard();
    } else {
      alert(json.message || "Failed to add money");
    }
  } catch(err){
    console.error("addMoney error", err);
    alert("Network error adding money.");
  }
}

//////////////////////////
// Hamburger & Profile Menu
//////////////////////////
function toggleProfileMenu(){
  const menu = $("profileMenu");
  if(menu) menu.style.display = (menu.style.display === "block") ? "none" : "block";
}

function handleProfileMenuClick(e){
  const id = e.target.id;
  if(id === "menuLogout"){
    clearSession();
    showCard("loginCard");
  } else if(id === "menuProfile"){
    alert("Profile clicked!");
  } else if(id === "menuKYC"){
    alert("KYC clicked!");
  } else if(id === "menuTier"){
    alert("Tier clicked!");
  } else if(id === "menuSettings"){
    alert("Settings clicked!");
  }
  $("profileMenu").style.display = "none";
}

//////////////////////////
// Navigation
//////////////////////////
function initNavigation(){
  if(exists("toBankBtn")) $("toBankBtn").addEventListener("click", ()=> showCard("toBankPage"));
  if(exists("btnCancelSend")) $("btnCancelSend").addEventListener("click", ()=> showCard("dashboardCard"));
  if(exists("btnSend")) $("btnSend").addEventListener("click", sendMoney);
  if(exists("btnAddMoney")) $("btnAddMoney").addEventListener("click", addMoney);

  if(exists("hamburgerBtn")) $("hamburgerBtn").addEventListener("click", toggleProfileMenu);
  if(exists("profileMenu")) $("profileMenu").addEventListener("click", handleProfileMenuClick);

  if(exists("txExpandBtn")) $("txExpandBtn").addEventListener("click", toggleExpandTx);
  if(exists("recipientAccount")) $("recipientAccount").addEventListener("input", previewRecipient);

  // Login/Register links
  if(exists("toLoginLink")) $("toLoginLink").addEventListener("click", ()=> showCard("loginCard"));
  if(exists("toRegisterLink")) $("toRegisterLink").addEventListener("click", ()=> showCard("registerCard"));
  if(exists("btnRegister")) $("btnRegister").addEventListener("click", doRegister);
  if(exists("btnLogin")) $("btnLogin").addEventListener("click", doLogin);
}

//////////////////////////
// On load
//////////////////////////
document.addEventListener("DOMContentLoaded", ()=>{
  const uid = getUserId();
  if(uid){
    loadDashboard();
    showCard("dashboardCard");
  } else {
    showCard("registerCard");
  }
  initNavigation();
});