<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Login</title>
<style>
:root{ --primary:#00c853; --primary-dark:#009624; --bg:#f4f6f8; --card:#fff; }
body { font-family: Arial, sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
.form-container { background: var(--card); padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 320px; }
h2 { text-align: center; margin-bottom: 20px; color: #333; }
label { font-size: 14px; font-weight: bold; color: #444; display: block; margin-bottom: 6px; }
input { width: 100%; padding: 10px; margin-bottom: 16px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(0,200,83,0.08); }
button { width: 100%; background: var(--primary); border: none; color: #fff; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; }
button[disabled] { opacity: 0.65; cursor: not-allowed; }
button:hover { background: var(--primary-dark); }
.switch { text-align: center; margin-top: 12px; font-size: 14px; }
.switch a { color: var(--primary); text-decoration: none; font-weight: bold; }
.modal-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.45); z-index: 9999; }
.modal-overlay.show { display: flex; }
.modal { width: calc(100% - 48px); max-width: 460px; background: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 18px 40px rgba(10,20,30,0.15); text-align: center; }
.modal .badge { width: 68px; height: 68px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 32px; margin-bottom: 12px; color: #fff; }
.modal .badge.success { background: linear-gradient(135deg,#00c853,#43a047); }
.modal .badge.error { background: linear-gradient(135deg,#f44336,#e53935); }
.modal h3 { margin: 6px 0 6px; font-size: 18px; }
.modal p { margin: 0 0 12px; color: #555; }
.modal .actions { display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap; }
.modal .actions .btn { padding: 10px 14px; border-radius:8px; cursor:pointer; border:0; font-weight:700; min-width:120px; }
.modal .btn-outline { background:#fff; border:1px solid #ddd; color:#333; }
.modal .btn-primary { background:var(--primary); color:#fff; border:0; }
.spinner { display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,0.3); border-top-color:#fff; border-radius:50%; animation: spin .8s linear infinite; vertical-align: middle; margin-left:8px; }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div class="form-container" role="main">
  <h2>Login</h2>
  <form id="loginForm" autocomplete="on" novalidate>
    <label for="login">Username or Phone</label>
    <input type="text" id="login" name="login" placeholder="Enter username, email, or phone" required autocomplete="username">
    <label for="password">Password</label>
    <input type="password" id="password" name="password" placeholder="Enter password" required autocomplete="current-password">
    <button type="submit" id="submitBtn">Login</button>
  </form>
  <div class="switch">
    Don’t have an account? <a href="paymeregister.html">Register</a>
  </div>
</div>

<!-- Modals omitted (same as yours) -->
<div id="successModal" class="modal-overlay" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal" role="document"><div class="badge success">✓</div><h3 id="successHeading">Login successful</h3><p id="successText">You are now logged in.</p><div id="successActions" class="actions"></div></div>
</div>
<div id="errorModal" class="modal-overlay" aria-hidden="true" role="alertdialog" aria-modal="true">
  <div class="modal" role="document"><div class="badge error">✕</div><h3 id="errorHeading">Error</h3><p id="errorText">An error occurred</p><div class="actions"><button id="errorOk" class="btn btn-primary">OK</button></div></div>
</div>

<script>
(function(){
  const API = "https://payme-update.onrender.com/login"; // backend login
  const form = document.getElementById('loginForm');
  const loginInput = document.getElementById('login');
  const pwdInput = document.getElementById('password');
  const submitBtn = document.getElementById('submitBtn');
  const successModal = document.getElementById('successModal');
  const successActions = document.getElementById('successActions');
  const errorModal = document.getElementById('errorModal');
  const errorText = document.getElementById('errorText');

  function showModal(modal){ modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); }
  function hideModal(modal){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }
  function showSuccess(message,onOk){
    document.getElementById('successText').textContent = message || 'Login successful';
    successActions.innerHTML = '';
    const btn = document.createElement('button');
    btn.className = 'btn btn-primary';
    btn.textContent = 'Continue';
    btn.onclick = ()=>{ hideModal(successModal); if(onOk) onOk(); };
    successActions.appendChild(btn);
    showModal(successModal);
  }
  function showError(msg){ errorText.textContent = msg||'An error occurred'; showModal(errorModal); document.getElementById('errorOk').onclick = ()=>hideModal(errorModal); }
  function setLoading(is){ if(is){ submitBtn.disabled=true; submitBtn.innerHTML='Logging in <span class="spinner"></span>'; } else { submitBtn.disabled=false; submitBtn.innerHTML='Login'; } }

  form.addEventListener('submit', async function(e){
    e.preventDefault();
    const login = loginInput.value.trim();
    const password = pwdInput.value;
    if(!login||!password){ showError('Enter login and password'); return; }
    const payload = { login, password };
    if(login.includes('@')) payload.email = login;

    setLoading(true);
    try {
      const res = await fetch(API, {
        method: "POST",
        credentials: "include", // important to set session cookie
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>null);

      if(res.ok && data && data.status === "success"){
        // store user data
        try { localStorage.setItem("user", JSON.stringify(data.user || {})); } catch(e){}
        // if backend provided a redirect URL (full GitHub URL) follow it
        if(data.redirect){
          // ALSO store normalized role in sessionStorage for per-page checks
          const userRole = (data.user && data.user.role) ? (data.user.role || '').toString().toLowerCase() : null;
          if(userRole) try { sessionStorage.setItem("staff_role", userRole); } catch(e){}
          window.location.href = data.redirect;
          return;
        }

        // fallback: old behavior (map role to Admin pages)
        const topRole = (data.role || (data.user && data.user.role) || '').toString().toLowerCase();
        const userRole = (data.user && data.user.role) ? data.user.role.toString().toLowerCase() : topRole;
        if(topRole === "staff" || userRole){
          // save staff role
          try { sessionStorage.setItem("staff_role", userRole); } catch(e){}
          // Map to GH URLs (fallback)
          const BASE = "https://ezehebubechidubem.github.io/Payme";
          const map = {
            "notification": `${BASE}/Admin/notifications.html`,
            "kyc": `${BASE}/Admin/kyc.html`,
            "fraud": `${BASE}/Admin/fraud.html`,
            "developer": `${BASE}/Admin/developer.html`,
            "scaling": `${BASE}/Admin/scaling.html`,
            "transaction-review": `${BASE}/Admin/review.html`,
            "log": `${BASE}/Admin/log.html`
          };
          const goto = map[userRole] || map[topRole] || `${BASE}/Admin/staff.html`;
          window.location.href = goto;
          return;
        }

        if((data.role || '').toString().toLowerCase() === "admin"){
          showSuccess("Admin login successful", ()=>window.location.href="Admin/index.html");
          return;
        }

        if((data.role || '').toString().toLowerCase() === "user"){
          showSuccess("Login successful", ()=>window.location.href="Loginauthentication.html");
          return;
        }

        showError("Role not recognized. Contact admin.");
        return;
      }

      // error path
      const msg = (await res.json().catch(()=>null))?.message || "Login failed";
      showError(msg);
    } catch(err){
      console.error(err);
      showError("Network or server error. Try again.");
    } finally {
      setLoading(false);
    }
  });

  window.addEventListener('load', ()=>loginInput.focus());
})();
</script>
</body>
</html>