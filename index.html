from flask import Flask, request, jsonify
from flask_cors import CORS
from threading import Lock
import json
import os
from datetime import datetime

app = Flask(__name__)
CORS(app)

DATA_FILE = 'payme_data.json'
lock = Lock()  # To handle simultaneous requests safely

# --- Load/Save Data ---
if os.path.exists(DATA_FILE):
    with open(DATA_FILE, 'r') as f:
        data = json.load(f)
else:
    data = {'users': {}, 'transactions': []}  # userId: {username, phone, password, balance, account_number}

def save_data():
    with open(DATA_FILE, 'w') as f:
        json.dump(data, f, indent=4)

# --- Helpers ---
def get_user_by_phone(phone):
    for uid, u in data['users'].items():
        if u['phone'] == phone:
            return uid, u
    return None, None

def get_user_by_account(account_number):
    for uid, u in data['users'].items():
        if u['account_number'] == account_number:
            return uid, u
    return None, None

def add_transaction(user_id, tx_type, amount, receiver_id=None):
    tx = {
        'user_id': user_id,
        'type': tx_type,
        'amount': amount,
        'date': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        'receiver_id': receiver_id
    }
    data['transactions'].append(tx)
    save_data()

# --- REGISTER ---
@app.route('/register', methods=['POST'])
def register():
    body = request.json
    username = body.get('username')
    phone = body.get('phone')
    password = body.get('password')

    with lock:
        uid, _ = get_user_by_phone(phone)
        if uid:
            return jsonify({'message': 'Phone already registered'}), 400
        user_id = str(len(data['users']) + 1)
        account_number = phone[-10:]  # last 10 digits as account number
        data['users'][user_id] = {
            'username': username,
            'phone': phone,
            'password': password,
            'balance': 0.0,
            'account_number': account_number
        }
        save_data()
    return jsonify({'message': 'Registration successful'}), 200

# --- LOGIN ---
@app.route('/login', methods=['POST'])
def login():
    body = request.json
    phone = body.get('phone')
    password = body.get('password')
    uid, user = get_user_by_phone(phone)
    if not user or user['password'] != password:
        return jsonify({'message': 'Invalid credentials'}), 400
    return jsonify({'message':'Login successful', 'user': {**user, 'id': uid}}), 200

# --- FETCH TRANSACTIONS ---
@app.route('/transactions', methods=['POST'])
def transactions():
    body = request.json
    user_id = body.get('userId')
    user_tx = [tx for tx in data['transactions'] if tx['user_id'] == user_id or tx.get('receiver_id') == user_id]
    # Format transactions
    formatted_tx = []
    for tx in user_tx:
        tx_type = tx['type']
        if tx_type == 'send' and tx['user_id'] == user_id:
            tx_type = 'Sent'
        elif tx_type == 'send' and tx.get('receiver_id') == user_id:
            tx_type = 'Received'
        formatted_tx.append({
            'type': tx_type,
            'amount': tx['amount'],
            'date': tx['date']
        })
    return jsonify(formatted_tx), 200

# --- USER BY ACCOUNT NUMBER ---
@app.route('/user-by-account', methods=['POST'])
def user_by_account():
    body = request.json
    account_number = body.get('accountNumber')
    uid, user = get_user_by_account(account_number)
    if not user:
        return jsonify({}), 404
    return jsonify({'username': user['username'], 'userId': uid}), 200

# --- ADD MONEY / UPDATE BALANCE ---
@app.route('/update-balance', methods=['POST'])
def update_balance():
    body = request.json
    user_id = body.get('userId')
    amount = float(body.get('amount', 0))
    if amount <= 0:
        return jsonify({'message':'Invalid amount'}), 400
    with lock:
        if user_id not in data['users']:
            return jsonify({'message':'User not found'}), 404
        data['users'][user_id]['balance'] += amount
        save_data()
        add_transaction(user_id, 'Deposit', amount)
    return jsonify({'message':'Balance updated', 'balance': data['users'][user_id]['balance']}), 200

# --- SEND MONEY ---
@app.route('/send', methods=['POST'])
def send_money():
    body = request.json
    user_id = body.get('userId')
    receiver_id = body.get('receiverId')
    amount = float(body.get('amount',0))
    if amount <= 0:
        return jsonify({'message':'Invalid amount'}), 400
    with lock:
        if user_id not in data['users'] or receiver_id not in data['users']:
            return jsonify({'message':'User not found'}), 404
        sender = data['users'][user_id]
        receiver = data['users'][receiver_id]
        if sender['balance'] < amount:
            return jsonify({'message':'Insufficient balance'}), 400
        sender['balance'] -= amount
        receiver['balance'] += amount
        save_data()
        add_transaction(user_id, 'send', amount, receiver_id)
        add_transaction(receiver_id, 'Received', amount, user_id)
    return jsonify({'message':'Money sent', 'balance': sender['balance']}), 200

# --- RUN APP ---
if __name__ == '__main__':
    app.run(debug=True)