<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PayMe App</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* --- GENERAL --- */
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background-color: #f7f7f7;
}
.hidden { display: none; }
button { cursor: pointer; }

/* --- FORMS --- */
form {
    max-width: 400px;
    margin: 50px auto;
    padding: 20px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
form h2 { text-align:center; margin-bottom:20px; }
form input { width:100%; padding:10px; margin:10px 0; border-radius:6px; border:1px solid #ccc; }
form button { width:100%; padding:10px; background:#5b4dff; color:white; border:none; border-radius:6px; font-size:16px; }
form small { display:block; text-align:center; margin-top:10px; color:gray; cursor:pointer; }

/* --- NAVBAR --- */
.navbar {
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:#222;
    padding:10px 20px;
}
.navbar .logo { color:#fff; font-size:20px; font-weight:bold; }

/* --- CARDS / DASHBOARD --- */
.balance-card, .history-card, .quick-actions, .services {
    margin:20px 15px;
    padding:20px;
    border-radius:12px;
    background:white;
}
.balance-card h1 { margin:10px 0; }
.quick-actions, .services { display:flex; justify-content:space-around; flex-wrap:wrap; gap:10px; }
.quick-actions div, .services div { text-align:center; font-size:14px; cursor:pointer; }
.quick-actions div i, .services div i { font-size:24px; color:purple; }

/* --- TRANSACTIONS --- */
#transactionList { list-style:none; padding:0; margin:0; max-height:250px; overflow-y:auto; }
#transactionList li { border-bottom:1px solid #eee; padding:10px 0; font-size:14px; }
#transactionList li.deposit { background:#e0ffe0; }
#transactionList li.withdraw { background:#ffe0e0; }
#transactionList li span.amount { font-weight:bold; }
#transactionList li span.type { font-style:italic; color:gray; }

/* --- PROFILE MENU / HAMBURGER --- */
#profileMenu { display:none; position:absolute; top:50px; right:10px; background:white; border-radius:8px; padding:10px; box-shadow:0 5px 15px rgba(0,0,0,0.2); z-index:100; }
#profileMenu div { padding:5px; cursor:pointer; }

/* --- PROFILE MODAL --- */
#profileModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; }
#profileModal .modal-content { background:white; padding:20px; border-radius:10px; width:90%; max-width:400px; }

/* --- BOTTOM BAR --- */
#bottomBar { position:fixed; bottom:0; left:0; width:100%; background:#fff; display:flex; justify-content:space-around; padding:10px 0; border-top:1px solid #ccc; z-index:200; }
#bottomBar div { text-align:center; font-size:12px; cursor:pointer; }
#bottomBar div i { font-size:20px; color:purple; }

/* --- SCROLLABLE DASHBOARD CONTENT --- */
#dashboardContent { overflow-y:auto; max-height:calc(100vh - 60px); padding-bottom:80px; }
</style>
</head>
<body>

<!-- REGISTER -->
<section id="registerSection">
<form id="registerForm">
<h2>Register</h2>
<input type="text" placeholder="Username" id="regUsername" required>
<input type="text" placeholder="Phone (11 digits)" id="regPhone" required>
<input type="password" placeholder="Password" id="regPassword" required>
<button type="submit">Register</button>
<small id="toLogin">Already have account? Login</small>
</form>
</section>

<!-- LOGIN -->
<section id="loginSection" class="hidden">
<form id="loginForm">
<h2>Login</h2>
<input type="text" placeholder="Phone (11 digits)" id="loginPhone" required>
<input type="password" placeholder="Password" id="loginPassword" required>
<button type="submit">Login</button>
<small id="toRegister">Don't have account? Register</small>
</form>
</section>

<!-- DASHBOARD -->
<section id="dashboardSection" class="hidden">
<nav class="navbar">
<div class="logo">PAYME</div>
<div>
<button id="hamburgerBtn">&#9776;</button>
</div>
</nav>

<div id="profileMenu">
<div id="profileMenuBtn">Profile</div>
<div id="logoutMenuBtn">Logout</div>
</div>

<div id="dashboardContent">
<div class="balance-card">
<h3>Available Balance</h3>
<h1 id="balanceDisplay">₦0.00</h1>
<button id="addMoneyBtn">Add Money</button>
</div>

<div class="history-card">
<h3>Transaction History</h3>
<ul id="transactionList"><li>No transactions yet</li></ul>
<button id="seeMoreBtn" style="display:none; margin-top:10px;">See More</button>
</div>

<div class="quick-actions">
<div id="toBankBtn"><i class="fas fa-university"></i><br>To Bank</div>
<div id="toWalletBtn"><i class="fas fa-wallet"></i><br>To Wallet</div>
<div id="atmBtn"><i class="fas fa-credit-card"></i><br>ATM Card</div>
</div>

<section class="services">
<div id="airtimeBtn"><i class="fas fa-phone"></i><br>Airtime</div>
<div id="dataBtn"><i class="fas fa-wifi"></i><br>Data</div>
<div id="electricBtn"><i class="fas fa-bolt"></i><br>Electricity</div>
<div id="bettingBtn"><i class="fas fa-futbol"></i><br>Betting</div>
    <section>
<div id="tvBtn"><i class="fas fa-tv"></i><br>TV</div>
<div id="loanBtn"><i class="fas fa-hand-holding-usd"></i><br>Loan</div>
<div id="businessBtn"><i class="fas fa-briefcase"></i><br>Business</div>
<div id="earnBtn"><i class="fas fa-users"></i><br>Refer & Earn</div>
    </section>
</section>

<div id="bottomBar">
<div id="homeBtn"><i class="fas fa-home"></i><br>Home</div>
<div id="loanBtn2"><i class="fas fa-hand-holding-usd"></i><br>Loan</div>
<div id="earnBtn2"><i class="fas fa-users"></i><br>Refer & Earn</div>
</div>

<div id="profileModal">
<div class="modal-content">
<h2>My Profile</h2>
<p><b>Username:</b> <span id="profileUsername"></span></p>
<p><b>Phone:</b> <span id="profilePhone"></span></p>
<p><b>Account No:</b> <span id="profileAccount"></span></p>
<p><b>Balance:</b> ₦<span id="profileBalance"></span></p>
<button id="closeProfile">Close</button>
</div>
</div>
</section>

<!-- TO BANK -->
<section id="toBankSection" class="hidden">
<form id="toBankForm">
<h2>Send Money</h2>
<input type="text" placeholder="Receiver Phone (11 digits)" id="receiverPhone" required>
<p id="receiverName" style="margin:5px 0;color:green;"></p>
<input type="number" placeholder="Amount" id="sendAmount" required>
<button type="submit">Send</button>
<small id="backDashboard" style="display:block; text-align:center; margin-top:10px; cursor:pointer;">Back to Dashboard</small>
</form>
</section>

<script>
let currentUser = null;
let allTransactions = [];
let lastTxLimit = 5;

// --- PERSIST LOGIN ---
if(localStorage.getItem('paymeUser')){
    currentUser = JSON.parse(localStorage.getItem('paymeUser'));
    loadDashboard();
    showSection('dashboardSection');
}

// Section navigation
function showSection(sec){
    document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
    document.getElementById(sec).classList.remove('hidden');
    if(sec!=='dashboardSection'){ document.getElementById('profileMenu').style.display='none'; document.getElementById('profileModal').style.display='none'; document.getElementById('bottomBar').style.display='none'; }
    else { document.getElementById('bottomBar').style.display='flex'; }
}

// --- Form switches ---
document.getElementById('toLogin').addEventListener('click', ()=>{ showSection('loginSection'); });
document.getElementById('toRegister').addEventListener('click', ()=>{ showSection('registerSection'); });
document.getElementById('backDashboard').addEventListener('click', ()=>{ showSection('dashboardSection'); });

// --- REGISTER ---
document.getElementById('registerForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const username = document.getElementById('regUsername').value;
    const phone = document.getElementById('regPhone').value;
    const password = document.getElementById('regPassword').value;

    try{
        const res = await fetch('https://payme-update.onrender.com/register',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({username, phone, password})
        });
        const data = await res.json();
        alert(data.message);
        if(res.ok) showSection('loginSection');
    }catch(err){ alert('Error registering user'); }
});

// --- LOGIN ---
document.getElementById('loginForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const phone = document.getElementById('loginPhone').value;
    const password = document.getElementById('loginPassword').value;

    try{
        const res = await fetch('https://payme-update.onrender.com/login',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({phone, password})
        });
        const data = await res.json();
        if(res.ok){
            currentUser = data.user;
            localStorage.setItem('paymeUser', JSON.stringify(currentUser)); // <-- SAVE USER
            loadDashboard();
            showSection('dashboardSection');
        } else { alert(data.message); }
    }catch(err){ alert('Error logging in'); }
});

// --- DASHBOARD ---
async function loadDashboard(){
    if(!currentUser) return;
    document.getElementById('balanceDisplay').innerText = `₦${currentUser.balance.toFixed(2)}`;
    document.getElementById('profileUsername').innerText = currentUser.username;
    document.getElementById('profilePhone').innerText = currentUser.phone;
    document.getElementById('profileAccount').innerText = currentUser.account_number;
    document.getElementById('profileBalance').innerText = currentUser.balance.toFixed(2);

    try{
        const res = await fetch('https://payme-update.onrender.com/transactions',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({userId: currentUser.id})
        });
        const tx = await res.json();
        allTransactions = tx.reverse();
        displayTransactions();
    }catch(err){ console.log('Error fetching transactions'); }
}

// Display limited transactions
function displayTransactions(limit=lastTxLimit){
    const list = document.getElementById('transactionList');
    list.innerHTML = '';
    if(allTransactions.length === 0){ list.innerHTML='<li>No transactions yet</li>'; return; }
    allTransactions.slice(0,limit).forEach(tx=>{
        const li = document.createElement('li');
        li.className = tx.type.toLowerCase();
        li.innerHTML = `<span class="type">${tx.type}</span> - <span class="amount">₦${tx.amount}</span> <br> <small>${tx.date}</small>`;
        list.appendChild(li);
    });
    document.getElementById('seeMoreBtn').style.display = (allTransactions.length>limit)?'block':'none';
}

// --- SEE MORE TRANSACTIONS ---
document.getElementById('seeMoreBtn').addEventListener('click', ()=>{
    displayTransactions(allTransactions.length);
});

// --- ADD MONEY ---
document.getElementById('addMoneyBtn').addEventListener('click', async ()=>{
    const amount = parseFloat(prompt("Enter amount to add:"));
    if(!amount || amount<=0) return alert('Invalid amount');
    try{
        const res = await fetch('https://payme-update.onrender.com/update-balance',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({userId: currentUser.id, amount})
        });
        const data = await res.json();
        if(res.ok){
            currentUser.balance = data.balance;
            localStorage.setItem('paymeUser', JSON.stringify(currentUser)); // <-- UPDATE USER
            loadDashboard();
            alert('Balance updated successfully');
        } else { alert(data.message); }
    }catch(err){ alert('Error updating balance'); }
});

// --- HAMBURGER MENU / PROFILE ---
document.getElementById('hamburgerBtn').addEventListener('click', ()=>{
    const menu = document.getElementById('profileMenu');
    menu.style.display = (menu.style.display==='block')?'none':'block';
});
document.getElementById('profileMenuBtn').addEventListener('click', ()=>{
    document.getElementById('profileModal').style.display = 'flex';
    document.getElementById('profileMenu').style.display = 'none';
});

// Close profile modal
document.getElementById('closeProfile').addEventListener('click', ()=>{
    document.getElementById('profileModal').style.display = 'none';
});

// Logout
document.getElementById('logoutMenuBtn').addEventListener('click', ()=>{
    if(confirm("Are you sure you want to logout?")){
        localStorage.removeItem('paymeUser');
        currentUser = null;
        showSection('loginSection');
    }
});

// --- TO BANK SECTION ---
document.getElementById('toBankBtn').addEventListener('click', ()=>{
    showSection('toBankSection');
});

document.getElementById('toBankForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const receiverPhone = document.getElementById('receiverPhone').value;
    const amount = parseFloat(document.getElementById('sendAmount').value);
    if(!receiverPhone || receiverPhone.length !== 11) return alert('Invalid receiver phone');
    if(!amount || amount <= 0) return alert('Invalid amount');

    try{
        const res = await fetch('https://payme-update.onrender.com/send-money',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({fromUserId: currentUser.id, toPhone: receiverPhone, amount})
        });
        const data = await res.json();
        if(res.ok){
            currentUser.balance = data.newBalance;
            localStorage.setItem('paymeUser', JSON.stringify(currentUser));
            loadDashboard();
            alert('Money sent successfully');
            showSection('dashboardSection');
        } else { alert(data.message); }
    }catch(err){ alert('Error sending money'); }
});

// --- END OF SCRIPT ---
</script>
</body>
</html>