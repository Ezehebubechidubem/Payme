<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Betting — PayMe</title>
  <style>
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --accent:#00c853;
  --accent-2:#00ad5a;
  --muted:#8b8f98;
  --radius:12px;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);-webkit-font-smoothing:antialiased}
.topbar{display:flex;align-items:center;gap:12px;padding:12px 14px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;position:sticky;top:0;z-index:20}
.topbar h1{font-size:18px;margin:0;font-weight:700}
.topbar .back{background:transparent;border:0;color:#fff;font-size:18px;padding:6px 8px;border-radius:8px}
.page{max-width:720px;margin:14px auto;padding:10px}
.card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 18px rgba(20,20,40,0.06)}
.muted{color:var(--muted);font-size:13px}
.field-label{font-weight:700;font-size:13px;margin-bottom:6px;display:block}
.selected-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
.selected-left{display:flex;align-items:center;gap:12px}
.site-title-large{font-weight:800;font-size:18px}
.selected-logo{width:64px;height:64px;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center}
.dropdown-controls{display:flex;align-items:center;gap:8px}
.dropdown-btn{border:0;background:#f2f7f2;padding:8px 10px;border-radius:8px;font-weight:800;cursor:pointer;color:var(--accent)}
.user-section{margin-top:12px}
#mainUserId{width:100%;padding:12px;border-radius:10px;border:1px solid #eee;font-size:16px}
.custom-amount-row{margin-top:10px;display:flex;flex-direction:column;gap:6px}
#customAmount{padding:12px;border-radius:10px;border:1px solid #eee;font-size:16px}
.amount-grid-main{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.amount-tile-main{flex:1 1 30%;min-width:28%;background:#fbfffb;border-radius:10px;padding:12px;text-align:center;border:1px solid #eef8ee;cursor:pointer;transition:transform .12s,box-shadow .12s}
.amount-tile-main .label{font-weight:800}
.amount-tile-main .sub{font-size:12px;color:var(--muted);margin-top:6px}
.amount-tile-main:hover{transform:translateY(-4px)}
.amount-tile-main.selected{box-shadow:0 10px 30px rgba(0,200,83,0.12);border-color:rgba(0,200,83,0.45);transform:translateY(-6px)}
.bottom-row{display:flex;align-items:center;justify-content:space-between;margin-top:14px}
.pay-left .small{font-size:12px;color:var(--muted)}
.pay-amount{font-weight:900;font-size:20px}
.btn{padding:12px 16px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff}
.use-btn{background:var(--accent);border:0;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
.links-card .link-card{display:block;padding:10px 12px;border-radius:10px;background:#fafafa;border:1px solid #f0eff8;color:var(--accent);text-decoration:none;margin-top:8px}
.small-note{font-size:12px;color:var(--muted);text-align:center;margin-top:6px}
.site-list-panel{position:fixed;inset:0;display:flex;flex-direction:column;background:rgba(0,0,0,0.28);z-index:60;backdrop-filter:blur(4px)}
.panel-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--card);border-radius:12px 12px 0 0}
.panel-title{font-weight:800}
.close-panel{background:transparent;border:0;font-size:20px;cursor:pointer}
.panel-search{padding:10px;background:var(--card);border-bottom:1px solid #f0f0f5}
.panel-search input{width:100%;padding:12px;border-radius:10px;border:1px solid #eee}
.panel-sites{list-style:none;margin:0;padding:12px;overflow:auto;flex:1;background:#fff;border-top-left-radius:12px;border-top-right-radius:12px}
.panel-sites .panel-site{display:flex;align-items:center;gap:14px;padding:12px;border-radius:10px;cursor:pointer;border-bottom:1px solid #f7f7fb}
.panel-site .site-icon{width:52px;height:52px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:14px;box-shadow:0 6px 18px rgba(10,10,20,0.06);position:relative;overflow:hidden}
.panel-site .site-icon img{width:100%;height:100%;object-fit:cover;display:block}
.logo-text{display:flex;flex-direction:column;align-items:center;justify-content:center;line-height:1;padding:4px}
.logo-text .l1{font-size:12px;font-weight:800}
.logo-text .l2{font-size:10px;font-weight:700;opacity:0.95;margin-top:2px}
.logo-badge{position:absolute;right:6px;top:6px;background:rgba(255,255,255,0.95);color:#111;font-size:9px;padding:2px 6px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.06)}
@media(min-width:720px){
  .page{padding:20px}
  .site-list-panel{left:20%;right:20%}
  .panel-sites{border-radius:12px}
}
.hidden{display:none}
</style>
</head>
<body>
  <header class="topbar">
    <button class="back" onclick="history.back()">←</button>
    <h1>Betting</h1>
  </header>

  <main class="page">
    <section class="card selected-card" id="selectedCard" aria-live="polite">
      <div class="selected-row">
        <div class="selected-left">
          <div id="selectedSiteLogo" class="site-icon selected-logo hidden" aria-hidden="true"></div>
          <div id="selectedSiteName" class="site-title-large">Select site</div>
        </div>

        <div class="dropdown-controls">
          <button class="dropdown-btn" id="openListBtn" title="Show all sites">▼</button>
        </div>
      </div>

      <div class="user-section">
        <label class="field-label">User ID</label>
        <input id="mainUserId" type="text" inputmode="numeric" maxlength="40" placeholder="Enter user ID (e.g. 8167542829)" />
        <div style="margin-top:8px">
          <button id="verifyBtn" class="btn">Verify Account</button>
          <span id="verifyResult" class="muted" style="margin-left:10px"></span>
        </div>
      </div>

      <div class="label" style="margin-top:12px;font-weight:700">Select Amount</div>

      <div class="custom-amount-row">
        <input id="customAmount" type="number" inputmode="numeric" placeholder="Or enter custom amount (min ₦100)" min="0" step="1" />
        <div class="muted small">Minimum top-up is ₦100</div>
      </div>

      <div class="amount-grid-main" id="amountGridMain" aria-live="polite"></div>

      <div class="bottom-row">
        <div class="pay-left">
          <div class="muted small">Amount (you will be charged this amount)</div>
          <div id="mainPayAmount" class="pay-amount">₦0</div>
        </div>
        <div style="flex:0">
          <button class="btn primary" id="mainPayBtn">Pay</button>
        </div>
      </div>
    </section>

    <section class="card links-card">
      <div class="muted">More Services</div>
      <a class="link-card" href="tel:*861*4#">Top up Betting with *861*4#</a>
    </section>

    <footer class="small-note muted">If network unavailable, use USSD top-up.</footer>
  </main>

  <div id="siteListPanel" class="site-list-panel hidden" role="dialog" aria-modal="true">
    <div class="panel-header">
      <div class="panel-title">Betting sites</div>
      <button class="close-panel" id="closeListBtn" aria-label="Close list">✕</button>
    </div>

    <div class="panel-search">
      <input id="panelSearch" type="search" placeholder="Search betting sites" aria-label="Search betting sites" />
    </div>

    <ul id="panelSites" class="panel-sites" role="list"></ul>
  </div>

  <script>
// ---- Fixed script: connects to backend (uses /api prefix) ----
const DEFAULT_BACKEND = "https://payme-update.onrender.com"; // change if your backend is hosted elsewhere
const BACKEND_URL = (window.BACKEND_URL || DEFAULT_BACKEND).replace(/\/+$/, "");
const SITES_ENDPOINT = `${BACKEND_URL}/api/betting-sites`;
const VERIFY_ENDPOINT = `${BACKEND_URL}/api/verify-betting`;
const FUND_ENDPOINT = `${BACKEND_URL}/api/fund-betting`;

// DOM
const openListBtn = document.getElementById("openListBtn");
const closeListBtn = document.getElementById("closeListBtn");
const siteListPanel = document.getElementById("siteListPanel");
const panelSites = document.getElementById("panelSites");
const panelSearch = document.getElementById("panelSearch");
const selectedSiteName = document.getElementById("selectedSiteName");
const selectedSiteLogo = document.getElementById("selectedSiteLogo");
const amountGridMain = document.getElementById("amountGridMain");
const mainUserId = document.getElementById("mainUserId");
const customAmount = document.getElementById("customAmount");
const mainPayAmount = document.getElementById("mainPayAmount");
const mainPayBtn = document.getElementById("mainPayBtn");
const verifyBtn = document.getElementById("verifyBtn");
const verifyResult = document.getElementById("verifyResult");

let BETTING_SITES = [];       // will be loaded from backend
let selectedSite = null;
let selectedTileValue = null;
let customValue = null;
const AMOUNT_OPTIONS = [100, 500, 1000, 2000, 5000, 10000];

function numberWithCommas(x){ return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
function logoPathFor(slug){ return `assets/logos/${slug}.png`; }

// fetch sites from backend
async function loadSites(){
  try {
    const r = await fetch(SITES_ENDPOINT, { method: "GET" });
    if(!r.ok) throw new Error("Failed to load: " + r.status);
    const body = await r.json();
    // backend returns { status: "success", sites: [...] }
    if(body && Array.isArray(body.sites)) {
      BETTING_SITES = body.sites;
    } else if (body && body.status === "success" && Array.isArray(body.sites)) {
      BETTING_SITES = body.sites;
    } else if(Array.isArray(body)) {
      BETTING_SITES = body;
    } else {
      console.warn("Unexpected sites shape, using fallback");
      BETTING_SITES = [
        {name:"iLotBet", slug:"ilotbet", color:"#00897b"},
        {name:"Bet9ja", slug:"bet9ja", color:"#1b9e5a"},
        {name:"SportyBet", slug:"sportybet", color:"#e53935"},
        {name:"BetKing", slug:"betking", color:"#1e3a8a"}
      ];
    }
  } catch (err) {
    console.warn("loadSites error:", err);
    // fallback minimal set
    BETTING_SITES = [
      {name:"iLotBet", slug:"ilotbet", color:"#00897b"},
      {name:"Bet9ja", slug:"bet9ja", color:"#1b9e5a"},
      {name:"SportyBet", slug:"sportybet", color:"#e53935"},
      {name:"BetKing", slug:"betking", color:"#1e3a8a"}
    ];
  }
  renderPanelSites(BETTING_SITES);
}

// render panel list
function renderPanelSites(list){
  panelSites.innerHTML = "";
  list.forEach(item=>{
    const li = document.createElement("li");
    li.className = "panel-site";

    const icon = document.createElement("div");
    icon.className = "site-icon";

    const img = new Image();
    img.src = logoPathFor(item.slug);
    img.onload = () => { icon.innerHTML = ""; icon.appendChild(img); };
    img.onerror = () => {
      icon.style.background = item.color || "#888";
      icon.innerHTML = `<div style="color:#fff;font-weight:800">${(item.name||"").slice(0,2).toUpperCase()}</div>`;
    };

    li.appendChild(icon);
    const body = document.createElement("div"); body.style.flex = "1";
    body.innerHTML = `<div>${item.name}</div><div class="muted">Betting</div>`;
    li.appendChild(body);
    const che = document.createElement("div"); che.className = "muted"; che.textContent = "›";
    li.appendChild(che);

    li.addEventListener("click", ()=> selectSite(item));
    panelSites.appendChild(li);
  });
}

// amounts UI
function renderMainAmounts(){
  amountGridMain.innerHTML = "";
  AMOUNT_OPTIONS.forEach(v=>{
    const btn = document.createElement("button");
    btn.className = "amount-tile-main" + (v === selectedTileValue ? " selected" : "");
    btn.type = "button";
    btn.innerHTML = `<div class="label">₦${numberWithCommas(v)}</div>`;
    btn.addEventListener("click", ()=>{
      selectedTileValue = v;
      customValue = null;
      if(customAmount) customAmount.value = "";
      updateMainSelection();
    });
    amountGridMain.appendChild(btn);
  });
  updateMainSelection();
}

function updateMainSelection(){
  document.querySelectorAll(".amount-tile-main").forEach(n=>n.classList.remove("selected"));
  if(selectedTileValue !== null){
    const node = Array.from(document.querySelectorAll(".amount-tile-main")).find(n => Number(n.querySelector(".label").textContent.replace(/\D/g,'')) === selectedTileValue);
    if(node) node.classList.add("selected");
  }

  const nominal = getNominalAmount();
  mainPayAmount.textContent = nominal > 0 ? `₦${numberWithCommas(nominal)}` : "₦0";

  if(selectedSite){
    selectedSiteLogo.classList.remove("hidden");
    selectedSiteName.classList.add("hidden");
    const path = logoPathFor(selectedSite.slug);
    const img = new Image();
    img.src = path;
    img.onload = () => { selectedSiteLogo.innerHTML = ""; selectedSiteLogo.appendChild(img); };
    img.onerror = () => { selectedSiteLogo.style.background = selectedSite.color || "#888"; selectedSiteLogo.innerHTML = `<div style="color:#fff;font-weight:800">${(selectedSite.name||"").slice(0,2).toUpperCase()}</div>`; };
  } else {
    selectedSiteLogo.classList.add("hidden");
    selectedSiteName.classList.remove("hidden");
    selectedSiteName.textContent = "Select site";
  }
}

function getNominalAmount(){
  if(customValue !== null && customValue !== "" && !isNaN(Number(customValue))) return Math.round(Number(customValue));
  if(selectedTileValue !== null) return selectedTileValue;
  return 0;
}

function openPanel(){ siteListPanel.classList.remove("hidden"); panelSearch.value=""; panelSearch.focus(); renderPanelSites(BETTING_SITES); }
function closePanel(){ siteListPanel.classList.add("hidden"); }
function filterPanelSites(q){ q=(q||"").trim().toLowerCase(); const filtered = BETTING_SITES.filter(s => (s.name||"").toLowerCase().includes(q)); renderPanelSites(filtered); }
function selectSite(item){ selectedSite = item; closePanel(); updateMainSelection(); verifyResult.textContent = ""; }

// verification
async function verifyAccount(){
  if(!selectedSite){ alert("Select site first"); return; }
  const account = mainUserId.value.trim();
  if(!account){ alert("Enter account / user ID"); return; }
  verifyResult.textContent = "Verifying...";
  try {
    const res = await fetch(VERIFY_ENDPOINT, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({service_id: selectedSite.slug, account})
    });
    const body = await res.json().catch(()=>null);
    if(res.ok && body){
      const name = body.customer_name || body.provider_response?.data?.customer_name || body.provider_response?.data?.name || body.provider_response?.customer?.name || null;
      verifyResult.textContent = name ? `Name: ${name}` : "Verified (name not provided)";
    } else {
      verifyResult.textContent = `Verify failed: ${ (body && body.message) || res.status }`;
    }
  } catch (err){
    verifyResult.textContent = "Network error verifying";
  }
}

// pay
async function payNow(){
  if(!selectedSite){ alert("Select site"); return; }
  const account = mainUserId.value.trim();
  if(!account){ alert("Enter account"); return; }

  const nominal = getNominalAmount();
  if(!nominal || nominal < 100){ alert("Minimum top-up is ₦100"); return; }

  if(!confirm(`Send ₦${numberWithCommas(nominal)} to ${selectedSite.name}?`)) return;

  // call backend /fund-betting
  try {
    const res = await fetch(FUND_ENDPOINT, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({service_id: selectedSite.slug, account, nominal_amount: nominal})
    });
    const body = await res.json().catch(()=>null);
    if(res.ok && body){
      alert("Payment successful. " + (body.provider_response?.message || "Transaction queued"));
      // clear
      mainUserId.value = "";
      customAmount.value = "";
      selectedTileValue = null;
      customValue = null;
      renderMainAmounts();
      updateMainSelection();
      verifyResult.textContent = "";
    } else {
      alert("Payment failed: " + ((body && body.message) || res.status));
    }
  } catch (err){
    alert("Network error during payment");
  }
}

// events
openListBtn.addEventListener("click", openPanel);
closeListBtn.addEventListener("click", closePanel);
panelSearch.addEventListener("input", (e)=> filterPanelSites(e.target.value));
customAmount.addEventListener("input", (e)=> {
  const v = e.target.value;
  if(v === "" || isNaN(Number(v))) customValue = null;
  else customValue = Math.round(Number(v));
  selectedTileValue = null;
  renderMainAmounts();
  updateMainSelection();
});
verifyBtn.addEventListener("click", verifyAccount);
mainPayBtn.addEventListener("click", payNow);

// init
window.addEventListener("load", async ()=>{
  await loadSites();
  renderMainAmounts();
  updateMainSelection();
});
</script>
</body>
</html>